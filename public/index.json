[{"categories":["ä»‹ç»"],"content":"I am Raja from XUPT-STA. ","date":"2022-11-20","objectID":"/abort/:0:0","tags":["abort"],"title":"Abort","uri":"/abort/"},{"categories":["friend"],"content":"æœ‰è¶£çš„åšä¸»ä»¬ Dillon LoveItä¸»é¢˜ä½œè€… ","date":"2022-11-20","objectID":"/friends/:0:0","tags":["friend"],"title":"ä¼ é€é—¨","uri":"/friends/"},{"categories":["go"],"content":"æ·±å…¥å­¦ä¹ goçš„ç›¸å…³çŸ¥è¯†","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"goæ·±å…¥å­¦ä¹  å‚è€ƒã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹ ã€ŠGoä¸“å®¶ç¼–ç¨‹ã€‹ çš„ç®€å•æ€»ç»“ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:0:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç¼–è¯‘è¿‡ç¨‹ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:1:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ¦‚å¿µ æŠ½è±¡è¯­æ³•æ ‘(AST) ä¸€ç§ç”¨æ¥è¡¨ç¤ºç¼–è¯‘è¯­è¨€çš„è¯­æ³•ç»“æ„çš„æ ‘å½¢ç»“æ„ï¼Œç”¨äºè¾…åŠ©ç¼–è¯‘å™¨è¿›è¡Œè¯­æ³•åˆ†æã€‚ é™æ€å•èµ‹å€¼(SSA) æ˜¯ä¸€ç§ä¸­é—´ä»£ç çš„ç‰¹æ€§ï¼Œå³æ¯ä¸ªå˜é‡åªèµ‹å€¼ä¸€æ¬¡ã€‚ æŒ‡ä»¤é›†æ¶æ„(CPUä¸­ç”¨æ¥è®¡ç®—å’Œæ§åˆ¶è®¡ç®—æœºç³»ç»Ÿçš„ä¸€å¥—æŒ‡ä»¤çš„é›†åˆ) åˆ†ä¸ºå¤æ‚æŒ‡ä»¤é›†ä½“ç³»ï¼ˆCISCï¼‰å’Œç²¾ç®€æŒ‡ä»¤é›†ä½“ç³»ï¼ˆRISCï¼‰ å¤æ‚æŒ‡ä»¤é›†ï¼š ç‰¹ç‚¹ï¼šæŒ‡ä»¤æ•°é‡å¤šé•¿åº¦ä¸ç­‰ï¼Œæœ‰é¢å¤–æŸå¤±æ€§èƒ½ã€‚ å¸¸ç”¨çš„æ˜¯AMD64(x86_64/x64) æŒ‡ä»¤é›† ç²¾ç®€æŒ‡ä»¤é›†ï¼š ç‰¹ç‚¹ï¼šæŒ‡ä»¤ç²¾ç®€é•¿åº¦ç›¸ç­‰ å¸¸ç”¨æœ‰ARM ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:1:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç¼–è¯‘å››é˜¶æ®µ è¯æ³•åˆ†æ+è¯­æ³•åˆ†æ è¯æ³•åˆ†æ(è¯æ³•åˆ†æå™¨)ä½œç”¨ï¼šå°†æºæ–‡ä»¶è½¬æ¢ä¸ºä¸€ä¸ªä¸åŒ…å«ç©ºæ ¼ï¼Œå›è½¦ï¼Œæ¢è¡Œç­‰çš„Tokenåºåˆ—ã€‚ é€šè¿‡cmd/compile/internal/syntax/scanner.goæ‰«ææ•°æ®æºæ–‡ä»¶æ¥åŒ¹é…å¯¹åº”çš„å­—ç¬¦ï¼Œè·³è¿‡ç©ºæ ¼å’Œæ¢è¡Œç­‰ç©ºç™½å­—ç¬¦ã€‚ è¯­æ³•åˆ†æ(è¯­æ³•åˆ†æå™¨)ä½œç”¨ï¼šå°†Tokenåºåˆ—è½¬ä¸ºå…·æœ‰æ„ä¹‰çš„ç»“æ„ä½“æ‰€ç»„æˆçš„æŠ½è±¡è¯­æ³•æ ‘ã€‚ ä½¿ç”¨LALR(1)æ–‡æ³•è§£æTokenï¼Œ ç±»å‹æ£€æŸ¥ æŒ‰é¡ºåºæ£€æŸ¥è¯­æ³•æ ‘ä¸­å®šä¹‰å’Œä½¿ç”¨çš„ç±»å‹ï¼Œç¡®ä¿ä¸å­˜åœ¨ç±»å‹åŒ¹é…é—®é¢˜ã€‚ï¼ˆåŒ…æ‹¬ç»“æ„ä½“å¯¹æ¥å£çš„å®ç°ç­‰ï¼‰ åŒæ—¶ä¹Ÿä¼šå±•å¼€å’Œæ”¹å†™ä¸€äº›å†…ç½®å‡½æ•°å¦‚make æ”¹å†™ä¸ºmakechan,makeslice,makemapç­‰ æ‹“å±•ï¼š å¼ºå¼±ç±»å‹ å¼ºç±»å‹ï¼šç±»å‹é”™è¯¯åœ¨ç¼–è¯‘æœŸé—´ä¼šè¢«æŒ‡å‡ºã€‚Go,Java å¼±ç±»å‹ï¼šåœ¨è¿è¡Œæ—¶å°†ç±»å‹é”™è¯¯è¿›è¡Œéšå¼è½¬æ¢ã€‚Js,PHP é™æ€ç±»å‹æ£€æŸ¥å’ŒåŠ¨æ€ç±»å‹æ£€æŸ¥ é™æ€ç±»å‹æ£€æŸ¥ï¼šå¯¹æºä»£ç çš„åˆ†ææ¥ç¡®å®šç¨‹åºç±»å‹å®‰å…¨çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‡å°‘è¿è¡Œæ—¶çš„ç±»å‹æ£€æŸ¥ã€‚ åŠ¨æ€ç±»å‹æ£€æŸ¥ï¼šç¼–è¯‘æ—¶ä¸ºæ‰€æœ‰å¯¹è±¡æ·»åŠ ç±»å‹æ ‡ç­¾ä¹‹ç±»çš„ä¿¡æ¯ã€‚è¿è¡Œæ—¶æ ¹æ®è¿™äº›ç±»å‹ä¿¡æ¯è¿›è¡ŒåŠ¨æ€æ´¾å‘ï¼Œå‘ä¸‹è½¬å‹ï¼Œåå°„ç­‰ç‰¹æ€§ã€‚ Go Javaç­‰éƒ½æ˜¯ä¸¤è€…ç›¸ç»“åˆã€‚æ¯”å¦‚æ¥å£åƒå…·ä½“ç±»å‹çš„è½¬æ¢ç­‰ã€‚ã€‚ã€‚ æ‰§è¡Œè¿‡ç¨‹ åˆ‡ç‰‡OTARRAY å…ˆå¯¹å…ƒç´ ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œå†æ ¹æ®æ“ä½œç±»å‹([]int,[...]int,[3]int)çš„ä¸åŒæ›´æ–°èŠ‚ç‚¹ç±»å‹ã€‚ å“ˆå¸Œè¡¨ OTMAP åˆ›å»ºTMAPç»“æ„ï¼Œå­˜å‚¨å“ˆå¸Œè¡¨çš„é”®å€¼ç±»å‹å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç±»å‹ä¸åŒ¹é…çš„é”™è¯¯ã€‚ å…³é”®å­— OMAKE æ ¹æ®makeçš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹è¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œç„¶åæ›´æ”¹å½“å‰èŠ‚ç‚¹çš„Opå±æ€§ åˆ‡ç‰‡: é•¿åº¦å‚æ•°å¿…é¡»è¢«ä¼ å…¥ï¼Œé•¿åº¦å¿…é¡»å°äºç­‰äºåˆ‡ç‰‡çš„å®¹é‡ã€‚ å“ˆå¸Œè¡¨: æ£€æŸ¥å“ˆå¸Œè¡¨çš„å¯é€‰åˆå§‹å®¹é‡å¤§å° Channel æ£€æŸ¥å¯é€‰Channelåˆè¯†ç¼“å†²å¤§å° ä¸­é—´ä»£ç ç”Ÿæˆ ç»è¿‡ç±»å‹æ£€æŸ¥åï¼Œç¼–è¯‘å™¨å¹¶å‘ç¼–è¯‘æ‰€æœ‰goé¡¹ç›®çš„å‡½æ•°ç”Ÿæˆä¸­é—´ä»£ç ï¼Œä¸­é—´ä¼šå¯¹ASTåšä¸€äº›æ›¿æ¢å·¥ä½œã€‚ goç¼–è¯‘å™¨ä¸­é—´ä»£ç ä½¿ç”¨SSAç‰¹æ€§ï¼Œä¼šå¯¹æ— ç”¨çš„å˜é‡å’Œç‰‡æ®µè¿›è¡Œä¼˜åŒ–ã€‚ ç»†èŠ‚ï¼š ç”Ÿæˆä¸­é—´ä»£ç å‰ç¼–è¯‘å™¨ä¼šæ›¿æ¢ä¸€äº›æŠ½è±¡è¯­æ³•æ ‘ä¸­çš„å…ƒç´ ã€‚åœ¨éå†è¯­æ³•æ ‘æ—¶ä¼šå°†ä¸€äº›å…³é”®å­—å’Œå†…ç½®å‡½æ•°è½¬åŒ–ä¸ºå‡½æ•°è°ƒç”¨ã€‚ æœºå™¨ç ç”Ÿæˆ Goè¯­è¨€å°†SSAä¸­é—´ä»£ç ç”Ÿæˆå¯¹åº”çš„ç›®æ ‡æœºå™¨ç ã€‚ GOOS=linux GOARCH=amd64 go build main.go å‚æ•°è¯´æ˜ï¼š 1. `GOOS`: ç›®æ ‡å¹³å° 1. mac å¯¹åº” darwin 2. linux å¯¹åº” linux 3. windows å¯¹åº” windows 2. `GOARCH` ï¼šç›®æ ‡å¹³å°çš„ä½“ç³»æ¶æ„ã€386,amd64,armã€‘, ç›®å‰å¸‚é¢ä¸Šçš„ä¸ªäººç”µè„‘ä¸€èˆ¬éƒ½æ˜¯amd64æ¶æ„çš„ 1. 386 ä¹Ÿç§° x86 å¯¹åº” 32ä½æ“ä½œç³»ç»Ÿ 2. amd64 ä¹Ÿç§° x64 å¯¹åº” 64ä½æ“ä½œç³»ç»Ÿ 3. arm è¿™ç§æ¶æ„ä¸€èˆ¬ç”¨äºåµŒå…¥å¼å¼€å‘ã€‚æ¯”å¦‚ Android ï¼Œ IOS ï¼Œ Win mobile , TIZEN ç­‰ goè¯­è¨€æ”¯æŒçš„æ¶æ„ï¼šAMD64,ARM,ARM64,MIPS,MIPS64,ppc64,s390x,x86,Wasm ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:1:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹ç³»ç»Ÿ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"åˆ†ç±» goè¯­è¨€æ•°æ®ç±»å‹åˆ†ä¸ºå‘½åç±»å‹å’Œæœªå‘½åç±»å‹ å‘½åç±»å‹ï¼šé¢„å£°æ˜çš„ç®€å•ç±»å‹å’Œè‡ªå®šä¹‰ç±»å‹ æœªå‘½åç±»å‹ï¼ˆç±»å‹å­—é¢é‡ï¼‰ï¼šarray,chan,slice,map,pointer,struct,interface,func æ³¨æ„ï¼šæœªå‘½åç±»å‹==ç±»å‹å­—é¢ä¸¤==å¤åˆç±»å‹ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"åº•å±‚ç±»å‹ é¢„å£°æ˜ç±»å‹å’Œç±»å‹å­—é¢é‡çš„åº•å±‚ç±»å‹æ˜¯è‡ªèº« è‡ªå®šä¹‰ç±»å‹çš„åº•å±‚ç±»å‹éœ€è¦é€å±‚å‘ä¸‹æŸ¥æ‰¾ type new old // new çš„åº•å±‚ç±»å‹å’Œoldçš„åº•å±‚ç±»å‹ç›¸åŒ ä»”ç»†ç ”ç©¶ Go(golang) ç±»å‹ç³»ç»Ÿ - çŸ¥ä¹ (zhihu.com) ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹ç›¸åŒ ä¸¤ä¸ªå‘½åç±»å‹ï¼šä¸¤ä¸ªç±»å‹å£°æ˜è¯­å¥ç›¸åŒ var a int var b int //a å’Œ bç±»å‹ç›¸åŒ var c A var d A //c å’Œ dç±»å‹ç›¸åŒ ä¸¤ä¸ªæœªå‘½åç±»å‹ï¼šå£°æ˜æ—¶çš„ç±»å‹å­—é¢é‡ç›¸åŒä¸”å†…éƒ¨å…ƒç´ ç±»å‹ç›¸åŒ åˆ«åï¼šæ°¸è¿œç›¸åŒ type myInt2 = int//èµ·åˆ«å--myInt1å’Œintå®Œå…¨ç›¸åŒ å‘½åç±»å‹å’Œæœªå‘½åç±»å‹ï¼šæ°¸è¿œä¸åŒ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹èµ‹å€¼ var a T1 //açš„ç±»å‹æ˜¯T1 var b T2 //bçš„ç±»å‹æ˜¯T2 b = a //å¦‚æœæˆåŠŸè¯´æ˜aå¯ä»¥ç›´æ¥èµ‹å€¼b å¯ä»¥èµ‹å€¼æ¡ä»¶ï¼š T1å’ŒT2ç±»å‹ç›¸åŒ T1å’ŒT2å…·æœ‰ç›¸åŒçš„åº•å±‚ç±»å‹ï¼Œä¸”å…¶ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯æœªå‘½åç±»å‹ type mySlice []int var list1 mySlice //mySlice å‘½åç±»å‹ var list2 []int //[]int æœªå‘½åç±»å‹ list1 = list2 //å¯ä»¥ç›´æ¥èµ‹å€¼ æ¥å£ç±»å‹çœ‹æ–¹æ³•é›†ï¼Œåªè¦å®ç°äº†å°±èƒ½èµ‹å€¼ã€‚ T1å’ŒT2çš„åº•å±‚ç±»å‹éƒ½æ˜¯chanç±»å‹ï¼Œä¸”T1å’ŒT2è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯æœªå‘½åç±»å‹ type T chan int // ç›¸åŒå…ƒç´ ç±»å‹ var t1 chan int // æœªå‘½åç±»å‹ var t2 T // å‘½åç±»å‹ t2 = t1 // æˆåŠŸèµ‹å€¼ nilå¯ä»¥èµ‹å€¼ç»™pointer,func,slice,map,chan,interface aæ˜¯å¯ä»¥è¡¨ç¤ºç±»å‹T1çš„å¸¸é‡å€¼ var a int32 a = 1 ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹å¼ºåˆ¶è½¬æ¢ Goæ˜¯å¼ºç±»å‹è¯­è¨€,å¦‚æœä¸æ»¡è¶³è‡ªåŠ¨ç±»å‹è½¬æ¢çš„æ¡ä»¶,åˆ™å¿…é¡»å¼ºåˆ¶ç±»å‹è½¬æ¢. è¯­æ³•ï¼švar a T = (T)(x) å°†xå¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºT éå¸¸é‡ç±»å‹çš„å˜é‡xå¯ä»¥å¼ºåˆ¶è½¬åŒ–å¹¶ä¼ é€’ç»™ç±»å‹T,éœ€è¦æ»¡è¶³å¦‚ä¸‹ä»»ä¸€æ¡ä»¶: å¯ä»¥ç›´æ¥èµ‹å€¼ ç›¸åŒåº•å±‚ç±»å‹. xçš„ç±»å‹å’ŒTéƒ½æ˜¯æœªå‘½åçš„æŒ‡é’ˆç±»å‹ï¼Œå¹¶ä¸”æŒ‡é’ˆæŒ‡å‘çš„ç±»å‹å…·æœ‰ç›¸åŒçš„åº•å±‚ç±»å‹ã€‚ type T1 int type T2 T1 var p1 *T2 // *T2 var p2 *int // *int p2 = (*int)(p1) // æŒ‡é’ˆæŒ‡å‘çš„åº•å±‚ç±»å‹éƒ½æ˜¯int xçš„ç±»å‹å’ŒTéƒ½æ˜¯æ•´å‹ï¼Œæˆ–è€…éƒ½æ˜¯æµ®ç‚¹å‹ã€‚ xçš„ç±»å‹å’ŒTéƒ½æ˜¯å¤æ•°ç±»å‹ã€‚ xæ˜¯æ•´æ•°å€¼æˆ–[]byteç±»å‹çš„å€¼ï¼ŒTæ˜¯stringç±»å‹ã€‚ s := string(123) fmt.Println([]byte(s)) // [123] xæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒTæ˜¯[]byteæˆ–[]runeã€‚ æµ®ç‚¹å‹,æ•´å‹ä¹‹é—´å¯ä»¥å¼ºåˆ¶ç±»å‹è½¬æ¢(å¯èƒ½ä¼šæŸå¤±æ•°æ®ç²¾åº¦) ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:5","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹æ–¹æ³• åªæœ‰å‘½åç±»å‹æ‰æœ‰æ–¹æ³•ï¼Œä¸”åªèƒ½ç»™å½“å‰åŒ…ä¸‹çš„ç±»å‹æ·»åŠ æ–¹æ³• è‡ªå®šä¹‰ç±»å‹ struct {//è¿™æ˜¯ä¸€ä¸ªæœªå‘½åç»“æ„ä½“ç±»å‹ name string age int } type Student struct{//Studentæ˜¯ä¸€ä¸ªå‘½åç»“æ„ä½“ç±»å‹ name string age int } interface{//æœªå‘½åæ¥å£ç±»å‹ eat() } type name interface {//nameæ˜¯ä¸€ä¸ªå‘½åæ¥å£ç±»å‹ eat() } æ–¹æ³• Goè¯­è¨€ç±»å‹æ–¹æ³•æ˜¯å¯¹ç±»å‹è¡Œä¸ºçš„å°è£…,GOè¯­è¨€çš„æ–¹æ³•å…¶å®æ˜¯ç‰¹æ®Šçš„å‡½æ•°,å…¶å°†æ–¹æ³•æ¥æ”¶è€…ä½œä¸ºå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•° //ç±»å‹æ¥æ”¶è€…æ˜¯å€¼ç±»å‹ func (t typeName)methodName(paramList)(ReturnList){ //method body } //ç±»å‹æ¥æ”¶è€…æ˜¯æŒ‡é’ˆç±»å‹ func (t *typeName)methodName(paramList)(ReturnList){ //method body } æ–¹æ³•è°ƒç”¨ ä¸€èˆ¬è°ƒç”¨:å®ä¾‹.æ–¹æ³•å(å‚æ•°) s := Student{name: \"å¼ ä¸‰\", age: 19}//Studentç±»å‹å¯¹è±¡çš„åˆ›å»ºå’Œåˆå§‹åŒ– s.eat()//è°ƒç”¨æ–¹æ³• ç±»å‹å­—é¢é‡è°ƒç”¨:ç±»å‹.æ–¹æ³•(å®ä¾‹,å‚æ•°) Student.eat(s)//å› ä¸ºæ–¹æ³•å…¶å®å°±æ˜¯ç‰¹æ®Šçš„å‡½æ•° //eat()æ–¹æ³•è½¬ä¸ºå‡½æ•° func eat(s Student){ fmt.Println(s.name, \"æ­£åœ¨åƒé¥­\") } æ–¹æ³•è°ƒç”¨æ—¶çš„ç±»å‹è½¬æ¢ ä¸€èˆ¬è°ƒç”¨ä¼šæ ¹æ®æ¥å—è€…ç±»å‹è‡ªåŠ¨è½¬æ¢ã€‚å€¼-\u003eæŒ‡é’ˆ,æŒ‡é’ˆ-\u003eå€¼ type T struct { a int } func (t T) VSet(n int) { t.a = n } func (t *T) PointSet(n int) { t.a = n } func method() { t1 := T{a: 0} t2 := T{a: 0} (\u0026t1).VSet(1) fmt.Println(t1.a) // 0 t2.PointSet(1) fmt.Println(t2.a) // 1 } ç±»å‹å­—é¢é‡è°ƒç”¨ä¸è‡ªåŠ¨è½¬æ¢ pointer := \u0026Data{\"å¼ ä¸‰\"} value := Data{\"å¼ ä¸‰\"} pointer := \u0026Data{\"å¼ ä¸‰\"} value := Data{\"å¼ ä¸‰\"} (*Data).testPointer(pointer, 3) // ç±»å‹å­—é¢é‡ æ˜¾å¼è°ƒç”¨ (*Data).testValue(pointer, 3) // æ­£å¸¸ Data.testValue(value, 3) // Data.testPointer(pointer, 3) // ç±»å‹æ£€æŸ¥é”™è¯¯ // Data.testPointer(value, 3) // ç±»å‹æ£€æŸ¥é”™è¯¯ // Data.testPointer(pointer, 3) // ç±»å‹æ£€æŸ¥é”™è¯¯ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:6","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç±»å‹æ–­è¨€ i.(TypeName) iå¿…é¡»æ˜¯æ¥å£å˜é‡ TypeNameå¯ä»¥æ˜¯å…·ä½“ç±»å‹åæˆ–è€…æ¥å£ç±»å‹å è‹¥TypeNameæ˜¯å…·ä½“ç±»å‹å:åˆ¤æ–­iæ‰€ç»‘å®šçš„å®ä¾‹ç±»å‹æ˜¯å¦å°±æ˜¯å…·ä½“ç±»å‹TypeName è‹¥TypeNameæ˜¯æ¥å£ç±»å‹å:åˆ¤æ–­iæ‰€ç»‘å®šçš„å®ä¾‹å¯¹è±¡æ˜¯å¦åŒæ—¶å®ç°äº†TypeNameæ¥å£ æ–¹å¼ä¸€: 1. o := i.(TypeName) //ä¸å®‰å…¨ï¼Œ ä¼španic() (1) TypeNameæ˜¯å…·ä½“ç±»å‹å,æ­¤æ—¶å¦‚æœæ¥å£iç»‘å®šçš„å®ä¾‹ç±»å‹å°±æ˜¯å…·ä½“ç±»å‹TypeName, åˆ™å˜é‡oçš„ç±»å‹å°±æ˜¯TypeName,å˜é‡oçš„å€¼å°±æ˜¯iæ¥å£ç»‘å®šçš„å®ä¾‹å€¼çš„å‰¯æœ¬(å½“ç„¶å®ä¾‹å¯èƒ½æ˜¯ æŒ‡é’ˆå€¼,é‚£å°±æ˜¯æŒ‡é’ˆå€¼çš„å‰¯æœ¬)ã€‚ (2) TypeNameæ˜¯æ¥å£ç±»å‹å,å¦‚æœæ¥å£iç»‘å®šçš„å®ä¾‹ç±»å‹æ»¡è¶³æ¥å£ç±»å‹TypeName,åˆ™å˜ é‡oçš„ç±»å‹å°±æ˜¯æ¥å£ç±»å‹TypeNameï¼Œoåº•å±‚ç»‘å®šçš„å…·ä½“ç±»å‹å®ä¾‹æ˜¯iç»‘å®šçš„å®ä¾‹çš„å‰¯æœ¬(å½“ç„¶ å®ä¾‹å¯èƒ½æ˜¯æŒ‡é’ˆå€¼ï¼Œé‚£å°±æ˜¯æŒ‡é’ˆå€¼çš„å‰¯æœ¬)ã€‚ (3)å¦‚æœä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ç¨‹åºæŠ›å‡ºpanicã€‚ 2. o, ok := i.(TypeName) //å®‰å…¨ oçš„ç±»å‹å’Œæ–¹æ³•ä¸€ä¸€è‡´,å”¯ä¸€ä¸åŒåœ¨äºæ–¹æ³•ä¸€å¦‚æœä¸åŒ¹é…å°±panic(),è€Œæ–¹æ³•äºŒå¯ä»¥é¿å… (3)å¦‚æœä¸Šè¿°ä¸¤ä¸ªéƒ½ä¸æ»¡è¶³ï¼Œåˆ™okä¸ºfalse(æ»¡è¶³ä¸€ä¸ªå°±æ˜¯true), å˜é‡oæ˜¯TypeNameç±»å‹çš„â€œé›¶å€¼â€ï¼Œæ­¤ç§æ¡ ä»¶åˆ†æ”¯ä¸‹ç¨‹åºé€»è¾‘ä¸åº”è¯¥å†å»å¼•ç”¨oï¼Œå› ä¸ºæ­¤æ—¶çš„oæ²¡æœ‰æ„ä¹‰ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:7","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ¥å£ç±»å‹æŸ¥è¯¢ iå¿…é¡»æ˜¯æ¥å£ç±»å‹ å¦‚æœcaseåé¢æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹åï¼Œä¸”æ¥å£å˜é‡iç»‘å®šçš„å®ä¾‹ç±»å‹å®ç°äº†è¯¥æ¥å£ç±»å‹çš„æ–¹æ³•,åˆ™åŒ¹é…æˆåŠŸï¼Œvçš„ç±»å‹æ˜¯æ¥å£ç±»å‹ï¼Œvåº•å±‚ç»‘å®šçš„å®ä¾‹æ˜¯iç»‘å®šå…·ä½“ç±»å‹å®ä¾‹çš„å‰¯æœ¬. switch v := i.(type){ case type1: ... case type2: ... ... } ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:2:8","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ•°æ®ç»“æ„ æ•°ç»„ åˆå§‹åŒ– [5]int{1,2,3} //æ˜¾å¼æŒ‡å®šå¤§å° [...]int{1,2,3}//éšå¼æ¨å¯¼ ä¸Šé™æ¨å¯¼ï¼šç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å°±ä¼šä¼šç¡®å®šå…ƒç´ ä¸ªæ•°æ¥ç¡®å®šç±»å‹ï¼Œæ‰€ä»¥ä¸¤è€…åœ¨è¿è¡Œæ—¶æ²¡æœ‰åŒºåˆ«ã€‚ è¯­å¥è½¬æ¢ï¼š ç”±å­—é¢é‡ç»„æˆçš„æ•°ç»„æ ¹æ®å…ƒç´ ä¸ªæ•°ç¼–è¯‘å™¨åœ¨ç±»å‹æ£€æŸ¥æœŸé—´ä¼šåšå‡ºä¸¤ç§ä¼˜åŒ–ï¼ˆä¸è€ƒè™‘é€ƒé€¸åˆ†æï¼‰ å…ƒç´ ä¸ªæ•°n\u003c=4:ç›´æ¥åœ¨æ ˆä¸Šèµ‹å€¼åˆå§‹åŒ– var arr [3]int arr[0] = 1 arr[1] = 2 arr[2] = 3 å…ƒç´ ä¸ªæ•°n\u003e4 :å…ˆåœ¨é™æ€å­˜å‚¨åŒºåˆå§‹åŒ–æ•°ç»„å…ƒç´ ï¼Œå¹¶å°†ä¸´æ—¶å˜é‡èµ‹å€¼ç»™æ•°ç»„ï¼ˆæ ˆï¼‰ã€‚ var arr [5]int statictmp_0[0] = 1 statictmp_0[1] = 2 statictmp_0[2] = 3 statictmp_0[3] = 4 statictmp_0[4] = 5 arr = statictmp_0 è®¿é—®å’Œèµ‹å€¼ ä½¿ç”¨å¸¸é‡æˆ–æ•´æ•°ç›´æ¥è®¿é—®æ•°ç»„ä¼šåœ¨ç±»å‹æ£€æŸ¥æœŸé—´è¿›è¡Œæ•°ç»„è¶Šç•Œåˆ†æï¼Œä½¿ç”¨å˜é‡ä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥ã€‚ åˆ‡ç‰‡ åŠ¨æ€æ•°ç»„ï¼Œé•¿åº¦ä¸å›ºå®šï¼Œå¯ä»¥è¿½åŠ å…ƒç´ ï¼Œå®ƒä¼šåœ¨å®¹é‡ä¸è¶³çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰©å®¹ã€‚ æ•°æ®ç»“æ„ type SliceHeader struct { Data uintptr //æŒ‡å‘åº•å±‚æ•°ç»„ Len int //åˆ‡ç‰‡é•¿åº¦ Cap int //åˆ‡ç‰‡å®¹é‡,Dataæ•°ç»„é•¿åº¦ } åˆå§‹åŒ– arr[0:3] or slice[0:3] //ä½¿ç”¨ä¸‹æ ‡ slice := []int{1, 2, 3} //å­—é¢é‡ slice := make([]int, 10) //å…³é”®å­— ä½¿ç”¨ä¸‹æ ‡ åˆ›å»ºä¸€ä¸ªæŒ‡å‘åº•å±‚æ•°ç»„çš„åˆ‡ç‰‡ç»“æ„ä½“ã€‚ä¿®æ”¹æ•°æ®ä¼šå½±å“åº•å±‚æ•°ç»„ã€‚ å­—é¢é‡ ç¼–è¯‘æ—¶ä¼šå±•å¼€ä¸ºä¸‹åˆ—å½¢å¼ var vstat [3]int //å…ˆåˆ›å»ºæ•°ç»„ vstat[0] = 1 vstat[1] = 2 vstat[2] = 3 var vauto *[3]int = new([3]int) *vauto = vstat slice := vauto[:] //æœ€åä½¿ç”¨ä¸‹æ ‡åˆ›å»ºåˆ‡ç‰‡ å…³é”®å­— åˆ‡ç‰‡å¾ˆå°ä¸”ä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œç›´æ¥é€šè¿‡ä¸‹æ ‡åœ¨æ ˆæˆ–é™æ€å­˜å‚¨åŒºåˆ›å»ºã€‚ // make([]int,3,4) var arr [4]int n := arr[:3] åˆ‡ç‰‡è¾ƒå¤§æˆ–é€ƒé€¸ åœ¨å †ä¸Šåˆå§‹åŒ–åˆ‡ç‰‡ new ç›¸å½“äºnil a := *new([]int) // var a []int è¿½åŠ å’Œæ‰©å®¹ appendä¼šåœ¨ç¼–è¯‘æ—¶æœŸè¢«å½“æˆä¸€ä¸ªTOKENç›´æ¥ç¼–è¯‘æˆæ±‡ç¼–ä»£ç ï¼Œå› æ­¤appendå¹¶ä¸æ˜¯åœ¨è¿è¡Œæ—¶è°ƒç”¨çš„ä¸€ä¸ªå‡½æ•° // expand append(l1, l2...) to // init { // s := l1 // n := len(s) + len(l2) // // Compare as uint so growslice can panic on overflow. // if uint(n) \u003e uint(cap(s)) { // s = growslice(s, n) // } // s = s[:n] // memmove(\u0026s[len(l1)], \u0026l2[0], len(l2)*sizeof(T)) // } // s // func growslice(et *_type, old slice, cap int) slice { newcap := old.cap doublecap := newcap + newcap if cap \u003e doublecap { newcap = cap } else { if old.cap \u003c 1024 { newcap = doublecap } else { // Check 0 \u003c newcap to detect overflow // and prevent an infinite loop. for 0 \u003c newcap \u0026\u0026 newcap \u003c cap { newcap += newcap / 4 } // Set newcap to the requested cap when // the newcap calculation overflowed. if newcap \u003c= 0 { newcap = cap } } } var overflow bool var lenmem, newlenmem, capmem uintptr // Specialize for common values of et.size. // For 1 we don't need any division/multiplication. // For sys.PtrSize, compiler will optimize division/multiplication into a shift by a constant. // For powers of 2, use a variable shift. switch { case et.size == 1: lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) \u003e maxAlloc newcap = int(capmem) case et.size == sys.PtrSize: lenmem = uintptr(old.len) * sys.PtrSize newlenmem = uintptr(cap) * sys.PtrSize capmem = roundupsize(uintptr(newcap) * sys.PtrSize) overflow = uintptr(newcap) \u003e maxAlloc/sys.PtrSize newcap = int(capmem / sys.PtrSize) case isPowerOfTwo(et.size): ... default: ... } æœŸæœ›é•¿åº¦ä¸è¶…è¿‡capç›´æ¥å‘åè¦†ç›– è¶…è¿‡åˆ™æ‰©å®¹ï¼šä¸ºåˆ‡ç‰‡é‡æ–°åˆ†é…æ–°çš„ç©ºé—´å¹¶å¤åˆ¶åŸæ•°ç»„å†…å®¹ã€‚ æœŸæœ›å®¹é‡newcap\u003e2*cap : ç›´æ¥ä½¿ç”¨æœŸæœ›å®¹é‡ å½“å‰åˆ‡ç‰‡é•¿åº¦\u003c1024 :ç›´æ¥åˆ†é…2*cap` å½“å‰åˆ‡ç‰‡é•¿åº¦\u003e=1024:æ¯æ¬¡å¢åŠ cap1.25å€`ç›´åˆ°å¤§äºä¸ºæ­¢ ç„¶åæ ¹æ®åˆ‡ç‰‡ä¸­çš„å…ƒç´ å¤§å°å¯¹é½å†…å­˜ã€‚å¦‚æœå…ƒç´ æ‰€å å­—èŠ‚å¤§å°ä¸º1,2æˆ–8çš„å€æ•°æ—¶ä¼šæ ¹æ®class_to_sizeæ•°ç»„å‘ä¸Šå–æ•´æ¥æé«˜å†…å­˜åˆ†é…æ•ˆç‡å‡å°‘ç¢ç‰‡ã€‚ var class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 24, 32, 48, 64, 80, 96, 112, 128, 144, 160, 176,...] ä¾‹: var arr []int64 //å…ƒç´ å 8å­—èŠ‚ arr = append(arr, 1, 2, 3, 4, 5) //æœŸæœ›capä¸º5 æœŸæœ›åˆ†é…5*8=40å­—èŠ‚ fmt.Println(len(arr), cap(arr)) // ç»è¿‡å¯¹é½åˆ†é…48å­—èŠ‚ï¼Œ capä¸º48/8=6 //5 6 æ‹“å±•è¡¨è¾¾å¼ arr2 := arr1[startğŸ”šmax] æŒ‡å®šarr2çš„å®¹é‡ä¸ºmax-start æ‰€ä»¥maxä¸èƒ½è¶…è¿‡cap(arr1) arr := make([]int, 0, 5)//len=0 cap=5 arr1 := arr[2:3] //len=1 cap=3 é»˜è®¤max=5 arr2 := arr[2:3:4] //len=1 cap=2 arr3 := arr[5:5:5] //len=0 cap=0 å“ˆå¸Œè¡¨ è®¾è®¡åŸç† å“ˆå¸Œå‡½æ•° è¾“å‡ºèŒƒå›´å¤§äºè¾“å…¥èŒƒå›´ä¸”ç»“æœéœ€è¾ƒä¸ºå‡åŒ€ å¤„ç†å“ˆå¸Œå†²çª å¼€æ”¾å¯»å€æ³• ä¾æ¬¡æ¢æµ‹å’Œæ¯”è¾ƒæ•°ç»„ä¸­çš„å…ƒç´ æ¥åˆ¤æ–­ç›®æ ‡æ˜¯å¦å­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­ï¼Œå†²çªäº†å°±ç»§ç»­å¾€åæ‰¾ä½ç½® $$ è£…è½½å› å­ = å…ƒç´ Ã·æ•°ç»„å¤§å° $$ å¦‚æœå¤§äº0.7åˆ™æ•ˆç‡ä½ä¸‹ æ‹‰é“¾æ³• æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ â€” æ›´æ–°é”®å¯¹åº”çš„å€¼ï¼› æ²¡æœ‰æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ â€” åœ¨é“¾è¡¨çš„æœ«å°¾è¿½åŠ æ–°çš„é”®å€¼å¯¹ï¼› $$ è£…è½½å› å­=å…ƒç´ æ•°é‡Ã·æ¡¶æ•°é‡ $$ åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨æ‹‰é“¾æ³•çš„å“ˆå¸Œè¡¨è£…è½½å› å­éƒ½ä¸ä¼šè¶…è¿‡ 1 æ•°æ®ç»“æ„ // mapæ•°æ®ç»“æ„ runtime/map.go/hmap type hmap struct { count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 // å¹¶å‘ B uint8 // bucketsæ¡¶ä¸ªæ•°ä¸º2^Bæ¬¡æ–¹ noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details hash0 uint32 // hash seed buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. bucketæ•°ç»„æŒ‡é’ˆ oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // op","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:3:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"è¯­è¨€ç‰¹è‰² ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:4:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å‡½æ•°è°ƒç”¨ C int func(int a1,int a2,...) int { return ...; } å‚æ•°\u003c=6ä¼šä½¿ç”¨å¯„å­˜å™¨ä¼ é€’ï¼Œ\u003e6çš„å‚æ•°ä¼šä»å³å¾€å·¦ä¾æ¬¡å…¥æ ˆã€‚é€šè¿‡eaxå¯„å­˜å™¨è¿”å›è¿”å›å€¼. Go Go è¯­è¨€å®Œå…¨ä½¿ç”¨æ ˆæ¥ä¼ é€’å‚æ•°å’Œè¿”å›å€¼å¹¶ç”±è°ƒç”¨è€…è´Ÿè´£æ¸…æ ˆï¼Œé€šè¿‡æ ˆä¼ é€’è¿”å›å€¼ä½¿å¾— Go å‡½æ•°èƒ½æ”¯æŒå¤šè¿”å›å€¼ï¼Œè°ƒç”¨è€…æ¸…æ ˆåˆ™å¯ä»¥å®ç°å¯å˜å‚æ•°çš„å‡½æ•°ã€‚Go ä½¿ç”¨å€¼ä¼ é€’çš„æ¨¡å¼ä¼ é€’å‚æ•°ï¼Œå› æ­¤ä¼ é€’æ•°ç»„å’Œç»“æ„ä½“æ—¶ï¼Œåº”è¯¥å°½é‡ä½¿ç”¨æŒ‡é’ˆä½œä¸ºå‚æ•°æ¥é¿å…å¤§é‡æ•°æ®æ‹·è´ä»è€Œæå‡æ€§èƒ½ã€‚ Go æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æ˜¯å°†æ¥æ”¶è€…ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº† calleeï¼Œæ¥æ”¶è€…åˆ†å€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…ã€‚ å½“ä¼ é€’åŒ¿åå‡½æ•°çš„æ—¶å€™ï¼Œä¼ é€’çš„å®é™…ä¸Šæ˜¯å‡½æ•°çš„å…¥å£æŒ‡é’ˆã€‚å½“ä½¿ç”¨é—­åŒ…çš„æ—¶å€™ï¼ŒGo é€šè¿‡é€ƒé€¸åˆ†ææœºåˆ¶å°†å˜é‡åˆ†é…åˆ°å †å†…å­˜ï¼Œå˜é‡åœ°å€å’Œå‡½æ•°å…¥å£åœ°å€ç»„æˆä¸€ä¸ªå­˜åœ¨å †ä¸Šçš„ç»“æ„ä½“ï¼Œä¼ é€’é—­åŒ…çš„æ—¶å€™ï¼Œä¼ é€’çš„å°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„åœ°å€ã€‚ Go çš„æ•°æ®ç±»å‹åˆ†ä¸ºå€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹ï¼Œä½† Go çš„å‚æ•°ä¼ é€’æ˜¯å€¼ä¼ é€’ã€‚å½“ä¼ é€’çš„æ˜¯å€¼ç±»å‹çš„æ—¶å€™ï¼Œæ˜¯å®Œå…¨çš„æ‹·è´ï¼Œcallee é‡Œå¯¹å‚æ•°çš„ä¿®æ”¹ä¸å½±å“åŸå€¼ï¼›å½“ä¼ é€’çš„æ˜¯å¼•ç”¨ç±»å‹çš„æ—¶å€™ï¼Œcallee é‡Œçš„ä¿®æ”¹ä¼šå½±å“åŸå€¼ã€‚ å¸¦è¿”å›å€¼çš„ return è¯­å¥å¯¹åº”çš„æ˜¯å¤šæ¡æœºå™¨æŒ‡ä»¤ï¼Œé¦–å…ˆæ˜¯å°†è¿”å›å€¼å†™å…¥åˆ° caller åœ¨æ ˆä¸Šä¸ºè¿”å›å€¼åˆ†é…çš„ç©ºé—´ï¼Œç„¶åæ‰§è¡Œ ret æŒ‡ä»¤ã€‚æœ‰ defer è¯­å¥çš„æ—¶å€™ï¼Œdefer è¯­å¥é‡Œçš„å‡½æ•°å°±æ˜¯æ’å…¥åˆ° ret æŒ‡ä»¤ä¹‹å‰æ‰§è¡Œã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:4:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"é—­åŒ… å½“å‡½æ•°å¼•ç”¨å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡æ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé—­åŒ…ã€‚åœ¨åº•å±‚å®ç°ä¸Šï¼Œé—­åŒ…ç”±å‡½æ•°åœ°å€å’Œå¼•ç”¨åˆ°çš„å˜é‡çš„åœ°å€ç»„æˆï¼Œå¹¶å­˜å‚¨åœ¨ä¸€ä¸ªç»“æ„ä½“é‡Œï¼Œåœ¨é—­åŒ…è¢«ä¼ é€’æ—¶ï¼Œå®é™…æ˜¯è¯¥ç»“æ„ä½“çš„åœ°å€è¢«ä¼ é€’ã€‚å› ä¸ºæ ˆå¸§ä¸Šçš„å€¼åœ¨è¯¥å¸§çš„å‡½æ•°é€€å‡ºåå°±å¤±æ•ˆäº†ï¼Œå› æ­¤é—­åŒ…å¼•ç”¨çš„å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ä¼šè¢«åˆ†é…åˆ°å †ä¸Šã€‚ defer defer è¯­å¥è°ƒç”¨çš„å‡½æ•°çš„å‚æ•°æ˜¯åœ¨ defer æ³¨å†Œæ—¶æ±‚å€¼æˆ–å¤åˆ¶çš„ã€‚å› æ­¤å±€éƒ¨å˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ç»™ defer çš„å‡½æ•°è¯­å¥åï¼Œåé¢å¯¹å±€éƒ¨å˜é‡çš„ä¿®æ”¹å°†ä¸å†å½±å“ defer å‡½æ•°å†…å¯¹è¯¥å˜é‡å€¼çš„ä½¿ç”¨ã€‚ä½†æ˜¯ defer å‡½æ•°é‡Œä½¿ç”¨éå‚æ•°ä¼ å…¥çš„å¤–éƒ¨å‡½æ•°çš„å˜é‡ï¼Œå°†ä½¿ç”¨åˆ°è¯¥å˜é‡åœ¨å¤–éƒ¨å‡½æ•°ç”Ÿå‘½å‘¨æœŸå†…æœ€ç»ˆçš„å€¼ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:4:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ¥å£ ä¸€ç»„æ–¹æ³•ç­¾åçš„é›†åˆã€‚å…¶å­˜åœ¨é™æ€ç±»å‹ï¼ˆç»‘å®šçš„å®ä¾‹çš„ç±»å‹ï¼‰å’Œé™æ€ç±»å‹ï¼ˆæ–¹æ³•ç­¾åï¼‰ã€‚æ³¨ï¼šç±»å‹æŒ‡é’ˆæ¥å—è€…å®ç°æ¥å£ï¼Œç±»å‹è‡ªèº«ä¸å¯è¿›è¡Œåˆå§‹åŒ–æ¥å£ã€‚ç±»å‹è‡ªèº«å®ç°æ¥å£ï¼Œç±»å‹è‡ªèº«å’Œç±»å‹æŒ‡é’ˆå‡å¯åˆå§‹åŒ–æ¥å£ï¼Œä¸”å› ä¸ºåœ¨è°ƒç”¨æ–¹æ³•æ—¶ä¼šå¯¹æ¥å—è€…è¿›è¡Œå¤åˆ¶ï¼Œæ‰€ä»¥æ¨èæŒ‡é’ˆæ¥å—è€…å®ç°æ¥å£ã€‚ æ•°æ®ç»“æ„ //src/runtime/runtime2.go //éç©ºæ¥å£ type iface struct { tab *itab //ç”¨æ¥å­˜æ”¾æ¥å£è‡ªèº«ç±»å‹å’Œç»‘å®šçš„å®ä¾‹ç±»å‹åŠå®ä¾‹ç›¸å…³çš„å‡½æ•°æŒ‡é’ˆ data unsafe.Pointer //æ•°æ® } // layout of Itab known to compilers // allocated in non-garbage-collected memory // Needs to be in sync with // ../cmd/compile/internal/gc/reflect.go:/^func.dumptabs. type itab struct { inter *interfacetype //æ¥å£è‡ªèº«é™æ€ç±»å‹ _type *_type // æ•°æ®ç±»å‹ hash uint32 // copy of _type.hash. Used for type switches. _ [4]byte fun [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter. } //ç©ºæ¥å£ type eface struct { _type *_type //æ•°æ®ç±»å‹ä¿¡æ¯ data unsafe.Pointer //æ•°æ® } // ç±»å‹ä¿¡æ¯ // Needs to be in sync with ../cmd/link/internal/ld/decodesym.go:/^func.commonsize, // ../cmd/compile/internal/gc/reflect.go:/^func.dcommontype and // ../reflect/type.go:/^type.rtype. // ../internal/reflectlite/type.go:/^type.rtype. type _type struct { size uintptr // ç±»å‹å ç”¨çš„å†…å­˜ç©ºé—´ ptrdata uintptr // size of memory prefix holding all pointers hash uint32 // ç”¨äºåˆ¤æ–­ç±»å‹æ˜¯å¦ç›¸ç­‰ tflag tflag align uint8 fieldAlign uint8 kind uint8 // function for comparing objects of this type // (ptr to object A, ptr to object B) -\u003e ==? equal func(unsafe.Pointer, unsafe.Pointer) bool // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte str nameOff ptrToThis typeOff } ç±»å‹è½¬æ¢ interface = *struct ç»“æ„ä½“åœ¨å †ä¸Šï¼Œæ¥å£ä¸­ä»…å­˜æ”¾æŒ‡é’ˆ interface = struct ç»“æ„ä½“åœ¨æ ˆä¸Šã€‚ åŠ¨æ€æ´¾å‘ è¿è¡Œæ—¶ï¼ˆå¦‚æœç¼–è¯‘ä¸èƒ½ç¡®å®šæ¥å£ç±»å‹ï¼‰é€‰æ‹©å…·ä½“æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ã€‚ ä»æ¥å£ä¸­è·å–ä¿å­˜çš„æ–¹æ³•æŒ‡é’ˆç„¶åå†è¿›è¡Œè°ƒç”¨ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:4:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"åå°„ åå°„æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡ŒæœŸå¯¹ç¨‹åºæœ¬èº«è¿›è¡Œè®¿é—®å’Œä¿®æ”¹çš„èƒ½åŠ› reflect.TypeOf //èƒ½è·å–ç±»å‹ä¿¡æ¯ï¼› reflect.ValueOf //èƒ½è·å–æ•°æ®çš„è¿è¡Œæ—¶è¡¨ç¤ºï¼› ä¸‰å¤§æ³•åˆ™ //ç¬¬ä¸€æ³•åˆ™:åå°„å¯ä»¥å°†æ¥å£ç±»å‹å˜é‡è½¬æ¢ä¸ºåå°„å¯¹è±¡ /* æœ‰äº†å˜é‡çš„ç±»å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Method æ–¹æ³•è·å¾—ç±»å‹å®ç°çš„æ–¹æ³•ï¼Œé€šè¿‡ Field è·å–ç±»å‹åŒ…å«çš„å…¨éƒ¨å­—æ®µã€‚ å¯¹äºä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ä¸åŒçš„æ–¹æ³•è·å–ç›¸å…³ä¿¡æ¯ï¼š ç»“æ„ä½“ï¼šè·å–å­—æ®µçš„æ•°é‡å¹¶é€šè¿‡ä¸‹æ ‡å’Œå­—æ®µåè·å–å­—æ®µ StructFieldï¼› å“ˆå¸Œè¡¨ï¼šè·å–å“ˆå¸Œè¡¨çš„ Key ç±»å‹ï¼› å‡½æ•°æˆ–æ–¹æ³•ï¼šè·å–å…¥å‚å’Œè¿”å›å€¼çš„ç±»å‹ï¼› â€¦ */ var x int64 = 4 fmt.Println(reflect.TypeOf(x), reflect.ValueOf(x)) //ç¬¬äºŒæ³•åˆ™:åå°„å¯ä»¥æŠŠåå°„å¯¹è±¡è¿˜åŸä¸ºæ¥å£å¯¹è±¡ /* ä¸è¿‡è°ƒç”¨ reflect.Value.Interface æ–¹æ³•åªèƒ½è·å¾— interface{} ç±»å‹çš„å˜é‡ï¼Œ å¦‚æœæƒ³è¦å°†å…¶è¿˜åŸæˆæœ€åŸå§‹çš„çŠ¶æ€è¿˜éœ€è¦ç»è¿‡å¦‚ä¸‹æ‰€ç¤ºçš„æ˜¾å¼ç±»å‹è½¬æ¢ï¼š v := reflect.ValueOf(1) v.Interface().(int) å½“ç„¶ä¸æ˜¯æ‰€æœ‰çš„å˜é‡éƒ½éœ€è¦ç±»å‹è½¬æ¢è¿™ä¸€è¿‡ç¨‹ã€‚ å¦‚æœå˜é‡æœ¬èº«å°±æ˜¯ interface{} ç±»å‹çš„ï¼Œé‚£ä¹ˆå®ƒä¸éœ€è¦ç±»å‹è½¬æ¢ï¼Œ å› ä¸ºç±»å‹è½¬æ¢è¿™ä¸€è¿‡ç¨‹ä¸€èˆ¬éƒ½æ˜¯éšå¼çš„ï¼Œæ‰€ä»¥æˆ‘ä¸å¤ªéœ€è¦å…³å¿ƒå®ƒï¼Œåªæœ‰åœ¨æˆ‘ä»¬éœ€è¦å°†åå°„å¯¹è±¡è½¬æ¢å›åŸºæœ¬ç±»å‹æ—¶æ‰éœ€è¦æ˜¾å¼çš„è½¬æ¢æ“ä½œã€‚ */ var a interface{} = 4.0 v := reflect.ValueOf(a) //åå°„å¯¹è±¡ b := v.Interface() //æ¥å£å¯¹è±¡ fmt.Println(a == b) fmt.Println(reflect.TypeOf(a), reflect.TypeOf(b)) //ç¬¬ä¸‰æ³•åˆ™:åå°„å¯¹è±¡å¯ä¿®æ”¹,valueå€¼å¿…é¡»æ˜¯å¯è®¾ç½®çš„ /* func main() { i := 1 v := reflect.ValueOf(i) v.SetInt(10) fmt.Println(i) } $ go run reflect.go panic: reflect: reflect.flag.mustBeAssignable using unaddressable value ç”±äº Go è¯­è¨€çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯ä¼ å€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„åå°„å¯¹è±¡è·Ÿæœ€å¼€å§‹çš„å˜é‡æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹åå°„å¯¹è±¡æ— æ³•æ”¹å˜åŸå§‹å˜é‡ï¼Œç¨‹åºä¸ºäº†é˜²æ­¢é”™è¯¯å°±ä¼šå´©æºƒã€‚ æƒ³è¦ä¿®æ”¹åŸå˜é‡åªèƒ½ä½¿ç”¨å¦‚ä¸‹çš„æ–¹æ³•ï¼š */ i := 1 v = reflect.ValueOf(\u0026i) v.Elem().SetInt(20) //å¿…é¡»æ˜¯é€šè¿‡ç›®æ ‡çš„æŒ‡é’ˆå¯¹å…¶ä¿®æ”¹ fmt.Println(i) å½“æˆ‘ä»¬æƒ³è¦å°†ä¸€ä¸ªå˜é‡è½¬æ¢æˆåå°„å¯¹è±¡æ—¶ï¼ŒGo è¯­è¨€ä¼šåœ¨ç¼–è¯‘æœŸé—´å®Œæˆç±»å‹è½¬æ¢ï¼Œå°†å˜é‡çš„ç±»å‹å’Œå€¼è½¬æ¢æˆäº† interface{} å¹¶ç­‰å¾…è¿è¡ŒæœŸé—´ä½¿ç”¨ reflect åŒ…è·å–æ¥å£ä¸­å­˜å‚¨çš„ä¿¡æ¯ã€‚ æ›´æ–°å˜é‡ /* å½“æˆ‘ä»¬æƒ³è¦æ›´æ–° reflect.Value æ—¶ï¼Œå°±éœ€è¦è°ƒç”¨ reflect.Value.Set æ›´æ–°åå°„å¯¹è±¡ï¼Œ è¯¥æ–¹æ³•ä¼šè°ƒç”¨ reflect.flag.mustBeAssignable å’Œ reflect.flag.mustBeExported åˆ†åˆ«æ£€æŸ¥å½“å‰åå°„å¯¹è±¡æ˜¯å¦æ˜¯å¯ä»¥è¢«è®¾ç½®çš„ä»¥åŠå­—æ®µæ˜¯å¦æ˜¯å¯¹å¤–å…¬å¼€çš„ï¼š func (v Value) Set(x Value) { v.mustBeAssignable() //æ˜¯å¦å¯ä»¥è¢«è®¾ç½® å³å¿…é¡»æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ x.mustBeExported() //æ˜¯å¦å¯¹å¤–å…¬å¼€ var target unsafe.Pointer if v.kind() == Interface { target = v.ptr } x = x.assignTo(\"reflect.Set\", v.typ, target) typedmemmove(v.typ, v.ptr, x.ptr) } */ fmt.Println(\"æ›´æ–°å˜é‡======\") x := 3 v := reflect.ValueOf(\u0026x) v.Elem().Set(reflect.ValueOf(4)) fmt.Println(\"æ›´æ–°ç»“æ„ä½“å¹¶è·å–æœªå¯¼å‡ºå­—æ®µå€¼\") test1 := \u0026test{test: 1} vtest := reflect.ValueOf(test1) vtest.Elem().Set(reflect.ValueOf(test{test: 2})) fmt.Println(vtest.Elem().FieldByName(\"test\").Int()) å‡½æ•°è°ƒç”¨ //å‡½æ•°è°ƒç”¨ /* 1.é€šè¿‡ reflect.ValueOf è·å–å‡½æ•° Add å¯¹åº”çš„åå°„å¯¹è±¡ï¼› 2.è°ƒç”¨ reflect.rtype.NumIn è·å–å‡½æ•°çš„å…¥å‚ä¸ªæ•°ï¼› 3.å¤šæ¬¡è°ƒç”¨ reflect.ValueOf å‡½æ•°é€ä¸€è®¾ç½® argv æ•°ç»„ä¸­çš„å„ä¸ªå‚æ•°ï¼› 4.è°ƒç”¨åå°„å¯¹è±¡ Add çš„ reflect.Value.Call æ–¹æ³•å¹¶ä¼ å…¥å‚æ•°åˆ—è¡¨ï¼› 5.è·å–è¿”å›å€¼æ•°ç»„ã€éªŒè¯æ•°ç»„çš„é•¿åº¦ä»¥åŠç±»å‹å¹¶æ‰“å°å…¶ä¸­çš„æ•°æ®ï¼› */ v := reflect.ValueOf(Add) //åå°„å¯¹è±¡ if v.Kind() != reflect.Func { return } t := v.Type() argv := make([]reflect.Value, t.NumIn()) //å…¥å‚ä¸ªæ•° for i := range argv { if t.In(i).Kind() != reflect.Int { return } argv[i] = reflect.ValueOf(i) //å¡«å……å‚æ•° } result := v.Call(argv) //è°ƒç”¨æ–¹æ³• if len(result) != 1 || result[0].Kind() != reflect.Int { return } fmt.Println(result[0].Int()) // #=\u003e 1 è·å–åŒ¿åå­—æ®µ func NiM(boy Boy) { t := reflect.TypeOf(boy) v := reflect.ValueOf(boy) fmt.Println(t, v) // Anonymousï¼šåŒ¿å for i := 0; i \u003c t.NumField(); i++ { fmt.Println(t.Field(i)) // å€¼ä¿¡æ¯ fmt.Println(v.Field(i)) } fmt.Println(t.FieldByName(\"private\")) } è®¾ç½®å­—æ®µå€¼ func SetValue(o interface{}) { v := reflect.ValueOf(o) newUser := User{ Id: 19, Name: \"raja\", Age: 19, } // è®¾ç½®å€¼ v.Elem().Set(reflect.ValueOf(newUser)) fmt.Println(v.Elem()) // è·å–æŒ‡é’ˆæŒ‡å‘çš„å…ƒç´  v = v.Elem() // å–å­—æ®µ f := v.FieldByName(\"Name\") if f.Kind() == reflect.String { f.SetString(\"Name\") } } è°ƒç”¨æ–¹æ³• func CallFunc(o interface{}) { v := reflect.ValueOf(o) // è·å–æ–¹æ³• å¯¼å‡º // fmt.Println(v.MethodByName(\"hello\")) m := v.MethodByName(\"Hello\") t := m.Type() // æ„å»ºå‚æ•° args := make([]reflect.Value, t.NumIn()) for i := 0; i \u003c len(args); i++ { if t.In(i).Kind() != reflect.String { fmt.Println(\"Kind Err!\") return } args[i] = reflect.ValueOf(strconv.Itoa(i)) } m.Call(args) } è·å–æ ‡ç­¾ func GetTag(o interface{}) { v := reflect.ValueOf(o) t := v.Type() f := t.Field(0) fmt.Println(f.Tag.Get(\"json\")) } ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:4:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å¸¸è§å…³é”®å­— ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"for range ä½¿ç”¨for rangeæœ€ç»ˆéƒ½ä¼šè½¬æ¢ä¸ºæ™®é€šçš„forå¾ªç¯ ç°è±¡ éå†æ•°ç»„æ—¶åŒæ—¶ä¿®æ”¹æ•°ç»„çš„å…ƒç´ ï¼ˆè¿½åŠ ï¼‰,ä¸ä¼šé€ æˆæ— é™å¾ªç¯ func testSliceRange() { nums := []int{1, 2, 3, 4} for i := range nums { nums = append(nums, 1) fmt.Println(nums[i]) } } for _,v := range nums çš„ væ˜¯åŒä¸€ä¸ªå˜é‡ éå†æ¸…ç©ºæ•°ç»„ï¼Œåˆ‡ç‰‡ï¼Œå“ˆå¸Œè¡¨è¿™äº›åœ°å€è¿ç»­çš„ç»“æ„æ—¶ä¼šç›´æ¥é€‰æ‹©æ¸…ç©ºè¿™ä¸€ç‰‡çš„å†…å®¹ ä½¿ç”¨for rangeéå†mapæ—¶è¢«å¼•å…¥éšæœºæ€§ï¼Œå¼ºè°ƒä¸è¦ä¾èµ–mapçš„éå†é¡ºåº å¾ªç¯ç»“æ„ // ç»å…¸å¾ªç¯ for Ninit ; Left ; Right { NBody } ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´æŠŠæ‰€æœ‰for rangeè½¬æ¢ä¸ºç»å…¸å¾ªç¯ã€‚ æ•°ç»„å’Œåˆ‡ç‰‡ éå†æ•°ç»„æˆ–è€…åˆ‡ç‰‡æ¸…ç©ºå…ƒç´  ç›´æ¥è°ƒç”¨runtime.memclrNoHeapPointersæ¸…ç©ºå…¨éƒ¨æ•°æ®å¹¶æ›´æ–°éå†æ•°ç»„çš„ç´¢å¼• for range a {} ç›´æ¥è½¬æ¢ä¸ºä¸‹åˆ—å½¢å¼ ha := a // å¤åˆ¶æ•°ç»„ hv1 := 0 hn := len(ha) // è·å–é•¿åº¦ v1 := hv1 for ; hv1 \u003c hn; hv1++ { ... } for i := range a {} åœ¨å¾ªç¯ä½“ä¸­æ·»åŠ äº† v1 = hv1 è¯­å¥ï¼Œä¼ é€’éå†æ•°ç»„æ—¶çš„ç´¢å¼• ha := a hv1 := 0 hn := len(ha) v1 := hv1 for ; hv1 \u003c hn; hv1++ { v1 = hv1 ... } for i,v := range a {} å¾ªç¯ä½¿ç”¨vå˜é‡ ha := a hv1 := 0 hn := len(ha) v1 := hv1 // ä¸‹æ ‡ v2 := nil // å€¼ for ; hv1 \u003c hn; hv1++ { tmp := ha[hv1] v1, v2 = hv1, tmp ... } å“ˆå¸Œè¡¨ ç¼–è¯‘å™¨ä¼šæ ¹æ® range è¿”å›å€¼çš„æ•°é‡åœ¨å¾ªç¯ä½“ä¸­æ’å…¥éœ€è¦çš„èµ‹å€¼è¯­å¥ï¼š ä¾‹å¦‚ k,væƒ…å†µ ha := a hit := hiter(n.Type) th := hit.Type mapiterinit(typename(t), ha, \u0026hit) for ; hit.key != nil; mapiternext(\u0026hit) { key := *hit.key val := *hit.val } éå†æ–¹å¼ï¼šéšæœºé€‰ä¸€ä¸ªèµ·å§‹æ¡¶ï¼Œéå†æ¡¶ä¸­å…ƒç´ ï¼Œå†éå†æº¢å‡ºæ¡¶ï¼Œå†éå†ä¸‹ä¸€ä¸ªæ¡¶ï¼Œç›´åˆ°å›åˆ°æœ€å¼€å§‹ã€‚ æ³¨æ„ï¼šå“ˆè¥¿è¡¨çš„éå†æ—¶æ’å…¥æ˜¯éšæœºçš„ï¼Œä¸ä¿è¯æ˜¯å¦ä¼šè¢«éå†åˆ°ã€‚ å­—ç¬¦ä¸² éå†æ—¶ä¼šè·å–å­—ç¬¦ä¸²çš„ç´¢å¼•å¯¹åº”å­—èŠ‚è½¬æ¢ä¸ºruneç±»å‹ï¼Œå¹¶æ›´æ–°ç´¢å¼•ã€‚ ha := s for hv1 := 0; hv1 \u003c len(ha); { hv1t := hv1 hv2 := rune(ha[hv1]) if hv2 \u003c utf8.RuneSelf { // ascii hv1++ } else { hv2, hv1 = decoderune(ha, hv1) // unicode } v1, v2 = hv1t, hv2 } channel for v := range ch {} ä¼šè¢«è½¬æ¢ä¸ºä¸‹åˆ—ï¼Œ(channelå…³é—­äº†ä¼šç»“æŸ,æ²¡æ•°æ®ä¼šé˜»å¡) ha := a hv1, hb := \u003c-ha for ; hb != false; hv1, hb = \u003c-ha { // ä¼šåˆ¤æ–­æ˜¯å¦close v1 := hv1 hv1 = nil ... } ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"select ç°è±¡ éé˜»å¡æ”¶å‘æ“ä½œ å¦‚æœå­˜åœ¨å¯æ”¶å‘çš„channelæ—¶ä¼šç›´æ¥å¤„ç†è¯¥channelå¯¹åº”çš„æ“ä½œ å¦‚æœä¸å­˜åœ¨ä¸Šè¿°æƒ…å†µï¼Œä¸”å­˜åœ¨default åˆ™æ‰§è¡Œdefaultè¯­å¥ å¤šä¸ªchannelåŒæ—¶å“åº”ä¼šéšæœºé€‰ä¸€ä¸ªæ‰§è¡Œ ä¸ºäº†é¿å…é¥¥é¥¿é—®é¢˜å‘ç”Ÿ å®ç°åŸç† select è¯­å¥åœ¨ç¼–è¯‘æœŸé—´ä¼šè¢«è½¬æ¢æˆ OSELECT èŠ‚ç‚¹ã€‚æ¯ä¸ª OSELECT èŠ‚ç‚¹éƒ½ä¼šæŒæœ‰ä¸€ç»„ OCASE èŠ‚ç‚¹ï¼Œå¦‚æœ OCASE çš„æ‰§è¡Œæ¡ä»¶æ˜¯ç©ºï¼Œé‚£å°±æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ª default èŠ‚ç‚¹ã€‚ ç¼–è¯‘å™¨ä¼šæ ¹æ®selectä¸­caseçš„ä¸åŒåšå‡ºä¸åŒä¼˜åŒ– selectä¸­æ²¡æœ‰case ç›´æ¥è°ƒç”¨runtime.block()é˜»å¡ selectä¸­åªæœ‰ä¸€ä¸ªcase è½¬æ¢ä¸ºifè¯­å¥ if ch == nil { // nil ç›´æ¥é˜»å¡ block() } v, ok := \u003c-ch // case ch \u003c- v select å­˜åœ¨ä¸¤ä¸ª caseï¼Œå…¶ä¸­ä¸€ä¸ª case æ˜¯ default éé˜»å¡æ¥å‘æ¶ˆæ¯ã€‚ select å­˜åœ¨å¤šä¸ª case é»˜è®¤æƒ…å†µä¸‹ï¼š å°†æ‰€æœ‰çš„ case è½¬æ¢æˆåŒ…å« Channel ä»¥åŠç±»å‹ç­‰ä¿¡æ¯çš„ runtime.scase ç»“æ„ä½“ type scase struct { c *hchan // chan elem unsafe.Pointer // data element } éšæœºç”Ÿæˆä¸€ä¸ªéå†çš„è½®è¯¢é¡ºåº pollOrder (é˜²æ­¢é¥¥é¥¿)å¹¶æ ¹æ® Channel åœ°å€æ’åºç”Ÿæˆé”å®šé¡ºåº lockOrder(é˜²æ­¢æ­»é”)ï¼› æ³¨æ„å¦‚æœå°è¯•å†™å…¥æ•°æ®åˆ°å·²ç»å…³é—­çš„channelåˆ™ä¼španic æ ¹æ®pollOrderéå†æ‰€æœ‰çš„caseæŸ¥çœ‹æ˜¯å¦æœ‰å¯ä»¥ç«‹åˆ»å¤„ç†çš„ Channelï¼› å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è·å– case å¯¹åº”çš„ç´¢å¼•å¹¶è¿”å›ï¼› å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º runtime.sudog ç»“æ„ä½“ï¼Œå°†å½“å‰ Goroutine åŠ å…¥åˆ°æ‰€æœ‰ç›¸å…³ Channel çš„æ”¶å‘é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨ runtime.gopark æŒ‚èµ·å½“å‰ Goroutine ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼› å½“è°ƒåº¦å™¨å”¤é†’å½“å‰ Goroutine æ—¶ï¼Œä¼šå†æ¬¡æŒ‰ç…§ lockOrder éå†æ‰€æœ‰çš„ caseï¼Œä»ä¸­æŸ¥æ‰¾éœ€è¦è¢«å¤„ç†çš„ runtime.sudog å¯¹åº”çš„caseç´¢å¼•ï¼Œä¹‹åä¼šå§å…¶ä»–sudogä»å‰©ä½™channelä¸­é‡Šæ”¾ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"defer ä½¿ç”¨ defer çš„æœ€å¸¸è§åœºæ™¯æ˜¯åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåå®Œæˆä¸€äº›æ”¶å°¾å·¥ä½œï¼Œä¾‹å¦‚åœ¨ defer ä¸­å›æ»šæ•°æ®åº“çš„äº‹åŠ¡ï¼š è§„åˆ™ å»¶è¿Ÿå‡½æ•°æ‰§è¡ŒæŒ‰åè¿›å…ˆå‡ºé¡ºåºæ‰§è¡Œï¼Œå³å…ˆå‡ºç°çš„deferæœ€åæ‰§è¡Œ å®šä¹‰deferç±»ä¼¼äºå…¥æ ˆæ“ä½œï¼Œæ‰§è¡Œdeferç±»ä¼¼äºå‡ºæ ˆæ“ä½œã€‚ å»¶è¿Ÿå‡½æ•°çš„å‚æ•°åœ¨deferè¯­å¥å‡ºç°æ—¶å°±å·²ç»ç¡®å®šä¸‹æ¥äº† func deferFuncParameter() { var aInt = 1 defer fmt.Println(aInt) aInt = 2 return } // output: 1 å»¶è¿Ÿå‡½æ•°å¯èƒ½æ“ä½œä¸»å‡½æ•°çš„å…·åè¿”å›å€¼ func deferFuncReturn() (ret int) { i := 1 defer func() { result++ }() return i } // output: 2 // ret = i ; defer ; return æ•°æ®ç»“æ„ type _defer struct { siz int32 // å‚æ•°å’Œç»“æœçš„å†…å­˜å¤§å° openDefer bool // è¡¨ç¤ºå½“å‰ defer æ˜¯å¦ç»è¿‡å¼€æ”¾ç¼–ç çš„ä¼˜åŒ–ï¼› sp uintptr // å‡½æ•°æ ˆæŒ‡é’ˆ pc uintptr // ç¨‹åºè®¡æ•°å™¨ fn *funcval // å‡½æ•°åœ°å€ _panic *_panic // æ˜¯è§¦å‘å»¶è¿Ÿè°ƒç”¨çš„ç»“æ„ä½“ï¼Œå¯èƒ½ä¸ºç©º link *_defer // æŒ‡å‘è‡ªèº«ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºé“¾æ¥å¤šä¸ªdefer } æ‰§è¡Œæœºåˆ¶ æ ¹æ®æ¡ä»¶ä¸åŒåˆ†ä¸ºå †ä¸­åˆ†é…ï¼Œæ ˆä¸­åˆ†é…ï¼Œå¼€æ”¾ç¼–ç  å †ä¸­åˆ†é… [å…œåº•æ–¹æ¡ˆ] 1.1 ~ 1.12 ç¼–è¯‘æœŸå°† defer å…³é”®å­—è½¬æ¢æˆ runtime.deferproc å¹¶åœ¨è°ƒç”¨ defer å…³é”®å­—çš„å‡½æ•°è¿”å›ä¹‹å‰æ’å…¥ runtime.deferreturnï¼› è¿è¡Œæ—¶è°ƒç”¨ runtime.deferproc ä¼šå°†ä¸€ä¸ªæ–°çš„ runtime._defer ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine çš„é“¾è¡¨å¤´ï¼› è¿è¡Œæ—¶è°ƒç”¨ runtime.deferreturn ä¼šä» Goroutine çš„é“¾è¡¨ä¸­å–å‡º runtime._defer ç»“æ„å¹¶ä¾æ¬¡æ‰§è¡Œï¼› æ ˆä¸­åˆ†é… [å‡½æ•°ä¸­å‡ºç°æœ€å¤šä¸€æ¬¡] 1.13 ç¼–è¯‘å™¨ä¼šå°† runtime._deferåˆ†é…åˆ°æ ˆä¸Š å¼€æ”¾ç¼–ç  [defer \u003c= 8ï¼Œreturn * defer \u003c=15] 1.14 ä½¿ç”¨ä»£ç å†…è”ä¼˜åŒ–deferå…³é”®å­—. å¯åŠ¨ä¼˜åŒ–(æ¡ä»¶åˆ¤æ–­) å»¶è¿Ÿè®°å½• ç¼–è¯‘æœŸé—´åœ¨æ ˆä¸Šåˆ›å»º8bitçš„å»¶è¿Ÿæ¯”ç‰¹æ•°ç»„ã€‚æ¯ä¸€ä½è¡¨ç¤ºå¯¹åº”çš„deferæ˜¯å¦éœ€è¦è¢«æ‰§è¡Œ æ‰§è¡Œ å¦‚æœdeferçš„æ‰§è¡Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šåˆ™ç›´æ¥æ’å…¥bitsä½åˆ¤æ–­å¹¶æ‰§è¡Œå‡½æ•°åˆ°è¿”å›å‰ã€‚å¦åˆ™åœ¨è¿è¡Œä¸­åˆ¤æ–­ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"panic å’Œ recover ç¼–è¯‘å™¨ä¼šè´Ÿè´£åšè½¬æ¢å…³é”®å­—çš„å·¥ä½œï¼› å°† panic å’Œ recover åˆ†åˆ«è½¬æ¢æˆ runtime.gopanic å’Œ runtime.gorecoverï¼› å°† defer è½¬æ¢æˆ runtime.deferproc å‡½æ•°ï¼› åœ¨è°ƒç”¨ defer çš„å‡½æ•°æœ«å°¾è°ƒç”¨ runtime.deferreturn å‡½æ•°ï¼› åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ° runtime.gopanic æ–¹æ³•æ—¶ï¼Œä¼šä» Goroutine çš„é“¾è¡¨ä¾æ¬¡å–å‡º runtime._defer ç»“æ„ä½“å¹¶æ‰§è¡Œï¼› å¦‚æœè°ƒç”¨å»¶è¿Ÿæ‰§è¡Œå‡½æ•°æ—¶é‡åˆ°äº†runtime.gorecoverå°±ä¼šå°†_panic.recoveredæ ‡è®°æˆ true å¹¶è¿”å›panicçš„å‚æ•°ï¼› åœ¨è¿™æ¬¡è°ƒç”¨ç»“æŸä¹‹åï¼Œruntime.gopanic ä¼šä» runtime._defer ç»“æ„ä½“ä¸­å–å‡ºç¨‹åºè®¡æ•°å™¨ pc å’Œæ ˆæŒ‡é’ˆ sp å¹¶è°ƒç”¨ runtime.recovery å‡½æ•°è¿›è¡Œæ¢å¤ç¨‹åºï¼› runtime.recovery ä¼šæ ¹æ®ä¼ å…¥çš„ pc å’Œ sp è·³è½¬å› runtime.deferprocï¼› ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¼šå‘ç° runtime.deferproc çš„è¿”å›å€¼ä¸ä¸º 0ï¼Œè¿™æ—¶ä¼šè·³å› runtime.deferreturn å¹¶æ¢å¤åˆ°æ­£å¸¸çš„æ‰§è¡Œæµç¨‹ï¼› å¦‚æœæ²¡æœ‰é‡åˆ° runtime.gorecover å°±ä¼šä¾æ¬¡éå†æ‰€æœ‰çš„ runtime._deferï¼Œå¹¶åœ¨æœ€åè°ƒç”¨ runtime.fatalpanic ä¸­æ­¢ç¨‹åºã€æ‰“å° panic çš„å‚æ•°å¹¶è¿”å›é”™è¯¯ç  2ï¼› ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"make å’Œ new make åˆå§‹åŒ–å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œchanï¼Œmapï¼Œchanã€‚ new åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ï¼Œåˆ†é…å¥½å†…å­˜åï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ç±»å‹å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚åŒæ—¶è¯·æ³¨æ„å®ƒåŒæ—¶æŠŠåˆ†é…çš„å†…å­˜ç½®ä¸ºé›¶ï¼Œä¹Ÿå°±æ˜¯ç±»å‹çš„é›¶å€¼ã€‚ éƒ½ä¼šå…ˆè¿›è¡Œé€ƒé€¸åˆ†æï¼Œç„¶åå†è¿›è¡Œå†…å­˜åˆ†é…ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:5:5","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å¹¶å‘ç¼–ç¨‹ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ä¹è§‚é”ï¼Œæ‚²è§‚é” å­˜åœ¨å…±äº«èµ„æºXéœ€è¦è¢«å¤šä¸ªçº¿ç¨‹ä¿®æ”¹ï¼Œåˆ†ä¸º3æ­¥ å–å€¼ï¼Œ2. ä¿®æ”¹ï¼Œ3. å†™å…¥ æ‚²è§‚é” æ¯æ¬¡æ“ä½œéƒ½å…ˆè·å–é”ï¼Œæ“ä½œå®Œå†é‡Šæ”¾é”ã€‚ ä¹è§‚é” å‰ä¸¤æ­¥æ­£å¸¸è¿›è¡Œï¼Œç¬¬ä¸‰æ­¥å®Œäº†å†åˆ¤æ–­ä¸‹æ˜¯å¦è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¿®æ”¹äº†å°±é‡æ–°èµ°ä¸€éæˆ–è€…æ”¾å¼ƒã€‚ atomicå¯ä»¥åœ¨ä¸å½¢æˆä¸´ç•ŒåŒºå’Œåˆ›å»ºäº’æ–¥é‡çš„æƒ…å†µä¸‹å®Œæˆå¹¶å‘å®‰å…¨çš„å€¼æ›¿æ¢æ“ä½œï¼Œè¿™ä¸ªåŒ…åº”ç”¨çš„ä¾¿æ˜¯ä¹è§‚é”çš„åŸç† CAS CASç”¨æ¥ç¡®ä¿åœ¨ä¹è§‚é”ä¸‹å¯¹æŸä¸€å…±äº«å˜é‡çš„æ“ä½œæ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ã€‚ CASï¼ˆVï¼ŒAï¼ŒBï¼‰ï¼šå†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼ (B)ï¼Œå¦‚æœå†…å­˜åœ°å€é‡Œé¢çš„å€¼å’Œ A çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å°†å†…å­˜é‡Œé¢çš„å€¼æ›´æ–°æˆ Bã€‚CAS æ˜¯é€šè¿‡æ— é™å¾ªç¯æ¥è·å–æ•°æ®çš„ï¼Œè‹¥æœåœ¨ç¬¬ä¸€è½®å¾ªç¯ä¸­ï¼Œa çº¿ç¨‹è·å–åœ°å€é‡Œé¢çš„å€¼è¢« b çº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆ a çº¿ç¨‹éœ€è¦è‡ªæ—‹ï¼Œåˆ°ä¸‹æ¬¡å¾ªç¯æ‰æœ‰å¯èƒ½æœºä¼šæ‰§è¡Œã€‚ while(!swapped) { swapped = CAS(V, E, N) sleep(1) } é—®é¢˜ï¼š è‡ªæ—‹é”ï¼šå¯èƒ½é€ æˆå¼€é”€å¤§ ABAï¼šéœ€è¦æ¯æ¬¡æ›´æ–°ç‰ˆæœ¬å·æ¥ç¡®ä¿ä¸­é€”å˜é‡æ²¡æœ‰è¢«ä¿®æ”¹ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ­»é” å‘ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼Œæ‰“ç ´ä»»æ„ä¸€ä¸ªå³å¯ã€‚ äº’æ–¥ï¼šè§£å†³ä¸´ç•ŒåŒºå®‰å…¨ï¼ˆä¸è€ƒè™‘ç ´åï¼‰ã€‚ å æœ‰ä¸”ç­‰å¾…ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²å æœ‰çš„èµ„æºä¸é‡Šæ”¾ã€‚ ä¸å¯æŠ¢å ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨ä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤º(æŠ¢å¤ºèµ„æº)ã€‚ å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…çš„èµ„æºå…³é—­(æ­»å¾ªç¯)ã€‚ è§£å†³æ–¹æ³•ï¼š å æœ‰ä¸”ç­‰å¾…ï¼šæ‰€æœ‰çš„è¿›ç¨‹åœ¨å¼€å§‹è¿è¡Œä¹‹å‰ï¼Œå¿…é¡»ä¸€æ¬¡æ€§çš„ç”³è¯·å…¶åœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹å„ç§æ‰€éœ€è¦çš„å…¨éƒ¨èµ„æºã€‚ ä¸å¯æŠ¢å ï¼šå½“æŒæœ‰ä¸€å®šèµ„æºçš„çº¿ç¨‹åœ¨æ— æ³•ç”³è¯·åˆ°æ–°çš„èµ„æºæ—¶å¿…é¡»é‡Šæ”¾å·²æœ‰çš„èµ„æºï¼Œå¾…ä»¥åéœ€è¦ä½¿ç”¨çš„æ—¶å€™å†é‡æ–°ç”³è¯· å¾ªç¯ç­‰å¾…ï¼šè§„å®šèµ„æºçš„ç”³è¯·é¡ºåº ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å¹¶å‘å“²å­¦ CSPé€šä¿¡é¡ºåºè¿›ç¨‹ï¼ˆåœ¨è¿›ç¨‹ä¹‹é—´æ­£ç¡®é€šä¿¡ï¼‰ä½œä¸ºGoçš„æ ¸å¿ƒæ€æƒ³ä¹‹ä¸€ï¼Œè®©å¹¶å‘ç¨‹åºæ›´å®¹æ˜“è¢«ç¼–å†™å’Œç†è§£ã€‚ é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜,è€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ mutexå’Œchannelçš„é€‰æ‹© å½“ç„¶å¦‚æœåªæ˜¯ä¸ºäº†ä¿æŠ¤æŸä¸ªå˜é‡çš„æ“ä½œçš„åŸå­æ€§ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨atomicè¿›è¡ŒåŸå­æ›´æ–°ï¼Œmutexå¸¸ç”¨äºç»´æŠ¤æŸä¸ªä»£ç ç‰‡æ®µã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"atomic // TSL // // old = *addr // *addr = new // return old func SwapInt32(addr *int32, new int32) (old int32) func SwapInt64(addr *int64, new int64) (old int64) func SwapUint32(addr *uint32, new uint32) (old uint32) func SwapUint64(addr *uint64, new uint64) (old uint64) func SwapUintptr(addr *uintptr, new uintptr) (old uintptr) func SwapPointer(addr *unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer) // FAA // // *addr += delta // return *addr func AddInt32(addr *int32, delta int32) (new int32) func AddUint32(addr *uint32, delta uint32) (new uint32) func AddInt64(addr *int64, delta int64) (new int64) func AddUint64(addr *uint64, delta uint64) (new uint64) func AddUintptr(addr *uintptr, delta uintptr) (new uintptr) // CAS // // if *addr == old { // *addr = new // return true // } // return false func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool) func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool) func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool) func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool) func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool) func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool) // Read func LoadInt32(addr *int32) (val int32) func LoadInt64(addr *int64) (val int64) func LoadUint32(addr *uint32) (val uint32) func LoadUint64(addr *uint64) (val uint64) func LoadUintptr(addr *uintptr) (val uintptr) func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer) // Write func StoreInt32(addr *int32, val int32) func StoreInt64(addr *int64, val int64) func StoreUint32(addr *uint32, val uint32) func StoreUint64(addr *uint64, val uint64) func StoreUintptr(addr *uintptr, val uintptr) func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer) // https://juejin.cn/post/6907091130039894023 atomic.Value // é›¶å€¼ä¸ºnil ä½¿ç”¨åä¸å…è®¸è¢«æ‹·è´ type Value struct { v interface{} // ifaceWords } type ifaceWords struct { // ç±»å‹ typ unsafe.Pointer // å€¼ data unsafe.Pointer } // ä¸èƒ½å­˜ nilï¼Œå­˜ä¸€æ¬¡åç±»å‹å°±å›ºå®šäº† func (v *Value) Store(val interface{}) { if val == nil { panic(\"sync/atomic: store of nil value into Value\") } vp := (*ifaceWords)(unsafe.Pointer(v)) vlp := (*ifaceWords)(unsafe.Pointer(\u0026val)) // æŠ¢å ä¹è§‚é” for { typ := LoadPointer(\u0026vp.typ) if typ == nil { // ç¦æ­¢å½“å‰ P è¢«æŠ¢å  runtime_procPin() // è°ƒç”¨CASæŠ¢å ä¹è§‚é”,æ²¡æŠ¢åˆ°å°±ç»§ç»­ if !CompareAndSwapPointer(\u0026vp.typ, nil, unsafe.Pointer(^uintptr(0))) { runtime_procUnpin() continue } // å­˜å‚¨å€¼å’Œç±»å‹ // Complete first store. StorePointer(\u0026vp.data, vlp.data) StorePointer(\u0026vp.typ, vlp.typ) runtime_procUnpin() return } // åˆ¤æ–­æ˜¯å¦è¿˜åœ¨æŠ¢å ä¹è§‚é” if uintptr(typ) == ^uintptr(0) { continue } // First store completed. Check type and overwrite data. if typ != vlp.typ { panic(\"sync/atomic: store of inconsistently typed value into Value\") } // åªéœ€è¦å­˜å€¼å°±ç³» StorePointer(\u0026vp.data, vlp.data) return } } func (v *Value) Load() (val interface{}) { vp := (*ifaceWords)(unsafe.Pointer(v)) typ := LoadPointer(\u0026vp.typ) if typ == nil || uintptr(typ) == ^uintptr(0) { // First store not yet completed. return nil } data := LoadPointer(\u0026vp.data) vlp := (*ifaceWords)(unsafe.Pointer(\u0026val)) vlp.typ = typ vlp.data = data return } è¿™é‡Œå°±æ˜¯å…ˆåˆ¤æ–­ä¹‹å‰æ˜¯å¦å·²ç»å­˜äº†ï¼Œå­˜äº†å°±ç›´æ¥åŸå­å­˜å€¼å°±è¡Œï¼Œå¦åˆ™éœ€è¦CASæŠ¢å ä¹è§‚é”å¹¶ä¸”ç¦æ­¢Pè¢«è°ƒåº¦ï¼Œç„¶åå­˜å€¼å’Œç±»å‹ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"context å»ºè®®ç›´æ¥çœ‹è¿™ä¸ªã€Šgoä¸“å®¶ç¼–ç¨‹ã€‹context å®ç° Context type Context interface { Deadline() (deadline time.Time, ok bool) // è¿”å› context.Context è¢«å–æ¶ˆçš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å®Œæˆå·¥ä½œçš„æˆªæ­¢æ—¥æœŸï¼› Done() \u003c-chan struct{} // è¿”å›ä¸€ä¸ªåªè¯»Channelï¼Œcontextå…³é—­åå…³é—­è¿™ä¸ªchannel Err() error // è¿”å› context.Context ç»“æŸçš„åŸå› ï¼Œå®ƒåªä¼šåœ¨ Done æ–¹æ³•å¯¹åº”çš„ Channel å…³é—­æ—¶è¿”å›éç©ºçš„å€¼ï¼› // å¦‚æœ context.Context è¢«å–æ¶ˆï¼Œä¼šè¿”å› Canceled é”™è¯¯ï¼› // å¦‚æœ context.Context è¶…æ—¶ï¼Œä¼šè¿”å› DeadlineExceeded é”™è¯¯ï¼› Value(key interface{}) interface{} // ç”¨äºçˆ¶å­ä¸Šä¸‹æ–‡ä¹‹é—´ä¼ é€’æ•°æ® } type emptyCtx int var ( background = new(emptyCtx) todo = new(emptyCtx) ) emptyCtxåªæ˜¯ä¸€ä¸ªå®ç°äº†Contextçš„ç»“æ„,å¯ä»¥ä½œä¸ºcontextçš„æ ¹èŠ‚ç‚¹ context åŒ…ä¸­å®ç° Context æ¥å£çš„ emptyCtxï¼Œé™¤äº† emptyCtx å¤–ï¼Œè¿˜æœ‰ cancelCtxã€timerCtx å’Œ valueCtx ä¸‰ç§ï¼Œæ­£æ˜¯åŸºäºè¿™ä¸‰ç§ context å®ä¾‹ï¼Œå®ç°äº†ä¸Šè¿° 4 ç§ç±»å‹çš„ contextã€‚ cancelCtx type cancelCtx struct { Context mu sync.Mutex // protects following fields done atomic.Value // of chan struct{}, created lazily, closed by first cancel call children map[canceler]struct{} // set to nil by the first cancel call err error // set to non-nil by the first cancel call } cancelCtxè¢«å–æ¶ˆåä¼šcancel()å®ƒçš„æ‰€æœ‰child Done() func (c *cancelCtx) Done() \u003c-chan struct{} { d := c.done.Load() if d != nil { return d.(chan struct{}) } c.mu.Lock() defer c.mu.Unlock() d = c.done.Load() if d == nil { d = make(chan struct{}) // æ‡’æ±‰æ¨¡å¼åˆ›å»º c.done.Store(d) } return d.(chan struct{}) } Err() func (c *cancelCtx) Err() error { c.mu.Lock() err := c.err c.mu.Unlock() return err } cancel () // cancel closes c.done, cancels each of c's children, and, if // removeFromParent is true, removes c from its parent's children. func (c *cancelCtx) cancel(removeFromParent bool, err error) { if err == nil { panic(\"context: internal error: missing cancel error\") } c.mu.Lock() if c.err != nil { c.mu.Unlock() return // already canceled } c.err = err d, _ := c.done.Load().(chan struct{}) if d == nil { c.done.Store(closedchan) // æ”¾å…¥å…³é—­çš„channel } else { close(d) // å…³é—­channel } // é€šçŸ¥ä¸‹æ¸¸ for child := range c.children { // NOTE: acquiring the child's lock while holding parent's lock. child.cancel(false, err) } // åˆ é™¤ä¸‹æ¸¸ c.children = nil c.mu.Unlock() // åˆ é™¤ä¸Šæ¸¸ if removeFromParent { removeChild(c.Context, c) } } å¦‚æœå¤šæ¬¡cancelç›´æ¥è¿”å›ï¼Œå¦åˆ™close channelï¼Œä¹‹åcancelå¹¶åˆ é™¤ä¸‹æ¸¸ï¼Œæœ€ååˆ¤æ–­æ˜¯å¦éœ€è¦å°†è‡ªå·±ä¸ä¸Šæ¸¸æ–­å¼€ WithCancel() func WithCancel(parent Context) (ctx Context, cancel CancelFunc) { if parent == nil { panic(\"cannot create context from nil parent\") } c := newCancelCtx(parent) // åˆå§‹åŒ–cancelå®ä¾‹ propagateCancel(parent, \u0026c) // å°† cancelCtx å®ä¾‹æ·»åŠ åˆ°å…¶çˆ¶èŠ‚ç‚¹çš„ children ä¸­ (å¦‚æœçˆ¶èŠ‚ç‚¹ä¹Ÿå¯ä»¥è¢« cancel çš„è¯) return \u0026c, func() { c.cancel(true, Canceled) } // è¿”å› cancelCtx å®ä¾‹å’Œ cancel () æ–¹æ³• } æ·»åŠ è¿™ä¸€æ­¥ï¼Œå¦‚æœçˆ¶èŠ‚ç‚¹æ”¯æŒcancelåˆ™æ·»åŠ è‡ªå·±åˆ°ä¸Šæ¸¸ å¦‚æœçˆ¶èŠ‚ç‚¹ä¸æ”¯æŒcancelåˆ™è®°å½•å¹¶å¯åŠ¨ä¸€ä¸ªæ–°goç¨‹æ¥ç›‘å¬çˆ¶èŠ‚ç‚¹Done()å¹¶cancelå½“å‰ctx timerCtx type timerCtx struct { cancelCtx timer *time.Timer // Under cancelCtx.mu. deadline time.Time } timerCtx åœ¨ cancelCtx åŸºç¡€ä¸Šå¢åŠ äº† deadline ç”¨äºæ ‡ç¤ºè‡ªåŠ¨ cancel çš„æœ€ç»ˆæ—¶é—´ï¼Œè€Œ timer å°±æ˜¯ä¸€ä¸ªè§¦å‘è‡ªåŠ¨ cancel çš„å®šæ—¶å™¨ã€‚ ç”±æ­¤ï¼Œè¡ç”Ÿå‡º WithDeadline () å’Œ WithTimeout ()ã€‚å®ç°ä¸Šè¿™ä¸¤ç§ç±»å‹å®ç°åŸç†ä¸€æ ·ï¼Œåªä¸è¿‡ä½¿ç”¨è¯­å¢ƒä¸ä¸€æ ·ï¼š deadline: æŒ‡å®šæœ€åæœŸé™ï¼Œæ¯”å¦‚ context å°† 2018.10.20 00:00:00 ä¹‹æ—¶è‡ªåŠ¨ç»“æŸ timeout: æŒ‡å®šæœ€é•¿å­˜æ´»æ—¶é—´ï¼Œæ¯”å¦‚ context å°†åœ¨ 30s åç»“æŸã€‚ å¯¹äºæ¥å£æ¥è¯´ï¼ŒtimerCtx åœ¨ cancelCtx åŸºç¡€ä¸Šè¿˜éœ€è¦å®ç° Deadline () å’Œ cancel () æ–¹æ³•ï¼Œå…¶ä¸­ cancel () æ–¹æ³•æ˜¯é‡å†™çš„ã€‚ cancel() func (c *timerCtx) cancel(removeFromParent bool, err error) { c.cancelCtx.cancel(false, err) if removeFromParent { // Remove this timerCtx from its parent cancelCtx's children. removeChild(c.cancelCtx.Context, c) } c.mu.Lock() if c.timer != nil { c.timer.Stop() c.timer = nil } c.mu.Unlock() } å’ŒcancelCtxå·®ä¸å¤šï¼Œä½†æ˜¯æœ€åéœ€è¦åœæ­¢timer WithTimeout func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) { return WithDeadline(parent, time.Now().Add(timeout)) } func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) { if parent == nil { panic(\"cannot create context from nil parent\") } if cur, ok := parent.Deadline(); ok \u0026\u0026 cur.Before(d) { // The current deadline is already sooner than the new one. return WithCancel(parent) } c := \u0026timerCtx{ cancelCtx: newCancelCtx(parent), deadline: d, } propagateCancel(parent, c) dur := time.Until(d) if dur \u003c= 0 { c.cancel(true, DeadlineExceeded) // deadline has already passed return c, func() { c.cancel(false, Canceled)","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:5","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"åŒæ­¥åŸè¯­å’Œé” äº’æ–¥é” æ•°æ®ç»“æ„ type Mutex struct { state int32 //äº’æ–¥é”çš„çŠ¶æ€ waiter(29)é˜»å¡åç¨‹æ•° starving(æ˜¯å¦é¥¥é¥¿) woken(æ˜¯å¦æœ‰åç¨‹è¢«å”¤é†’) locked(æ˜¯å¦è¢«é”å®š) sema uint32 //ä¿¡å·é‡ } åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œäº’æ–¥é”çš„æ‰€æœ‰çŠ¶æ€ä½éƒ½æ˜¯ 0ï¼Œint32 ä¸­çš„ä¸åŒä½åˆ†åˆ«è¡¨ç¤ºäº†ä¸åŒçš„çŠ¶æ€ï¼š mutexLocked â€” è¡¨ç¤ºäº’æ–¥é”çš„é”å®šçŠ¶æ€ï¼› mutexWoken â€” è¡¨ç¤ºä»æ­£å¸¸æ¨¡å¼è¢«ä»å”¤é†’ï¼› mutexStarving â€” å½“å‰çš„äº’æ–¥é”è¿›å…¥é¥¥é¥¿çŠ¶æ€ï¼› waitersCount â€” å½“å‰äº’æ–¥é”ä¸Šç­‰å¾…çš„ Goroutine ä¸ªæ•°ï¼› åŠ é” func (m *Mutex) Lock() { // Fast path: grab unlocked mutex. if atomic.CompareAndSwapInt32(\u0026m.state, 0, mutexLocked) { return } // Slow path (outlined so that the fast path can be inlined) m.lockSlow() } CASå°è¯•å°†locked=1åŠ é”æˆåŠŸ åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªæ—‹ å¯ä»¥è‡ªæ—‹å°±å°†wokenç½®ä¸º1,ç„¶åç©ºè½¬å°è¯•è·å–é” å¦åˆ™å°±ç›´æ¥é˜»å¡ç­‰å¾…è¢«å”¤é†’ è§£é” func (m *Mutex) Unlock() { // Fast path: drop lock bit. new := atomic.AddInt32(\u0026m.state, -mutexLocked) if new != 0 { // Outlined slow path to allow inlining the fast path. // To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. m.unlockSlow(new) } } é¥¥é¥¿æ¨¡å¼ä¸‹ä¼šç›´æ¥æŠŠé”ç»™ä¸‹ä¸€ä¸ªç­‰å¾…è€… æ™®é€šæ¨¡å¼ä¸‹å¦‚æœæ²¡æœ‰ç­‰å¾…çš„åç¨‹ï¼Œå°±é€‰æ‹©å”¤é†’ç­‰å¾…è€…ï¼ˆæœ‰çš„è¯ï¼‰æˆ–è€…ç›´æ¥è¿”å› è‡ªæ—‹ å¥½å¤„ æ›´å……åˆ†çš„åˆ©ç”¨CPUï¼Œå°½é‡é¿å…åç¨‹åˆ‡æ¢ è‡ªæ—‹æ¡ä»¶; å¤šCPU å½“å‰åç¨‹ä¸ºäº†è·å–æ­¤é”è¿›å…¥è‡ªæ—‹æ•°é‡\u003c4 å½“å‰æœºå™¨ä¸Šè‡³å°‘å­˜åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¤„ç†å™¨Pä¸”å…¶è¿è¡Œé˜Ÿåˆ—ä¸ºç©º æ€»ç»“ï¼šå½“CPUé—²ç€çš„æ—¶å€™å¯ä»¥è®©å®ƒå¿™ä¸€ä¸‹ã€‚ é¥¥é¥¿æ¨¡å¼ å½“è‡ªæ—‹çš„åç¨‹æ¯æ¬¡éƒ½æŠ¢åˆ°é”ï¼Œä¸ºäº†é˜²æ­¢æ­£å¸¸é˜»å¡çš„ç­‰å¾…é”çš„åç¨‹ä¸è¢«é¥¿æ­»ï¼Œå½“åç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡1msæ—¶å°±ä¼šå¯åŠ¨é¥¥é¥¿æ¨¡å¼ï¼Œå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œä¸ä¼šå¯åŠ¨è‡ªæ—‹è¿‡ç¨‹ï¼Œä¹Ÿå³ä¸€æ—¦æœ‰åç¨‹é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆä¸€å®šä¼šå”¤é†’åç¨‹ï¼Œè¢«å”¤é†’çš„åç¨‹å°†ä¼šæˆåŠŸè·å–é”ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠç­‰å¾…è®¡æ•°å‡1ã€‚ å¦‚æœå½“å‰åç¨‹æ˜¯æœ€åä¸€ä¸ªåç¨‹æˆ–è€…ç­‰å¾…æ—¶é—´å°äº1mså°±æ¢å¤ä¸ºæ™®é€šæ¨¡å¼ è¯»å†™é” æ•°æ®ç»“æ„ type RWMutex struct { w Mutex // held if there are pending writers writerSem uint32 // å†™é˜»å¡ç­‰å¾…çš„ä¿¡å·é‡ï¼Œæœ€åä¸€ä¸ªè¯»åç¨‹é‡Šæ”¾é”åä¼šé‡Šæ”¾ readerSem uint32 // è¯»é˜»å¡ç­‰å¾…çš„ä¿¡å·é‡ï¼ŒæŒæœ‰å†™é”çš„åç¨‹é‡Šæ”¾é”åä¼šé‡Šæ”¾ readerCount int32 // æ­£åœ¨è¯»åç¨‹çš„ä¸ªæ•° readerWait int32 // å†™é˜»å¡æ—¶è¯»åç¨‹çš„ä¸ªæ•° } const rwmutexMaxReaders = 1 \u003c\u003c 30 å†™é” func (rw *RWMutex) Lock() { // First, resolve competition with other writers. rw.w.Lock() // é€šè¿‡å°†readerCountå˜ä¸ºè´Ÿå€¼ï¼Œé˜»å¡åç»­è®¿é—®çš„reader r := atomic.AddInt32(\u0026rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders // è®°å½•å½“å‰readerçš„æ•°é‡ï¼Œç„¶åé˜»å¡ if r != 0 \u0026\u0026 atomic.AddInt32(\u0026rw.readerWait, r) != 0 { runtime_SemacquireMutex(\u0026rw.writerSem, false, 0) } } å…ˆå°†readerCountå˜ä¸ºè´Ÿå€¼é˜»æ­¢ä¹‹åçš„è¯»ç„¶åç­‰å¾…ç°æœ‰çš„è¯»ç»“æŸã€‚åŒæ—¶å°†å½“å‰çš„è¯»æ•°é‡è®°å½•åˆ°readerWait å†™è§£é” func (rw *RWMutex) Unlock() { // æ¢å¤æ­£å€¼ï¼Œé‡Šæ”¾åç»­çš„reader r := atomic.AddInt32(\u0026rw.readerCount, rwmutexMaxReaders) // å”¤é†’å·²ç»é˜»å¡çš„reader for i := 0; i \u003c int(r); i++ { runtime_Semrelease(\u0026rw.readerSem, false, 0) } // Allow other writers to proceed. rw.w.Unlock() } å…ˆå°†readerCountå˜æ­£ç„¶åå”¤é†’ä¹‹å‰çš„è¯»ï¼Œç„¶åè§£é” è¯»é” func (rw *RWMutex) RLock() { // å¢åŠ readeræ•°,å¦‚æœæ˜¯è´Ÿæ•°è¯´æ˜å‰é¢æœ‰writeï¼Œåˆ™é˜»å¡ if atomic.AddInt32(\u0026rw.readerCount, 1) \u003c 0 { // A writer is pending, wait for it. runtime_SemacquireMutex(\u0026rw.readerSem, false, 0) } } å°† readerCount+1åŒæ—¶åˆ¤æ–­å¦‚æœå°äº0è¯´æ˜åœ¨æ­¤ä¹‹å‰æœ‰å†™æ“ä½œå°±é˜»å¡ï¼Œå¦åˆ™å°±æ‰§è¡Œå†™ è¯»è§£é” func (rw *RWMutex) RUnlock() { // å‡å°‘readeræ•°ï¼Œå¹¶åˆ¤æ–­å¦‚æœæ˜¯æœ€åä¸€ä¸ªreaderåˆ™é‡Šæ”¾writer if r := atomic.AddInt32(\u0026rw.readerCount, -1); r \u003c 0 { // Outlined slow-path to allow the fast-path to be inlined rw.rUnlockSlow(r) } } å°† readerCount-1åŒæ—¶åˆ¤æ–­å¦‚æœå°äº0è¯´æ˜æœ‰å†™é”ï¼Œä¹‹åå°†readerWait-1åŒæ—¶åˆ¤æ–­å¦‚æœè‡ªå·±æ˜¯æœ€åä¸€ä¸ªé˜»å¡å†™çš„è¯»å°±å”¤é†’å†™ã€‚ ä½¿ç”¨channelå®ç° const RWMutexMaxReaders = 1 \u003c\u003c 30 //ä¸€ä¸ªæ— æ³•è¾¾åˆ°çš„æœ€å¤§è¯»æ•°é‡ type RWMutex struct { mu chan struct{} //äº’æ–¥é” readerCount int32 // è¯»æ•°é‡ readerWait int32 // å†™ç­‰å¾…çš„è¯»çš„æ•°é‡ wchan chan struct{} //ç”¨äºå”¤é†’ç­‰å¾…è¯»çš„å†™ rchan chan struct{} //ç”¨äºå”¤é†’ç­‰å¾…å†™çš„è¯» } func NewRWMutex() *RWMutex { return \u0026RWMutex{mu: make(chan struct{}, 1), wchan: make(chan struct{}), rchan: make(chan struct{})} } func (rw *RWMutex) Lock() { rw.mu \u003c- struct{}{} //è·å–é” //é˜»æ­¢ä¹‹åçš„è¯»æ“ä½œï¼Œç­‰å¾…ç°æœ‰çš„è¯»æ“ä½œ if r := atomic.AddInt32(\u0026rw.readerCount, -RWMutexMaxReaders) + RWMutexMaxReaders; r \u003e 0 { atomic.AddInt32(\u0026rw.readerWait, r) //å¢åŠ å†™é˜»å¡æ—¶è¯»æ•°é‡ \u003c-rw.wchan } } func (rw *RWMutex) Unlock() { //å”¤é†’ç­‰å¾…çš„è¯» if r := atomic.AddInt32(\u0026rw.readerCount, RWMutexMaxReaders); r \u003e 0 { for i := 0; i \u003c int(r); i++ { rw.rchan \u003c- struct{}{} } } //è§£é” \u003c-rw.mu } func (rw *RWMutex) RLock() { //å¢åŠ è¯»æ•°é‡ï¼Œå¦‚æœæœ‰å†™å°±ç­‰å¾…å†™ if r := atomic.AddInt32(\u0026rw.readerCount, 1); r \u003c 0 { \u003c-rw.rchan } } func (rw *RWMutex) RUnlock() { //å‡å°‘è¯»æ•°é‡ï¼Œæœ‰å†™ç­‰å¾…å°±è¿›ä¸€æ­¥åˆ¤æ–­å¦‚æœè‡ªå·±æ˜¯æœ€åä¸€ä¸ªè¯»å°±å”¤é†’å†™ if r := atomic.AddInt32(\u0026rw.readerCount, -1); r \u003c 0 { if rwait := atomic.AddInt32(\u0026rw.readerWait, -1); rwait == 0 { rw.wchan \u003c- struct{}{} } } } func main() { rw := NewRWMutex() num := 0 wg := new(sync.WaitGroup) wg.Add(100) for i := 0; i \u003c 100; i++ { go func(i int) { defer wg.Done() switch i % 2 { case 0: rw.Lock() defer rw.Unlock() num++ case 1: time.Sleep(time.Duration(rand.Intn(2)) * time.Millisecond) rw.RLock() d","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:6","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"è®¡æ—¶å™¨ é‡‡ç”¨å››å‰å † ä¸Šæ¨èŠ‚ç‚¹çš„æ“ä½œæ›´å¿«ã€‚å‡å¦‚æœ€ä¸‹å±‚æŸä¸ªèŠ‚ç‚¹çš„å€¼è¢«ä¿®æ”¹ä¸ºæœ€å°ï¼ŒåŒæ ·ä¸Šæ¨åˆ°å †é¡¶çš„æ“ä½œï¼ŒN å‰å †éœ€è¦çš„æ¯”è¾ƒæ¬¡æ•°åªæœ‰äºŒå‰å †çš„logv2å€ã€‚ å¯¹ç¼“å­˜æ›´å‹å¥½ã€‚äºŒå‰å †å¯¹æ•°ç»„çš„è®¿é—®èŒƒå›´æ›´å¤§ï¼Œæ›´åŠ éšæœºï¼Œè€ŒNå‰å †åˆ™æ›´é›†ä¸­äºæ•°ç»„çš„ ä¸Šéƒ¨ï¼Œè¿™å°±å¯¹ç¼“å­˜æ›´åŠ å‹å¥½ï¼Œæœ‰åˆ©äºæé«˜æ€§èƒ½ã€‚ Go1.10ä¹‹å‰ç”±å…¨å±€å”¯ä¸€å››å‰å †ç»´æŠ¤ æ‰€æœ‰goç¨‹å¯¹è®¡æ—¶å™¨æ“ä½œéƒ½ä¼šäº‰å¤ºäº’æ–¥é”ï¼Œæ€§èƒ½æ¶ˆè€—å¤§ Go1.10ä¹‹åå°†å…¨å±€å››å‰å †åˆ†ä¸º64ä¸ªå°çš„å››å‰å † ç†æƒ³æƒ…å†µä¸‹ï¼Œå †æ•°å’Œå¤„ç†å™¨æ•°é‡ç›¸åŒï¼Œä½†æ˜¯å¦‚æœå¤„ç†å™¨æ•°é‡è¶…è¿‡64,åˆ™å¯èƒ½å¤šä¸ªå¤„ç†å™¨ä¸Šçš„è®¡æ—¶å™¨å°±åœ¨ä¸€ä¸ªæ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶ç”±ä¸€ä¸ªgoç¨‹å»å¤„ç†ã€‚ä½†æ˜¯è¿™ä¸ªgoç¨‹é€ æˆå¤„ç†å™¨å’Œçº¿ç¨‹ä¹‹é—´é¢‘ç¹åˆ‡æ¢å¼•èµ·æ€§èƒ½é—®é¢˜ Go1.13ä¹‹åé‡‡ç”¨ç½‘ç»œè½®è®­å™¨æ–¹å¼ æ‰€æœ‰è®¡æ—¶å™¨éƒ½é‡‡ç”¨æœ€å°å››å‰å †çš„å½¢å¼å­˜æ”¾åœ¨å¤„ç†å™¨Pä¸­ï¼Œè®¡æ—¶å™¨éƒ½äº¤ç»™å¤„ç†å™¨çš„ç½‘ç»œè½®è®­=å™¨å’Œè°ƒåº¦å™¨æ¥è§¦å‘ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:7","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"chan è®¾è®¡åŸåˆ™ ä¸åŒgoç¨‹é€šè¿‡channelæ¥å…±äº«æ•°æ®ã€‚ ä½¿ç”¨é€šä¿¡æ¥å…±äº«å†…å­˜ ä½¿ç”¨ç‰¹æ€§ å…ˆè¿›å…ˆå‡ºï¼Œé˜Ÿåˆ—ç‰¹æ€§ è¯»å–æˆ–å†™å…¥ è¯»å–ï¼š nilï¼šé˜»å¡ openéç©ºï¼šå€¼ openç©ºï¼šé˜»å¡ closeï¼šé»˜è®¤å€¼ï¼Œfalse åªå†™ï¼šç¼–è¯‘é”™è¯¯ å†™å…¥ï¼š nilï¼šé˜»å¡ æ»¡ï¼šé˜»å¡ æœªæ»¡ï¼šå†™å…¥å€¼ å…³é—­ï¼španic åªè¯»ï¼šç¼–è¯‘é”™è¯¯ close nilï¼španic openæœªç©ºï¼šå…³é—­chanï¼Œç›´åˆ°é€šé“è€—å°½ï¼Œç„¶åè¯»å–é»˜è®¤å€¼ openç©ºï¼šå…³é—­chanï¼Œè¯»å–é»˜è®¤å€¼ closeï¼španic åªè¯»ï¼šç¼–è¯‘é”™è¯¯ ç»“æ„ type hchan struct { qcount uint // å½“å‰é˜Ÿåˆ—ä¸­å‰©ä½™å…ƒç´  dataqsiz uint // ç¯å½¢é˜Ÿåˆ—é•¿åº¦ï¼ˆcapï¼‰ buf unsafe.Pointer // å”¤é†’é˜Ÿåˆ—æŒ‡é’ˆ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 // æ ‡è¯†å…³é—­ elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // é˜Ÿåˆ—ä¸‹æ ‡ï¼ˆä¸‹ä¸€ä¸ªå†™å…¥å­˜æ”¾çš„ä½ç½®ï¼‰ recvx uint // é˜Ÿåˆ—ä¸‹æ ‡ï¼ˆä¸‹ä¸€ä¸ªè¯»å–çš„ä½ç½®ï¼‰ recvq waitq // ç­‰å¾…è¯»çš„åç¨‹é˜Ÿåˆ— sendq waitq // ç­‰å¾…å†™çš„åç¨‹é˜Ÿåˆ— lock mutex // ä¸å…è®¸äº’æ–¥è¯»å†™ } // åŒå‘é“¾è¡¨ type waitq struct { first *sudog last *sudog } åˆ›å»º make(chan)ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«è½¬æ¢ä¸ºmakechanå‡½æ•° func makechan(t *chantype, size int) *hchan { elem := t.elem mem, _ := math.MulUintptr(elem.size, uintptr(size)) var c *hchan switch { case mem == 0: // æ— ç¼“å†²ï¼šåˆ†é…ä¸€æ®µå†…å­˜ç©ºé—´ c = (*hchan)(mallocgc(hchanSize, nil, true)) c.buf = c.raceaddr() case elem.kind\u0026kindNoPointers != 0:// å­˜çš„å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆï¼Œä¼šä¸ºå½“å‰channelå’Œåº•å±‚æ•°ç»„åˆ†é…ä¸€å—è¿ç»­å†…å­˜ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) c.buf = add(unsafe.Pointer(c), hchanSize) default:// é»˜è®¤å•ç‹¬ä¸ºruntime.hchanå’Œç¼“å†²åŒºåˆ†é…å†…å­˜ c = new(hchan) c.buf = mallocgc(mem, elem, true) } c.elemsize = uint16(elem.size) c.elemtype = elem c.dataqsiz = uint(size) return c } å‘é€æ•°æ® chan \u003c- iä¼šè¢«è½¬æ¢ä¸ºchansendå‡½æ•°ï¼Œå‚æ•°blockè¡¨ç¤ºæ˜¯å¦é˜»å¡å‘é€ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { lock(\u0026c.lock) // if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"send on closed channel\")) } å­˜åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼šç›´æ¥å‘é€ // å–å‡ºæœ€å…ˆç­‰å¾…çš„è¯»goç¨‹ï¼Œç„¶åç»™å®ƒå‘æ•°æ® if sg := c.recvq.dequeue(); sg != nil { send(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true } å‘é€æ•°æ®æ—¶ä¼šè°ƒç”¨ runtime.sendï¼Œè¯¥å‡½æ•°çš„æ‰§è¡Œå¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ† è°ƒç”¨ runtime.sendDirect å°†å‘é€çš„æ•°æ®ç›´æ¥æ‹·è´åˆ° x = \u003c-c è¡¨è¾¾å¼ä¸­å˜é‡ x æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸Šï¼› è°ƒç”¨ runtime.goready å°†ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutine æ ‡è®°æˆå¯è¿è¡ŒçŠ¶æ€ Grunnable å¹¶æŠŠè¯¥ Goroutine æ”¾åˆ°å‘é€æ–¹æ‰€åœ¨çš„å¤„ç†å™¨çš„ runnext ä¸Šç­‰å¾…æ‰§è¡Œï¼Œè¯¥å¤„ç†å™¨åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶ä¼šç«‹åˆ»å”¤é†’æ•°æ®çš„æ¥æ”¶æ–¹ func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if sg.elem != nil { sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) goready(gp, skip+1) // ä¸‹ä¸€æ¬¡è°ƒåº¦æ¥å”¤é†’æ¥æ”¶æ–¹ } å­˜åœ¨å¯ç”¨ç¼“å†²ï¼šå†™å…¥ç¼“å†²åŒº åˆ›å»ºçš„channelæœ‰ç¼“å†²åŒºä¸”æ²¡æœ‰æ»¡ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { ... if c.qcount \u003c c.dataqsiz { qp := chanbuf(c, c.sendx) // è®¡ç®—å‡ºä¸‹ä¸€ä¸ªå¯ä»¥å­˜æ”¾æ•°æ®çš„ä½ç½® typedmemmove(c.elemtype, qp, ep) // æ‹·è´æ•°æ®åˆ°ç›®æ ‡ä½ç½® c.sendx++ // ä¸‹æ ‡å¢åŠ  if c.sendx == c.dataqsiz { // å¾ªç¯ c.sendx = 0 } c.qcount++ // è®¡æ•° unlock(\u0026c.lock) return true } ... } æ— ç¼“å†²åŒºæˆ–æ»¡äº†ä¸”æ²¡æœ‰æ¥å—è€…ï¼šé˜»å¡å‘é€ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { ... if !block { unlock(\u0026c.lock) return false } gp := getg() // è·å–å‘é€æ•°æ®ç”¨çš„goç¨‹ mysg := acquireSudog() // è·å–å¹¶å¡«å……sudogç»“æ„ mysg.elem = ep mysg.g = gp mysg.c = c gp.waiting = mysg // ç­‰å¾…sudogå°±ç»ª c.sendq.enqueue(mysg) // é˜»å¡ goparkunlock(\u0026c.lock, waitReasonChanSend, traceEvGoBlockSend, 3) // é‡Šæ”¾èµ„æº gp.waiting = nil gp.param = nil mysg.c = nil releaseSudog(mysg) return true } æ¥æ”¶æ•°æ® i\u003c-chï¼Œç¼–è¯‘æœŸé—´æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ runtime.chanrecvå‡½æ•° ä»nilé˜»å¡æ¥æ”¶æ•°æ®ä¼šç›´æ¥è®©å‡ºå¤„ç†å™¨ã€‚ func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\"unreachable\") } lock(\u0026c.lock) if c.closed != 0 \u0026\u0026 c.qcount == 0 { unlock(\u0026c.lock) if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } å¦‚æœå½“å‰channelå·²ç»å…³é—­ï¼Œä¸”ç¼“å†²åŒºä¸ºç©ºåˆ™æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶è¿”å›ã€‚ å­˜åœ¨ç­‰å¾…çš„å‘é€è€…ï¼šç›´æ¥è·å–æ•°æ® // å–å‡ºé˜Ÿå¤´ç­‰å¾…çš„goç¨‹æ¥æ”¶æ•°æ® if sg := c.sendq.dequeue(); sg != nil { recv(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true, true } func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { // ä¸å­˜åœ¨ç¼“å†²åŒº ç›´æ¥å¤åˆ¶å‘é€è€…çš„æ•°æ®åˆ°ç›®æ ‡ä½ç½® if c.dataqsiz == 0 { if ep != nil { recvDirect(c.elemtype, sg, ep) } } else { // å°†é˜Ÿåˆ—ä¸­æ•°æ®å¤åˆ¶åˆ°æ¥æ”¶æ–¹çš„å†…å­˜ä¸­ qp := chanbuf(c, c.recvx) if ep != nil { typedmemmove(c.elemtype, ep, qp) } typedmemmove(c.elemtype, qp, sg.elem) c.recvx++ c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } gp := sg.g gp.param = unsafe.Pointer(sg) goready(gp, skip+1) // é‡Šæ”¾ä¸€ä¸ªé˜»å¡å‘é€æ–¹ } ç¼“å†²åŒºä¸ä¸ºç©ºï¼šä»ç¼“å†²åŒºè¯» ä»ç¼“å†²åŒºå–å‡ºæ•°æ®å³å¯ func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { ... if c.qcount \u003e 0 { qp :","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:8","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"sync.Map å†…ç½®mapä¸æ”¯æŒå¹¶å‘è¯»å†™ https://juejin.cn/post/6844904100287496206 sync.Map çš„å®ç°åŸç†å¯æ¦‚æ‹¬ä¸ºï¼š é€šè¿‡ read å’Œ dirty ä¸¤ä¸ªå­—æ®µå°†è¯»å†™åˆ†ç¦»ï¼Œè¯»çš„æ•°æ®å­˜åœ¨åªè¯»å­—æ®µ read ä¸Šï¼Œå°†æœ€æ–°å†™å…¥çš„æ•°æ®åˆ™å­˜åœ¨ dirty å­—æ®µä¸Š è¯»å–æ—¶ä¼šå…ˆæŸ¥è¯¢ readï¼Œä¸å­˜åœ¨å†æŸ¥è¯¢ dirtyï¼Œå†™å…¥æ—¶åˆ™åªå†™å…¥ dirty è¯»å– read å¹¶ä¸éœ€è¦åŠ é”ï¼Œè€Œè¯»æˆ–å†™ dirty éƒ½éœ€è¦åŠ é” å¦å¤–æœ‰ misses å­—æ®µæ¥ç»Ÿè®¡ read è¢«ç©¿é€çš„æ¬¡æ•°ï¼ˆè¢«ç©¿é€æŒ‡éœ€è¦è¯» dirty çš„æƒ…å†µï¼‰ï¼Œè¶…è¿‡ä¸€å®šæ¬¡æ•°åˆ™å°† dirty æ•°æ®åŒæ­¥åˆ° read ä¸Š å¯¹äºåˆ é™¤æ•°æ®åˆ™ç›´æ¥é€šè¿‡æ ‡è®°æ¥å»¶è¿Ÿåˆ é™¤ type Map struct { // ä¿æŠ¤åŠ é”å­—æ®µ mu Mutex // readOnly ç»“æ„æ˜¯åªè¯»ï¼Œä½†å…¶ä¸­çš„æ“ä½œä¹Ÿæœ‰å†™ read atomic.Value // æœ€ç»ˆå†™å…¥çš„æ•°æ® dirty map[interface{}]*entry // è®¡æ•°å™¨ï¼Œæ¯æ¬¡readæ²¡æœ‰ï¼Œè¯»dirtyå°±+1 misses int } type readOnly struct { // åªè¯»map m map[interface{}]*entry // è„æ˜ å°„ä¸­æœ‰ä¸åœ¨mä¸­çš„å€¼å°±true-\u003e dirtyè¢«æå‡äº†ç½®ä¸ºfalseï¼Œdirty=nil,trueè¡¨ç¤ºä¸Šä¸€æ¬¡å·²ç»æŠŠreadæ‹·è´åˆ°dirtyï¼Œä¸”è®¾ç½®æ–°çš„å€¼ amended bool // true if the dirty map contains some key not in m. } // expunge ä»£è¡¨ dirty ä¸­è¢«åˆ æ‰çš„æƒ…å†µ var expunged = unsafe.Pointer(new(interface{})) // å­˜å‚¨å€¼çš„æŒ‡é’ˆ type entry struct { p unsafe.Pointer // *interface{} } // readé‡Œé¢æœ‰keyå°±ç›´æ¥åŸå­è¯»ï¼Œå¦åˆ™å¦‚æœdirty!=nilå°±å°è¯•ä»dirtyè¯»ï¼ˆå¦‚æœé”™è¿‡æ¬¡æ•°å¤ªå¤šå°±å°†dirtyæå‡ï¼Œè®¾ç½®dirty=nil,amended=falseï¼‰ func (m *Map) Load(key interface{}) (value interface{}, ok bool) { // å°è¯•ä»readè¯»readonlyå¯¹è±¡ read, _ := m.read.Load().(readOnly) e, ok := read.m[key] if !ok \u0026\u0026 read.amended { m.mu.Lock() read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026\u0026 read.amended { e, ok = m.dirty[key] // æ ‡è®°é”™è¿‡ï¼Œå¦‚æœé”™è¿‡æ¬¡æ•°å¤ªå¤šå°±å°†dirtyæå‡ m.missLocked() } m.mu.Unlock() } if !ok { return nil, false } // è¿”å›ç»“æœ return e.load() } // readé‡Œé¢æˆ–è€…dirtyæœ‰keyå°±ä¹è§‚é”æˆ–åŸå­æ›´æ–°å¯¹åº”çš„e.pï¼Œå¦åˆ™å¦‚æœdirtyä¸ºnilå°±æ‹·è´readåˆ°dirty(amended=false,e.på¦‚æœç­‰äºnil-\u003eexpunged),æ·»åŠ kï¼Œvåˆ°dirty func (m *Map) Store(key, value interface{}) { read, _ := m.read.Load().(readOnly) // å¦‚æœreadé‡Œé¢æœ‰å°±æ›´æ–°read if e, ok := read.m[key]; ok \u0026\u0026 e.tryStore(\u0026value) { return } m.mu.Lock() read, _ = m.read.Load().(readOnly) // readæœ‰ä¸”æ ‡è®°ä¸ºåˆ é™¤ åˆ™ç½®ä¸ºnilï¼Œç„¶åæ·»åŠ åˆ°dirtyä¸­,æœ€åæ›´æ–°readå€¼ if e, ok := read.m[key]; ok { // dirty != nil if e.unexpungeLocked() { // æ·»åŠ dirty m.dirty[key] = e } e.storeLocked(\u0026value) } else if e, ok := m.dirty[key]; ok { // readæ²¡æœ‰ï¼Œdirtyä¸­æœ‰keyå°±æ›´æ–°v e.storeLocked(\u0026value) } else { // è¿™ä¸ªè¡¨ç¤ºdirtyå¯èƒ½ä¸ºnil if !read.amended { // å°†readå¤åˆ¶åˆ°dirtyï¼ŒåŒæ—¶æŠŠnilæ›´æ”¹ä¸ºæ ‡è®°åˆ é™¤ m.dirtyLocked() // æ ‡è®°dirtyä¸ä¸ºnilä¸”æ•°æ®å¤š m.read.Store(readOnly{m: read.m, amended: true}) } // dirtyä¸­æ·»åŠ value m.dirty[key] = newEntry(value) } m.mu.Unlock() } // readä¸­æœ‰keyåˆ™å°†e.p-\u003enilï¼Œå¦åˆ™å¦‚æœdirty!=nilï¼Œå»dirtyä¸­æ‰¾å¹¶åˆ é™¤keyï¼Œæœ€åå¦‚æœè¿™ä¸ªå€¼å­˜åœ¨e.p-\u003enil func (m *Map) Delete(key interface{}) { m.LoadAndDelete(key) } // readä¸­æœ‰keyåˆ™å°†e.p-\u003enilï¼Œå¦åˆ™å¦‚æœdirtyä¸­æœ‰å€¼ï¼Œå»dirtyä¸­æ‰¾å¹¶åˆ é™¤keyï¼Œæœ€åå¦‚æœè¿™ä¸ªå€¼å­˜åœ¨e.p-\u003enil func (m *Map) LoadAndDelete(key interface{}) (value interface{}, loaded bool) { read, _ := m.read.Load().(readOnly) e, ok := read.m[key] // readä¸­æ²¡æœ‰ä¸”dirtyæ•°æ®å¤šå°±å»dirtyä¸­æ‰¾ï¼Œç„¶ååˆ é™¤kå¹¶å¢åŠ ç©¿é€æ¬¡æ•°ï¼Œæœ€åå¦‚æœæœ‰å°±æ›´æ–°å€¼ä¸ºnil if !ok \u0026\u0026 read.amended { m.mu.Lock() read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026\u0026 read.amended { e, ok = m.dirty[key] delete(m.dirty, key) m.missLocked() } m.mu.Unlock() } // readä¸­æœ‰å°±å°è¯•æŠŠe.pç½®ä¸ºnil if ok { return e.delete() } return nil, false } ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:9","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ§åˆ¶åç¨‹æ•°é‡ ç¼“å†²chan+sync package main import ( \"fmt\" \"math\" \"sync\" \"runtime\" ) var wg = sync.WaitGroup{} func busi(ch chan bool, i int) { fmt.Println(\"go func \", i, \" goroutine count = \", runtime.NumGoroutine()) \u003c-ch wg.Done() } func main() { //æ¨¡æ‹Ÿç”¨æˆ·éœ€æ±‚goä¸šåŠ¡çš„æ•°é‡ task_cnt := math.MaxInt64 ch := make(chan bool, 3) for i := 0; i \u003c task_cnt; i++ { wg.Add(1) ch \u003c- true go busi(ch, i) } wg.Wait() } æ— ç¼“å†²chan+å·¥ä½œæ±  package main import ( \"fmt\" \"math\" \"sync\" \"runtime\" ) var wg = sync.WaitGroup{} func busi(ch chan int) { for t := range ch { fmt.Println(\"go task = \", t, \", goroutine count = \", runtime.NumGoroutine()) wg.Done() } } func sendTask(task int, ch chan int) { wg.Add(1) ch \u003c- task } func main() { ch := make(chan int) //æ— buffer channel goCnt := 3 //å¯åŠ¨goroutineçš„æ•°é‡ for i := 0; i \u003c goCnt; i++ { //å¯åŠ¨go go busi(ch) } taskCnt := math.MaxInt64 //æ¨¡æ‹Ÿç”¨æˆ·éœ€æ±‚ä¸šåŠ¡çš„æ•°é‡ for t := 0; t \u003c taskCnt; t++ { //å‘é€ä»»åŠ¡ sendTask(t, ch) } wg.Wait() } è¿™é‡Œå®é™…ä¸Šæ˜¯å°†ä»»åŠ¡çš„å‘é€å’Œæ‰§è¡Œåšäº†ä¸šåŠ¡ä¸Šçš„åˆ†ç¦»ã€‚ä½¿å¾—æ¶ˆæ¯å‡ºå»ï¼Œè¾“å…¥SendTaskçš„é¢‘ç‡å¯è®¾ç½®ã€æ‰§è¡ŒGoroutineçš„æ•°é‡ä¹Ÿå¯è®¾ç½®ã€‚ä¹Ÿå°±æ˜¯æ—¢æ§åˆ¶è¾“å…¥(ç”Ÿäº§)ï¼Œåˆæ§åˆ¶è¾“å‡º(æ¶ˆè´¹)ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:10","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"GMP æ¨èé˜…è¯»:https://www.yuque.com/aceld/golang/srxd6d å•è¿›ç¨‹ï¼šè¿›ç¨‹é˜»å¡æµªè´¹CPU å¤šè¿›ç¨‹ï¼šåˆ‡æ¢èµ„æºæ¶ˆè€—é«˜ å¤šçº¿ç¨‹ï¼šä¸€ä¸ªçº¿ç¨‹å ç”¨å†…å­˜å¤§ï¼Œè°ƒåº¦æ¶ˆè€—CPU äºæ˜¯çº¿ç¨‹è¢«åˆ†ä¸ºç”¨æˆ·æ€çº¿ç¨‹ï¼ˆåç¨‹ï¼‰å’Œå†…æ ¸æ€çº¿ç¨‹ï¼Œä¸€ä¸ªâ€œç”¨æˆ·æ€çº¿ç¨‹â€å¿…é¡»è¦ç»‘å®šä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€ï¼Œä½†æ˜¯CPUå¹¶ä¸çŸ¥é“æœ‰â€œç”¨æˆ·æ€çº¿ç¨‹â€çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€(Linuxçš„PCBè¿›ç¨‹æ§åˆ¶å—)ã€‚ æ˜ å°„å…³ç³» Nï¼š1 ä¼˜ç‚¹ï¼š åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ ç¼ºç‚¹ï¼š æ— æ³•åˆ©ç”¨CPUå¤šæ ¸åŠ é€Ÿèƒ½åŠ›ï¼Œæ— æ³•å¹¶è¡Œã€‚ ä¸€ä¸ªåç¨‹é˜»å¡ï¼Œæ•´ä¸ªè¿›ç¨‹éƒ½é˜»å¡ã€‚ 1ï¼š1 1ä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æœ€å®¹æ˜“å®ç°ã€‚åç¨‹çš„è°ƒåº¦éƒ½ç”±CPUå®Œæˆäº†ï¼Œä¸å­˜åœ¨N:1ç¼ºç‚¹ï¼Œ ç¼ºç‚¹ï¼š åç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”±CPUå®Œæˆï¼Œæœ‰ç‚¹ç•¥æ˜¾æ˜‚è´µäº†ã€‚ Nï¼šN Mä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œæ˜¯N:1å’Œ1:1ç±»å‹çš„ç»“åˆï¼Œå…‹æœäº†ä»¥ä¸Š2ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†å®ç°èµ·æ¥æœ€ä¸ºå¤æ‚ã€‚ åç¨‹è·Ÿçº¿ç¨‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œçº¿ç¨‹ç”±CPUè°ƒåº¦æ˜¯æŠ¢å å¼çš„ï¼Œåç¨‹ç”±ç”¨æˆ·æ€è°ƒåº¦æ˜¯åä½œå¼çš„ï¼Œä¸€ä¸ªåç¨‹è®©å‡ºCPUåï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚ goroutine(Goçš„åç¨‹) Goä¸ºäº†æä¾›æ›´å®¹æ˜“ä½¿ç”¨çš„å¹¶å‘æ–¹æ³•ï¼Œä½¿ç”¨äº†goroutineå’Œchannelã€‚goroutineæ¥è‡ªåç¨‹çš„æ¦‚å¿µï¼Œè®©ä¸€ç»„å¯å¤ç”¨çš„å‡½æ•°è¿è¡Œåœ¨ä¸€ç»„çº¿ç¨‹ä¹‹ä¸Šï¼Œå³ä½¿æœ‰åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿå¯ä»¥è¢«runtimeè°ƒåº¦ï¼Œè½¬ç§»åˆ°å…¶ä»–å¯è¿è¡Œçš„çº¿ç¨‹ä¸Šã€‚æœ€å…³é”®çš„æ˜¯ï¼Œç¨‹åºå‘˜çœ‹ä¸åˆ°è¿™äº›åº•å±‚çš„ç»†èŠ‚ï¼Œè¿™å°±é™ä½äº†ç¼–ç¨‹çš„éš¾åº¦ï¼Œæä¾›äº†æ›´å®¹æ˜“çš„å¹¶å‘ã€‚ Goä¸­ï¼Œåç¨‹è¢«ç§°ä¸ºgoroutineï¼Œå®ƒéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å‡ KBï¼Œå¹¶ä¸”è¿™å‡ KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œruntimeä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚ Goroutineç‰¹ç‚¹ï¼š å ç”¨å†…å­˜æ›´å°ï¼ˆå‡ kbï¼‰ è°ƒåº¦æ›´çµæ´»(runtimeè°ƒåº¦) Gï¼šåç¨‹ Mï¼šçº¿ç¨‹ GMè°ƒåº¦å™¨ ç¼ºç‚¹ï¼š Må¯¹Gè¿›è¡Œæ“ä½œéƒ½éœ€è¦æŒæœ‰å…¨å±€é”ï¼Œæ¿€çƒˆçš„é”ç«äº‰ Mè½¬ç§»Gä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–è´Ÿæ‹…ï¼šæ¯”å¦‚æ–°çš„Goç¨‹è‚¯å®šå’ŒåŸæœ¬çš„Goç¨‹èµ„æºç›¸å…³ã€‚ CPUåœ¨Mä¸ŠçŠ¶æ€åˆ‡æ¢å¢åŠ ç³»ç»Ÿå¼€é”€ GMPè°ƒåº¦å™¨ Gï¼šgoç¨‹ï¼ŒMï¼šçº¿ç¨‹ï¼ŒPï¼šåç¨‹å¤„ç†å™¨ï¼ˆProcessorï¼‰ Processorï¼Œå®ƒåŒ…å«äº†è¿è¡Œgoroutineçš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹æƒ³è¿è¡Œgoroutineï¼Œå¿…é¡»å…ˆè·å–Pï¼ŒPä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„Gé˜Ÿåˆ—ã€‚ GMPæ¨¡å‹ åœ¨Goä¸­ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œgoroutineçš„å®ä½“ï¼Œè°ƒåº¦å™¨çš„åŠŸèƒ½æ˜¯æŠŠå¯è¿è¡Œçš„goroutineåˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ä¸Šã€‚ å…¨å±€é˜Ÿåˆ—ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„G Pæœ¬åœ°é˜Ÿåˆ—ï¼šç±»ä¼¼å…¨å±€é˜Ÿåˆ—ï¼Œæ•°é‡æœ‰é™ï¼ˆ256ï¼‰ï¼›æ–°å»ºGæ—¶ä¼˜å…ˆåŠ å…¥æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœæ»¡äº†ç§»åŠ¨ä¸€åŠå»å…¨å±€ Påˆ—è¡¨ï¼šæ‰€æœ‰Gåœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ª Mï¼šçº¿ç¨‹è¿è¡Œä»»åŠ¡éœ€è¦è·å–Pï¼Œä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼ŒPç©ºMå°±å°è¯•å»å…¨å±€å»ä¸€æ‰¹Gæ”¾æœ¬åœ°ï¼Œæˆ–è€…å»å…¶ä»–Pæœ¬åœ°å·ä¸€åŠã€‚Mæ‰§è¡Œæœ¬åœ°é˜Ÿåˆ—çš„Gã€‚ Goroutineè°ƒåº¦å™¨å’ŒOSè°ƒåº¦å™¨æ˜¯é€šè¿‡Mç»“åˆèµ·æ¥çš„ï¼Œæ¯ä¸ªMéƒ½ä»£è¡¨äº†1ä¸ªå†…æ ¸çº¿ç¨‹ï¼ŒOSè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹åˆ†é…åˆ°CPUçš„æ ¸ä¸Šæ‰§è¡Œã€‚ På’ŒM æ•°é‡ Pæ•°é‡ ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡$GOMAXPROCSæˆ–è€…æ˜¯ç”±runtimeçš„æ–¹æ³•GOMAXPROCS()å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰$GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œã€‚ Mçš„æ•°é‡: goè¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000.ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚ runtime/debugä¸­çš„SetMaxThreadså‡½æ•°ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡ ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„Mã€‚ Må’ŒPæ²¡ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ªMé˜»å¡På»åˆ›å»ºæˆ–åˆ‡æ¢å…¶ä»–Mã€‚ åˆ›å»ºæ—¶é—´ Pä½•æ—¶åˆ›å»ºï¼šè¿è¡Œæ—¶å°±ä¼šæ ¹æ®æœ€å¤§æ•°é‡æ¥åˆ›å»º Mä½•æ—¶åˆ›å»ºï¼šæ²¡æœ‰Mæ¥å…³è”Pï¼ŒPå°±ä¼šå»å¯»æ‰¾æˆ–è€…åˆ›å»ºæ–°çš„Mã€‚ è°ƒåº¦å™¨è®¾è®¡ç­–ç•¥ å¤ç”¨çº¿ç¨‹ï¼šé¿å…é¢‘ç¹çš„åˆ›å»ºï¼Œé”€æ¯ã€‚ 1ï¼‰work stealingæœºåˆ¶ å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚ 2ï¼‰hand offæœºåˆ¶ å½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚ åˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCSè®¾ç½®Pçš„æ•°é‡ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCSä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„CPUæ ¸è¿›è¡Œå¹¶è¡Œã€‚ æŠ¢å ï¼šåœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºCPUæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨Goä¸­ï¼Œä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹ã€‚ å…¨å±€Gé˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ï¼Œå½“Mæ‰§è¡Œwork stealingä»å…¶ä»–På·ä¸åˆ°Gæ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€Gé˜Ÿåˆ—è·å–Gã€‚ go func() è°ƒåº¦æµç¨‹ go func åˆ›å»ºGç¨‹ æ–°çš„Gä¼˜å…ˆå­˜åœ¨æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ¬åœ°æ»¡äº†å­˜åˆ°å…¨å±€ Mä¼šä»Pä¸­å¼¹å‡ºä¸€ä¸ªGæ‰§è¡Œï¼ŒPå¦‚æœä¸ºç©ºä¼šå»å…¨å±€æˆ–è€…å…¶ä»–é˜Ÿåˆ—å· å½“Mæ‰§è¡Œä¸€ä¸ªGæ—¶å¦‚æœå‘ç”Ÿäº†IOæˆ–è€…å…¶ä»–é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ã€‚ç„¶åPå°±ä¼šè¢«è„±ç¦»Mï¼Œå¯»æ‰¾å…¶ä»–ç©ºé—²çš„Mæˆ–è€…æ–°å»ºMå»æ‰§è¡Œã€‚ Mæ¢å¤åä¼šå°è¯•ç»‘å®šPï¼Œå¦‚æœæ²¡æœ‰Påˆ™Mä¼šä¼‘çœ åŠ å…¥ç©ºé—²çº¿ç¨‹ï¼Œç„¶åGä¼šæ”¾å…¥å…¨å±€é˜Ÿåˆ—ã€‚ è°ƒåº¦å™¨å£°æ˜å‘¨æœŸ ç‰¹æ®Šçš„M0é‡‘å’ŒG0 M0 M0è´Ÿè´£åˆå§‹åŒ–å’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œä¹‹åå’Œå…¶ä»–Mç›¸åŒ G0 G0æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªMéƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„gourtineï¼ŒG0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼ŒG0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ªMéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„G0æ˜¯M0çš„G0ã€‚ package main import \"fmt\" func main() { fmt.Println(\"Hello world\") } runtime åˆ›å»ºå¹¶å…³è”M0,G0 è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ–M0,æ ˆï¼ŒGCï¼Œå¹¶åˆ›å»ºæ‰€æœ‰P ç¤ºä¾‹ä»£ç ä¸­çš„mainå‡½æ•°æ˜¯main.mainï¼Œruntimeä¸­ä¹Ÿæœ‰1ä¸ªmainå‡½æ•°â€”â€”runtime.mainï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œruntime.mainä¼šè°ƒç”¨main.mainï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸ºruntime.mainåˆ›å»ºgoroutineï¼Œç§°å®ƒä¸ºmain goroutineå§ï¼Œç„¶åæŠŠmain goroutineåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚ å¯åŠ¨M0,M0ä¼šä»æœ¬åœ°è·å–Gï¼ˆmain gï¼‰ç„¶åæ‰§è¡Œ Mæ ¹æ®Gä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒ Mé€€å‡ºG Mè·å–å¯è¿è¡Œçš„Gï¼Œç›´åˆ°main.mainé€€å‡ºï¼Œruntime.main æ‰§è¡Œdeferæˆ–panicå¤„ç†ï¼Œæˆ–è€…runtime.exité€€å‡º Goè°ƒåº¦åœºæ™¯ æ–°å»ºåç¨‹ï¼šP1æ‹¥æœ‰G1,G1åˆ›å»ºG2,ä¸ºäº†å±€éƒ¨æ€§ï¼ŒG2ä¼˜å…ˆåŠ å…¥åˆ°P1çš„æœ¬åœ°é˜Ÿåˆ— åç¨‹åˆ‡æ¢ï¼šG1å®Œæˆåï¼ŒMä¸ŠGåˆ‡æ¢åˆ°G0,G0è´Ÿè´£åç¨‹çš„è°ƒåº¦ã€‚ä»Pæœ¬åœ°é˜Ÿåˆ—è·å–G2,ç„¶ååˆ‡æ¢åˆ°G2è¿è¡Œã€‚ æœ¬åœ°é˜Ÿåˆ—æ»¡ï¼šå‡è®¾æ¯ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—åªèƒ½å­˜3ä¸ªGã€‚G2è¦åˆ›å»ºäº†6ä¸ªGï¼Œå‰3ä¸ªGï¼ˆG3, G4, G5ï¼‰å·²ç»åŠ å…¥p1çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œp1æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ã€‚æ­¤æ—¶åˆ›å»ºG7,åˆ™éœ€è¦æ•·è´Ÿè½½å‡è¡¡ï¼ˆæŠŠP1ä¸­å‰ä¸€åŠGå’Œæ–°çš„Gæ‰“ä¹±åç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ï¼‰ å”¤é†’Mï¼šåœ¨åˆ›å»ºGæ—¶ï¼Œè¿è¡Œçš„Gä¼šå°è¯•å”¤é†’å…¶ä»–ç©ºé—²çš„På’ŒMç»„åˆ å¦‚æœM2ç»‘å®šäº†G0ä½†æ²¡æœ‰Gå»æ‰§è¡Œï¼Œåˆ™M2ä¼šè‡ªæ—‹ä¸€æ®µæ—¶é—´å¯»æ‰¾G ä»å…¨å±€é˜Ÿåˆ—è·å–ï¼šM2å°è¯•ä»å…¨å±€é˜Ÿåˆ—(ç®€ç§°â€œGQâ€)å–ä¸€æ‰¹Gæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆå‡½æ•°ï¼šfindrunnable()ï¼‰ã€‚M2ä»å…¨å±€é˜Ÿåˆ—å–çš„Gæ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š n = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2)) è‡³å°‘ä»å…¨å±€é˜Ÿåˆ—å–1ä¸ªgï¼Œä½†æ¯æ¬¡ä¸è¦ä»å…¨å±€é˜Ÿåˆ—ç§»åŠ¨å¤ªå¤šçš„gåˆ°pæœ¬åœ°é˜Ÿåˆ—ï¼Œç»™å…¶ä»–pç•™ç‚¹ã€‚è¿™æ˜¯ä»å…¨å±€é˜Ÿåˆ—åˆ°Pæœ¬åœ°é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡ çªƒå–Gï¼šå…¨å±€å’Œæœ¬åœ°é˜Ÿåˆ—éƒ½æ²¡æœ‰Gäº†ï¼ŒMä¼šä»å…¶ä»–æœ‰Gçš„é˜Ÿåˆ—ä¸­çªƒå–ä¸€åŠçš„Gåˆ°æœ¬åœ° è‡ªæ—‹Mï¼šå…¨å±€å’Œæœ¬åœ°éƒ½æ²¡Gå¯è¿è¡Œï¼ŒMåˆ™å¤„äºè‡ªæ—‹çŠ¶æ€æ¥å¯»æ‰¾G åˆ›å»ºå’Œé”€æ¯CPUä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›å½“æœ‰æ–°goroutineåˆ›å»ºæ—¶ï¼Œç«‹åˆ»èƒ½æœ‰Mè¿è¡Œå®ƒï¼Œå¦‚æœé”€æ¯å†æ–°å»ºå°±å¢åŠ äº†æ—¶å»¶ï¼Œé™ä½äº†æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿè€ƒè™‘äº†è¿‡å¤šçš„è‡ªæ—‹çº¿ç¨‹æ˜¯æµªè´¹CPUï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­æœ€å¤šæœ‰GOMAXPROCSä¸ªè‡ªæ—‹çš„çº¿ç¨‹(å½“å‰ä¾‹å­ä¸­çš„GOMAXPROCS=4ï¼Œæ‰€ä»¥ä¸€å…±4ä¸ªP)ï¼Œå¤šä½™çš„æ²¡äº‹åšçº¿ç¨‹ä¼šè®©ä»–ä»¬ä¼‘çœ ã€‚ Mé˜»å¡ï¼šMé˜»å¡På°±ä¼šè„±ç¦»å¹¶å¯»æ‰¾å¯ç”¨çš„Mæ¥ç»‘å®šï¼ˆå¦‚æœæœ¬åœ°æœ‰Gï¼‰ éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼šMä¼šå’ŒPè§£ç»‘ï¼Œä½†ä¹‹åä¼šä¼˜å…ˆå’Œå…ˆå‰çš„Pç»‘å®šã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:11","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ç½‘ç»œè½®è®­å™¨ åŸæ–‡ ç½‘ç»œè½®è®­å™¨å¯ä»¥ç”¨äºç›‘æ§ç½‘ç»œIOï¼Œæ–‡ä»¶IOç­‰ï¼Œåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„IOå¤šè·¯å¤ç”¨æ¨¡å‹æ¥æå‡IOè®¾å¤‡çš„åˆ©ç”¨ç‡å’Œæ€§èƒ½ã€‚ IO æ¨¡å‹ https://cloud.tencent.com/developer/article/1684951 IO (Input/Outputï¼Œè¾“å…¥ / è¾“å‡º) å³æ•°æ®çš„è¯»å–ï¼ˆæ¥æ”¶ï¼‰æˆ–å†™å…¥ï¼ˆå‘é€ï¼‰æ“ä½œï¼Œé€šå¸¸ç”¨æˆ·è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®Œæ•´ IO åˆ†ä¸ºä¸¤é˜¶æ®µï¼šç”¨æˆ·è¿›ç¨‹ç©ºé—´ \u003câ€“\u003e å†…æ ¸ç©ºé—´ã€å†…æ ¸ç©ºé—´ \u003câ€“\u003e è®¾å¤‡ç©ºé—´ï¼ˆç£ç›˜ã€ç½‘ç»œç­‰ï¼‰ã€‚IO æœ‰å†…å­˜ IOã€ç½‘ç»œ IO å’Œç£ç›˜ IO ä¸‰ç§ï¼Œé€šå¸¸æˆ‘ä»¬è¯´çš„ IO æŒ‡çš„æ˜¯åä¸¤è€…ã€‚ LINUX ä¸­è¿›ç¨‹æ— æ³•ç›´æ¥æ“ä½œ I/O è®¾å¤‡ï¼Œå…¶å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¯·æ±‚ kernel æ¥ååŠ©å®Œæˆ I/O åŠ¨ä½œï¼›å†…æ ¸ä¼šä¸ºæ¯ä¸ª I/O è®¾å¤‡ç»´æŠ¤ä¸€ä¸ªç¼“å†²åŒºã€‚ å¯¹äºä¸€ä¸ªè¾“å…¥æ“ä½œæ¥è¯´ï¼Œè¿›ç¨‹ IO ç³»ç»Ÿè°ƒç”¨åï¼Œå†…æ ¸ä¼šå…ˆçœ‹ç¼“å†²åŒºä¸­æœ‰æ²¡æœ‰ç›¸åº”çš„ç¼“å­˜æ•°æ®ï¼Œæ²¡æœ‰çš„è¯å†åˆ°è®¾å¤‡ä¸­è¯»å–ï¼Œå› ä¸ºè®¾å¤‡ IO ä¸€èˆ¬é€Ÿåº¦è¾ƒæ…¢ï¼Œéœ€è¦ç­‰å¾…ï¼›å†…æ ¸ç¼“å†²åŒºæœ‰æ•°æ®åˆ™ç›´æ¥å¤åˆ¶åˆ°è¿›ç¨‹ç©ºé—´ã€‚ æ‰€ä»¥ï¼Œå¯¹äºä¸€ä¸ªç½‘ç»œè¾“å…¥æ“ä½œé€šå¸¸åŒ…æ‹¬ä¸¤ä¸ªä¸åŒé˜¶æ®µï¼š ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡â†’è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œæ•°æ®å‡†å¤‡å¥½ï¼› ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ°è¿›ç¨‹ç©ºé—´ã€‚ é˜»å¡IOæ¨¡å‹ è¿›ç¨‹å‘èµ·IOè°ƒç”¨åè¿›ç¨‹é˜»å¡ï¼Œå†…æ ¸å¤„ç†å®Œæ•°æ®åè¿”å›ç»™è¿›ç¨‹ã€‚è¿›ç¨‹é˜»å¡æŒ‚èµ·ä¸æ¶ˆè€— CPU èµ„æºï¼ŒåŠæ—¶å“åº”æ¯ä¸ªæ“ä½œ éé˜»å¡IOæ¨¡å‹ è¿›ç¨‹å‘èµ·è°ƒç”¨åä¸é˜»å¡ï¼Œä½†éœ€è¦è¿›ç¨‹é€šè¿‡è½®è®­çš„æ–¹å¼æ¥è·å–æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œè¿›ç¨‹è½®è¯¢ï¼ˆé‡å¤ï¼‰è°ƒç”¨ï¼Œæ¶ˆè€— CPU çš„èµ„æºï¼› IOå¤šè·¯å¤ç”¨æ¨¡å‹ å¤šä¸ªè¿›ç¨‹çš„IOå¯ä»¥æ³¨å†Œåˆ°ä¸€ä¸ªå¤ç”¨å™¨selectä¸Šï¼Œå¯ä»¥ç”¨ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨selectæ¥é˜»å¡ç›‘å¬æ‰€æœ‰æ³¨å†Œçš„IOï¼Œå¦‚ä½•éƒ½æ²¡æœ‰æ•°æ®è¿”å›ï¼Œè¿›ç¨‹é˜»å¡,å¦‚æœä»»ä¸€IOåœ¨å†…æ ¸ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œselectå°±è¿”å›é€šçŸ¥ã€‚ç›‘å¬è¿›ç¨‹åˆ™å¯ä»¥è‡ªå·±æˆ–è€…å‘ŠçŸ¥å…¶ä»–è¿›ç¨‹è¯»å–ã€‚ å³å¤šè·¯IOå¤ç”¨å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹é˜»å¡ç­‰å¾…å¤šä¸ªIOæ“ä½œã€‚ select,poll éƒ½æ˜¯ä½¿ç”¨ã€Œçº¿æ€§ç»“æ„ã€å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ Socket é›†åˆï¼Œå› æ­¤éƒ½éœ€è¦éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œè€Œä¸”ä¹Ÿéœ€è¦åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´æ‹·è´æ–‡ä»¶æè¿°ç¬¦é›†åˆ epoll epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨çº¢é»‘æ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­— epoll ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œ ä¿¡å·é©±åŠ¨IOæ¨¡å‹ å½“è¿›ç¨‹å‘èµ·ä¸€ä¸ª IO æ“ä½œï¼Œä¼šå‘å†…æ ¸æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œç„¶åè¿›ç¨‹è¿”å›ä¸é˜»å¡ï¼›å½“å†…æ ¸æ•°æ®å°±ç»ªæ—¶ä¼šå‘é€ä¸€ä¸ªä¿¡å·ç»™è¿›ç¨‹ï¼Œè¿›ç¨‹ä¾¿åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ IO è¯»å–æ•°æ®ã€‚ å¼‚æ­¥IOæ¨¡å‹ å½“è¿›ç¨‹å‘èµ·ä¸€ä¸ª IO æ“ä½œï¼Œè¿›ç¨‹è¿”å›ï¼ˆä¸é˜»å¡ï¼‰ï¼Œä½†ä¹Ÿä¸èƒ½è¿”å›ç»“æœï¼›å†…æ ¸æŠŠæ•´ä¸ª IO å¤„ç†å®Œåï¼Œä¼šé€šçŸ¥è¿›ç¨‹ç»“æœã€‚å¦‚æœ IO æ“ä½œæˆåŠŸåˆ™è¿›ç¨‹ç›´æ¥è·å–åˆ°æ•°æ®ã€‚ æ€»ç»“ åŒæ­¥å’Œå¼‚æ­¥IO ä¸»è¦æ˜¯æŒ‡è®¿é—®æ•°æ®çš„æœºåˆ¶ (å³å®é™… I/O æ“ä½œçš„å®Œæˆæ–¹å¼) åŒæ­¥ä¸€èˆ¬æŒ‡ä¸»åŠ¨è¯·æ±‚å¹¶ç­‰å¾… I/O æ“ä½œå®Œæ¯•çš„æ–¹å¼ï¼ŒI/O æ“ä½œæœªå®Œæˆå‰ï¼Œä¼šå¯¼è‡´åº”ç”¨è¿›ç¨‹æŒ‚èµ· è€Œå¼‚æ­¥æ˜¯æŒ‡ç”¨æˆ·è¿›ç¨‹è§¦å‘ IO æ“ä½œä»¥åä¾¿å¼€å§‹åšè‡ªå·±çš„äº‹æƒ…ï¼Œè€Œå½“ IO æ“ä½œå·²ç»å®Œæˆçš„æ—¶å€™ä¼šå¾—åˆ° IOå®Œæˆçš„é€šçŸ¥ï¼ˆå¼‚æ­¥çš„ç‰¹ç‚¹å°±æ˜¯é€šçŸ¥ï¼‰, è¿™å¯ä»¥ä½¿è¿›ç¨‹åœ¨æ•°æ®è¯»å†™æ—¶ä¹Ÿä¸é˜»å¡ã€‚ æ‰€ä»¥ï¼Œ é˜»å¡ IO æ¨¡å‹ã€éé˜»å¡ IO æ¨¡å‹ã€IO å¤ç”¨æ¨¡å‹ã€ä¿¡å·é©±åŠ¨çš„ IO æ¨¡å‹è€…ä¸ºåŒæ­¥ IO æ¨¡å‹ï¼Œåªæœ‰å¼‚æ­¥ IO æ¨¡å‹æ˜¯å¼‚æ­¥ IOã€‚ é˜»å¡æˆ–è€…éé˜»å¡ I/O ä¸»è¦æ˜¯æŒ‡ I/O æ“ä½œç¬¬ä¸€é˜¶æ®µçš„å®Œæˆæ–¹å¼ (è¿›ç¨‹è®¿é—®çš„æ•°æ®å¦‚æœå°šæœªå°±ç»ª)ï¼Œå³æ•°æ®è¿˜æœªå‡†å¤‡å¥½çš„æ—¶å€™ï¼Œåº”ç”¨è¿›ç¨‹çš„è¡¨ç°ï¼Œå¦‚æœè¿™é‡Œè¿›ç¨‹æŒ‚èµ·ï¼Œåˆ™ä¸ºé˜»å¡ I/Oï¼Œå¦åˆ™ä¸ºéé˜»å¡ I/Oã€‚è¯´ç™½äº†å°±æ˜¯é˜»å¡å’Œéé˜»å¡æ˜¯é’ˆå¯¹äºè¿›ç¨‹åœ¨è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œæ ¹æ® IOæ“ä½œçš„å°±ç»ªçŠ¶æ€æ¥é‡‡å–çš„ä¸åŒæ–¹å¼ï¼Œè¯´ç™½äº†æ˜¯ä¸€ç§è¯»å–æˆ–è€…å†™å…¥æ“ä½œå‡½æ•°çš„å®ç°æ–¹å¼ï¼Œé˜»å¡æ–¹å¼ä¸‹è¯»å–æˆ–è€…å†™å…¥å‡½æ•°å°†ä¸€ç›´ç­‰å¾…ï¼Œè€Œéé˜»å¡æ–¹å¼ä¸‹ï¼Œè¯»å–æˆ–è€…å†™å…¥å‡½æ•°ä¼šç«‹å³è¿”å›ä¸€ä¸ªçŠ¶æ€å€¼ã€‚ å¤šæ¨¡å— Goé‡‡ç”¨IOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œä¸ºäº†åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨å¯¹åº”çš„å¤ç”¨æ–¹æ³•ï¼ŒGoåœ¨ç¼–è¯‘æ—¶ä¼šç¼–è¯‘æŒ‡å®šå¹³å°çš„ç½‘ç»œè½®è®­æ¨¡å—ã€‚ æ¥å£ æ¯ä¸ªæ¨¡å—éƒ½å®ç°äº†ä»¥ä¸‹å‡½æ•°ç»„æˆçš„æ¥å£ func netpollinit() // åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ sync.Once å’Œ netpollInited å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼› func netpollopen(fd uintptr, pd *pollDesc) int32 // ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„è¾¹ç¼˜è§¦å‘äº‹ä»¶ï¼Œåˆ›å»ºäº‹ä»¶å¹¶åŠ å…¥ç›‘å¬ func netpoll(delta int64) gList // è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ Goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸º 3ï¼› func netpollBreak() // å”¤é†’ç½‘ç»œè½®è¯¢å™¨ï¼Œä¾‹å¦‚ï¼šè®¡æ—¶å™¨å‘å‰ä¿®æ”¹æ—¶é—´æ—¶ä¼šé€šè¿‡è¯¥å‡½æ•°ä¸­æ–­ç½‘ç»œè½®è¯¢å™¨ 4ï¼› func netpollIsPollDescriptor(fd uintptr) bool // åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«è½®è¯¢å™¨ä½¿ç”¨ æ•°æ®ç»“æ„ æ“ä½œç³»ç»Ÿä¸­ I/O å¤šè·¯å¤ç”¨å‡½æ•°ä¼šç›‘æ§æ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»æˆ–è€…å¯å†™ï¼Œè€Œ Go è¯­è¨€ç½‘ç»œè½®è¯¢å™¨ä¼šç›‘å¬ runtime.pollDesc ç»“æ„ä½“çš„çŠ¶æ€ï¼Œå®ƒä¼šå°è£…æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼š type pollDesc struct { link *pollDesc lock mutex fd uintptr ... rseq uintptr rg uintptr rt timer rd int64 wseq uintptr wg uintptr wt timer wd int64 } è¯¥ç»“æ„ä½“ä¸­åŒ…å«ç”¨äºç›‘æ§å¯è¯»å’Œå¯å†™çŠ¶æ€çš„å˜é‡ï¼Œæˆ‘ä»¬æŒ‰ç…§åŠŸèƒ½å°†å®ƒä»¬åˆ†æˆä»¥ä¸‹å››ç»„ï¼š rseq å’Œ wseq â€” è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦è¢«é‡ç”¨æˆ–è€…è®¡æ—¶å™¨è¢«é‡ç½® 5ï¼› rg å’Œ wg â€” è¡¨ç¤ºäºŒè¿›åˆ¶çš„ä¿¡å·é‡ï¼Œå¯èƒ½ä¸º pdReadyã€pdWaitã€ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–è€…å¯å†™çš„ Goroutine ä»¥åŠ nilï¼› rd å’Œ wd â€” ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–è€…å¯å†™çš„æˆªæ­¢æ—¥æœŸï¼› rt å’Œ wt â€” ç”¨äºç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„è®¡æ—¶å™¨ï¼› è¯¥ç»“æ„ä½“ä¸­è¿˜ä¿å­˜äº†ç”¨äºä¿æŠ¤æ•°æ®çš„äº’æ–¥é”ã€æ–‡ä»¶æè¿°ç¬¦ã€‚runtime.pollDesc ç»“æ„ä½“ä¼šä½¿ç”¨ link å­—æ®µä¸²è”æˆé“¾è¡¨å­˜å‚¨åœ¨ runtime.pollCache ä¸­ï¼š type pollCache struct { lock mutex first *pollDesc } runtime.pollCache æ˜¯è¿è¡Œæ—¶åŒ…ä¸­çš„å…¨å±€å˜é‡ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«ä¸€ä¸ªç”¨äºä¿æŠ¤è½®è¯¢æ•°æ®çš„äº’æ–¥é”å’Œé“¾è¡¨å¤´ï¼š è¿è¡Œæ—¶ä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ runtime.pollCache.alloc æ–¹æ³•æ—¶åˆå§‹åŒ–æ€»å¤§å°çº¦ä¸º 4KB çš„ runtime.pollDesc ç»“æ„ä½“ï¼Œruntime.persistentAlloc ä¼šä¿è¯è¿™äº›æ•°æ®ç»“æ„åˆå§‹åŒ–åœ¨ä¸ä¼šè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜ä¸­ï¼Œè®©è¿™äº›æ•°æ®ç»“æ„åªèƒ½è¢«å†…éƒ¨çš„ epoll å’Œ kqueue æ¨¡å—å¼•ç”¨ï¼š func (c *pollCache) alloc() *pollDesc { lock(\u0026c.lock) if c.first == nil { // ç¬¬ä¸€æ¬¡å…ˆåˆå§‹åŒ–ä¸€æ‰¹ const pdSize = unsafe.Sizeof(pollDesc{}) n := pollBlockSize / pdSize if n == 0 { n = 1 } mem := persistentalloc(n*pdSize, 0, \u0026memstats.other_sys) for i := uintptr(0); i \u003c n; i++ { pd := (*pollDesc)(add(mem, i*pdSize)) pd.link = c.first c.first = pd } } // æ¯æ¬¡åªè·å–ç¬¬ä¸€ä¸ª pd := c.first c.first = pd.link unlock(\u0026c.lock) return pd } æ¯æ¬¡è°ƒç”¨è¯¥ç»“æ„ä½“éƒ½ä¼šè¿”å›é“¾è¡¨å¤´è¿˜æ²¡æœ‰è¢«ä½¿ç”¨çš„ runtime.pollDescï¼Œè¿™ç§æ‰¹é‡åˆå§‹åŒ–çš„åšæ³•èƒ½å¤Ÿå¢åŠ ç½‘ç»œè½®è¯¢å™¨çš„ååé‡ã€‚Go è¯­è¨€è¿è¡Œæ—¶ä¼šè°ƒç”¨ runtime.pollCache.free æ–¹æ³•é‡Šæ”¾å·²ç»ç”¨å®Œçš„ runtime.pollDesc ç»“æ„ï¼Œå®ƒä¼šç›´æ¥å°†ç»“æ„ä½“æ’å…¥é“¾è¡¨çš„æœ€å‰é¢ï¼š func (c *pollCache) free(pd *pollDesc) { lock(\u0026c.lock) pd.link = c.first c.first = pd unlock(\u0026c.lock) } ä¸Šè¿°æ–¹æ³•æ²¡æœ‰é‡ç½® runtime.pollDesc ç»“æ„ä½“ä¸­çš„å­—æ®µï¼Œè¯¥ç»“æ„ä½“è¢«é‡å¤åˆ©ç”¨æ—¶æ‰ä¼šç”± runtime.poll_runtime_pollOpen å‡½æ•°é‡ç½®ã€‚ å¤šè·¯å¤ç”¨ ç½‘ç»œè½®è¯¢å™¨å®é™…ä¸Šæ˜¯å¯¹ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„å°è£…ï¼Œæœ¬èŠ‚å°†é€šè¿‡ä»¥ä¸‹çš„ä¸‰ä¸ªè¿‡ç¨‹åˆ†æç½‘ç»œè½®è¯¢å™¨çš„å®ç°åŸç†ï¼š ç½‘ç»œè½®è¯¢å™¨çš„åˆå§‹åŒ–ï¼› å¦‚ä½•å‘ç½‘ç»œè½®è¯¢å™¨åŠ å…¥å¾…ç›‘æ§çš„ä»»åŠ¡ï¼› å¦‚ä½•ä»ç½‘ç»œè½®è¯¢å™¨è·å–è§¦å‘çš„äº‹ä»¶ï¼› å› ä¸ºä¸åŒ I/O å¤šè·¯å¤ç”¨æ¨¡å—çš„å®ç°å¤§åŒå°å¼‚ï¼Œæœ¬èŠ‚ä¼šä½¿ç”¨ Linux æ“ä½œç³»ç»Ÿä¸Šçš„ epoll å®ç°ï¼› å› ä¸ºå¤„ç†è¯»äº‹ä»¶å’Œå†™äº‹ä»¶çš„é€»è¾‘ç±»ä¼¼ï¼Œæœ¬èŠ‚ä¼šçœç•¥å†™äº‹ä»¶ç›¸å…³çš„ä»£ç ï¼› åˆå§‹åŒ– å› ä¸ºæ–‡ä»¶ I/Oã€ç½‘ç»œ I/O ä»¥åŠè®¡æ—¶å™¨éƒ½ä¾èµ–ç½‘ç»œè½®è¯¢å™¨ï¼Œæ‰€ä»¥ Go è¯­è¨€ä¼šé€šè¿‡ä»¥ä¸‹ä¸¤æ¡ä¸åŒè·¯å¾„åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼š internal/poll.pollDesc.init â€” é€šè¿‡ net.netFD.init å’Œ os.newFile åˆå§‹åŒ–ç½‘ç»œ I/O å’Œæ–‡ä»¶ I/O çš„è½®è¯¢ä¿¡æ¯æ—¶ï¼› runtime.doaddtimer â€” å‘å¤„ç†å™¨ä¸­å¢åŠ æ–°çš„è®¡æ—¶å™¨æ—¶","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:6:12","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å†…å­˜ç®¡ç† åˆ˜ä¸¹å†°yydsï¼ https://www.yuque.com/aceld/golang/qzyivn#cDuEt Golangçš„å†…å­˜ç®¡ç†å°±æ˜¯åŸºäºTCMallocçš„æ ¸å¿ƒæ€æƒ³æ¥æ„å»ºçš„ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"TCMalloc TCMallocæœ€å¤§ä¼˜åŠ¿å°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šç‹¬ç«‹ç»´æŠ¤è‡ªå·±çš„å†…å­˜æ± ã€‚ æ‰€æœ‰goç¨‹å…±äº«çš„å†…å­˜æ± æ¨¡å‹ï¼š ç¼ºç‚¹ï¼šåº”ç”¨æ–¹å†…å­˜ç”³è¯·éœ€è¦å’Œå…¨å±€BufPoolæ‰“äº¤é“ï¼Œä¸ºäº†çº¿ç¨‹å®‰å…¨éœ€è¦é¢‘ç¹åŠ é”å’Œè§£é” å±‚çº§æ¨¡å‹ TCMallocåˆ™ä¸ºæ¯ä¸ªçº¿ç¨‹é¢„åˆ†é…ä¸€å—ç¼“å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™ä¼šå…ˆä»çº¿ç¨‹ç¼“å­˜æ± ä¸­ç”³è¯·ã€‚æ¯ä¸ªçº¿ç¨‹ç¼“å­˜æ± å…±äº«ä¸€å—ä¸­å¿ƒç¼“å­˜ã€‚ å¥½å¤„ï¼šçº¿ç¨‹ç‹¬ç«‹ç¼“å­˜å‡å°‘åŠ é”å‘ç”Ÿæ¬¡æ•° ThreadCache ä½œä¸ºçº¿ç¨‹ç‹¬ç«‹çš„ç¬¬ä¸€äº¤äº’å†…å­˜ï¼Œè®¿é—®æ— éœ€åŠ é”ï¼ŒCentralCache åˆ™ä½œä¸º ThreadCache ä¸´æ—¶è¡¥å……ç¼“å­˜ã€‚ å†…å­˜å¯¹è±¡åˆ’åˆ†ï¼š å¯¹è±¡ å®¹é‡ å°å¯¹è±¡ (0,256KB] ä¸­å¯¹è±¡ (256KB, 1MB] å¤§å¯¹è±¡ (1MB, +âˆ) ThreadCacheå’ŒCentralCacheå¯ä»¥ç”¨æ¥è§£å†³å°å¯¹è±¡å†…å­˜å—çš„ç”³è¯·ã€‚ è€Œå¯¹äºä¸­ï¼Œå¤§å¯¹è±¡çš„å†…å­˜ç”³è¯·ï¼ŒTCMallocæä¾›ä¸€ä¸ªå…¨å±€å…±äº«çš„å†…å­˜å †PageHeapã€‚å½“ç„¶å¯¹å…¶è¿›è¡Œæ“ä½œéœ€è¦è¿›è¡ŒåŠ é”ã€‚ é¡µå †ä¸»è¦æ—¶å½“ä¸­å¿ƒç¼“å­˜æ²¡ç©ºé—´æ—¶å‘å…¶ç”³è¯·ï¼Œè¿‡å¤šæ—¶é€€è¿˜ï¼Œä»¥åŠçº¿ç¨‹åœ¨ç”³è¯·å¤§å¯¹è±¡è¶…è¿‡Cacheçš„å†…å­˜å•å…ƒå—å•å…ƒå¤§å°æ—¶ä¹Ÿä¼šç›´æ¥å‘é¡µå †ç”³è¯·ã€‚ åŸºç¡€ç»“æ„ Page TCMallocå°†è™šæ‹Ÿå†…å­˜åˆ’åˆ†ä¸ºå¤šä»½åŒç­‰å¤§å°çš„Pageï¼Œæ¯ä¸ªPageé»˜è®¤8KBï¼Œå¯ä»¥é€šè¿‡åœ°å€æŒ‡é’ˆ+åç§»é‡æ¥ç¡®å®šPageä½ç½®ã€‚ Span å¤šä¸ªè¿ç»­çš„ Page ç§°ä¹‹ä¸ºæ˜¯ä¸€ä¸ª Spanï¼Œå…¶å®šä¹‰å«ä¹‰æœ‰æ“ä½œç³»ç»Ÿçš„ç®¡ç†çš„é¡µè¡¨ç›¸ä¼¼ã€‚ TCMalloc æ˜¯ä»¥ Span ä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„ã€‚æ¯ä¸ª Span è®°å½•äº†ç¬¬ä¸€ä¸ªèµ·å§‹ Page çš„ç¼–å· Startï¼Œå’Œä¸€å…±æœ‰å¤šå°‘ä¸ªè¿ç»­ Page çš„æ•°é‡ Lengthã€‚ åŒæ—¶spanä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨æ¥è¿æ¥ã€‚ Size Class åœ¨256KBä»¥å†…çš„å°å¯¹è±¡ä¼šè¢«TCMallocåˆ’åˆ†ä¸ºå¤šä¸ªå†…å­˜åˆ»åº¦ï¼ŒåŒä¸€ä¸ªåˆ»åº¦ä¸‹çš„å†…å­˜é›†åˆç§°ä¸ºSize Class. æ¯ä¸ªSize Classéƒ½å¯¹åº”ä¸€ä¸ªå­—èŠ‚å¤§å°ã€‚åœ¨ç”³è¯·å°å¯¹è±¡å†…å­˜æ—¶ï¼ŒTCMallocä¼šæ ¹æ®ç”³è¯·å­—èŠ‚å‘ä¸Šå–ä¸€ä¸ªSize Classçš„Spanï¼ˆå¤šä¸ªpageç»„æˆï¼‰çš„å†…å­˜å—ç»™ä½¿ç”¨è€…ã€‚ ThreadCache ThreadCacheå³çº¿ç¨‹è‡ªå·±çš„ç¼“å­˜ã€‚å…¶å¯¹äºæ¯ä¸ªSizeClasséƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„FreeListï¼Œè¡¨ç¤ºå½“å‰ç¼“å­˜ä¸­è¿˜æœ‰å¤šå°‘ç©ºé—²çš„å†…å­˜å¯ç”¨ã€‚ æµç¨‹ï¼šä½¿ç”¨è€…ç”³è¯·å°å¯¹è±¡å†…å­˜ç›´æ¥é€šè¿‡ThreadCacheè·å–å¯¹åº”Size Classçš„ä¸€ä¸ªSpanï¼Œå¦‚æœå¯¹åº”çš„Size Classä¸‹çš„é“¾è¡¨ä¸ºnilï¼Œåˆ™ThreadCacheä¼šå‘ThreadCacheç”³è¯·ç©ºé—´ï¼Œçº¿ç¨‹ç”¨å®Œå†…å­˜åä¹Ÿæ˜¯ç›´æ¥å½’è¿˜åˆ°æœ¬çº¿ç¨‹å¯¹åº”åˆ»åº¦ä¸‹çš„spanåŒå‘é“¾è¡¨ä¸­ã€‚ CentralCache CentralCacheæ˜¯æ‰€æœ‰çº¿ç¨‹å…±ç”¨çš„ã€‚å…¶ç»“æ„å’ŒThreadCacheç›¸ä¼¼ï¼Œå„ä¸ªåˆ»åº¦çš„spané“¾è¡¨è¢«æ”¾ç½®åœ¨CentralFreeListä¹‹ä¸­ã€‚ æµç¨‹ï¼šThreadCacheåœ¨å†…å­˜ä¸å¤Ÿæ—¶ä¼šå‘CentralFreeListç”³è¯·æŒ‡å®šåˆ»åº¦çš„å†…å­˜ï¼Œå½“å…¶å†…å­˜å¤šä½™æ—¶ä¹Ÿä¼šå½’è¿˜ç»™CentralFreeListã€‚PageHeapå’ŒCentralFreeListå…³ç³»ä¹Ÿç±»ä¼¼ã€‚ PageHeap Headä¸CentralCacheä¸åŒçš„æ˜¯CentralCacheæ˜¯ä¸ThreadCacheå¸ƒå±€ä¸€æ¨¡ä¸€æ ·çš„ç¼“å­˜ï¼Œä¸»è¦æ˜¯èµ·åˆ°é’ˆå¯¹ThreadCacheçš„ä¸€å±‚äºŒçº§ç¼“å­˜ä½œç”¨ï¼Œä¸”åªæ”¯æŒå°å¯¹è±¡å†…å­˜åˆ†é…ã€‚è€ŒPageHeapåˆ™æ˜¯é’ˆå¯¹CentralCacheçš„ä¸‰çº§ç¼“å­˜,å¼¥è¡¥å¯¹äºä¸­å¯¹è±¡å†…å­˜å’Œå¤§å¯¹è±¡å†…å­˜çš„åˆ†é…ï¼ŒPageHeapä¹Ÿæ˜¯ç›´æ¥å’Œæ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜è¡”æ¥çš„ä¸€å±‚ç¼“å­˜ã€‚ å½“ä¸€äºŒçº§ç¼“å­˜éƒ½æ— æ³•åˆ†é…å¯¹åº”çš„å†…å­˜æ—¶ï¼Œä¸‰æ¬¡ç¼“å­˜åˆ™é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥ä»è™šæ‹Ÿå†…å­˜çš„å †åŒºä¸­è·å–å†…å­˜æ¥å¡«å……ã€‚ PageHeapå†…éƒ¨çš„Spanç®¡ç†é‡‡å–ä¸¤ç§æ–¹å¼ 128ä¸ªpageä»¥å†…ä½¿ç”¨é“¾è¡¨ 128ä»¥ä¸Šçš„pageåˆ™é€šè¿‡æœ‰åºé›†åˆæ¥å­˜æ”¾ å°å¯¹è±¡åˆ†é… ï¼ˆ1ï¼‰Thread ç”¨æˆ·çº¿ç¨‹åº”ç”¨é€»è¾‘ç”³è¯·å†…å­˜ï¼Œå½“å‰ Thread è®¿é—®å¯¹åº”çš„ ThreadCache è·å–å†…å­˜ï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦åŠ é”ã€‚ ï¼ˆ2ï¼‰ThreadCache çš„å¾—åˆ°ç”³è¯·å†…å­˜çš„ SizeClassï¼ˆä¸€èˆ¬å‘ä¸Šå–æ•´ï¼Œå¤§äºç­‰äºç”³è¯·çš„å†…å­˜å¤§å°ï¼‰ï¼Œé€šè¿‡ SizeClass ç´¢å¼•å»è¯·æ±‚è‡ªèº«å¯¹åº”çš„ FreeListã€‚ ï¼ˆ3ï¼‰åˆ¤æ–­å¾—åˆ°çš„ FreeList æ˜¯å¦ä¸ºéç©ºã€‚ ï¼ˆ4ï¼‰å¦‚æœ FreeList éç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æœ‰å¯¹åº”å†…å­˜ç©ºé—´ä¾› Thread ä½¿ç”¨ï¼Œå¾—åˆ° FreeList ç¬¬ä¸€ä¸ªç©ºé—² Span è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼Œæµç¨‹ç»“æŸã€‚ ï¼ˆ5ï¼‰å¦‚æœ FreeList ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æ²¡æœ‰å¯¹åº” SizeClass çš„ç©ºé—² Span å¯ä½¿ç”¨ï¼Œè¯·æ±‚ CentralCache å¹¶å‘ŠçŸ¥ CentralCache å…·ä½“çš„ SizeClassã€‚ ï¼ˆ6ï¼‰CentralCache æ”¶åˆ°è¯·æ±‚åï¼ŒåŠ é”è®¿é—® CentralFreeListï¼Œæ ¹æ® SizeClass è¿›è¡Œç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„ CentralFreeListã€‚ ï¼ˆ7ï¼‰åˆ¤æ–­å¾—åˆ°çš„ CentralFreeList æ˜¯å¦ä¸ºéç©ºã€‚ ï¼ˆ8ï¼‰å¦‚æœ CentralFreeList éç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æœ‰ç©ºé—²çš„ Span å¯ä½¿ç”¨ã€‚è¿”å›å¤šä¸ª Spanï¼Œå°†è¿™äº› Spanï¼ˆé™¤äº†ç¬¬ä¸€ä¸ª Spanï¼‰æ”¾ç½® ThreadCache çš„ FreeList ä¸­ï¼Œå¹¶ä¸”å°†ç¬¬ä¸€ä¸ª Span è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼Œæµç¨‹ç»“æŸã€‚ ï¼ˆ9ï¼‰å¦‚æœ CentralFreeList ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºç›®å‰æ²¡æœ‰å¯ç”¨æ˜¯ Span å¯ä½¿ç”¨ï¼Œå‘ PageHeap ç”³è¯·å¯¹åº”å¤§å°çš„ Spanã€‚ ï¼ˆ10ï¼‰PageHeap å¾—åˆ° CentralCache çš„ç”³è¯·ï¼ŒåŠ é”è¯·æ±‚å¯¹åº”çš„ Page åˆ»åº¦çš„ Span é“¾è¡¨ã€‚ ï¼ˆ11ï¼‰PageHeap å°†å¾—åˆ°çš„ Span æ ¹æ®æœ¬æ¬¡æµç¨‹è¯·æ±‚çš„ SizeClass å¤§å°ä¸ºåˆ»åº¦è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†æˆ N ä»½ SizeClass å¤§å°çš„ Span è¿”å›ç»™ CentralCacheï¼Œå¦‚æœæœ‰å¤šä½™çš„ Span åˆ™æ”¾å› PageHeap å¯¹åº” Page çš„ Span é“¾è¡¨ä¸­ã€‚ ï¼ˆ12ï¼‰CentralCache å¾—åˆ°å¯¹åº”çš„ N ä¸ª Spanï¼Œæ·»åŠ è‡³ CentralFreeList ä¸­ï¼Œè·³è½¬è‡³ç¬¬ï¼ˆ8ï¼‰æ­¥ã€‚ ä¸­å¯¹è±¡åˆ†é… ä¸­å¯¹è±¡æ˜¯åœ¨256KB-1Mä¹‹é—´çš„å†…å­˜ã€‚TCMallocä¼šç›´æ¥ä»Pageheapè·å–ã€‚ PageHeapå°†128ä¸ªPageä»¥å†…å¤§å°çš„Spanå®šä¹‰ä¸ºå°Spanï¼Œå°†128ä¸ªPageä»¥ä¸Šå¤§å°çš„Spanå®šä¹‰ä¸ºå¤§Spanã€‚ æ‰€ä»¥ä¸­å¯¹è±¡åˆ’åˆ†ä¸ºå°spanè¿›è¡Œåˆ†é…ã€‚ ï¼ˆ1ï¼‰Thread ç”¨æˆ·é€»è¾‘å±‚æäº¤å†…å­˜ç”³è¯·å¤„ç†ï¼Œå¦‚æœæœ¬æ¬¡ç”³è¯·å†…å­˜è¶…è¿‡ 256KB ä½†ä¸è¶…è¿‡ 1MB åˆ™å±äºä¸­å¯¹è±¡ç”³è¯·ã€‚TCMalloc å°†ç›´æ¥å‘ PageHeap å‘èµ·ç”³è¯· Span è¯·æ±‚ã€‚ ï¼ˆ2ï¼‰PageHeap æ¥æ”¶åˆ°ç”³è¯·åéœ€è¦åˆ¤æ–­æœ¬æ¬¡ç”³è¯·æ˜¯å¦å±äºå° Spanï¼ˆ128 ä¸ª Page ä»¥å†…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™èµ°å° Spanï¼Œå³ä¸­å¯¹è±¡ç”³è¯·æµç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚ ï¼ˆ3ï¼‰PageHeap æ ¹æ®ç”³è¯·çš„ Span åœ¨å° Span çš„é“¾è¡¨ä¸­å‘ä¸Šå–æ•´ï¼Œå¾—åˆ°æœ€é€‚åº”çš„ç¬¬ K ä¸ª Page åˆ»åº¦çš„ Span é“¾è¡¨ã€‚ ï¼ˆ4ï¼‰å¾—åˆ°ç¬¬ K ä¸ª Page é“¾è¡¨åˆ»åº¦åï¼Œå°† K ä½œä¸ºèµ·å§‹ç‚¹ï¼Œå‘ä¸‹éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºé“¾è¡¨ï¼Œç›´è‡³ 128 ä¸ª Page åˆ»åº¦ä½ç½®ï¼Œæ‰¾åˆ°åˆ™åœæ­¢ï¼Œå°†åœæ­¢å¤„çš„éç©º Span é“¾è¡¨ä½œä¸ºæä¾›æ­¤æ¬¡è¿”å›çš„å†…å­˜ Spanï¼Œå°†é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª Span å–å‡ºã€‚å¦‚æœæ‰¾ä¸åˆ°éç©ºé“¾è¡¨ï¼Œåˆ™å½“é”™æœ¬æ¬¡ç”³è¯·ä¸ºå¤§ Span ç”³è¯·ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ã€‚ ï¼ˆ5ï¼‰å‡è®¾æœ¬æ¬¡è·å–åˆ°çš„ Span ç”± N ä¸ª Page ç»„æˆã€‚PageHeap å°† N ä¸ª Page çš„ Span æ‹†åˆ†æˆä¸¤ä¸ª Spanï¼Œå…¶ä¸­ä¸€ä¸ªä¸º K ä¸ª Page ç»„æˆçš„ Spanï¼Œä½œä¸ºæœ¬æ¬¡å†…å­˜ç”³è¯·çš„è¿”å›ï¼Œç»™åˆ° Threadï¼Œå¦ä¸€ä¸ªä¸º N-K ä¸ª Page ç»„æˆçš„ Spanï¼Œé‡æ–°æ’å…¥åˆ° N-K ä¸ª Page å¯¹åº”çš„ Span é“¾è¡¨ä¸­ã€‚ å¤§å¯¹è±¡åˆ†é… å¯¹äºè¶…è¿‡ 128 ä¸ª Pageï¼ˆå³ 1MBï¼‰çš„å†…å­˜åˆ†é…åˆ™ä¸ºå¤§å¯¹è±¡åˆ†é…æµç¨‹ã€‚å¤§å¯¹è±¡åˆ†é…ä¸ä¸­å¯¹è±¡åˆ†é…æƒ…å†µç±»ä¼¼ï¼ŒThread ç»•è¿‡ ThreadCache å’Œ CentralCacheï¼Œç›´æ¥å‘ PageHeap è·å– è¿›å…¥å¤§å¯¹è±¡åˆ†é…æµç¨‹é™¤äº†ç”³è¯·çš„ Span å¤§äº 128 ä¸ª Page ä¹‹å¤–ï¼Œå¯¹äºä¸­å¯¹è±¡åˆ†é…å¦‚æœæ‰¾ä¸åˆ°éç©ºé“¾è¡¨ä¹Ÿä¼šè¿›å…¥å¤§å¯¹è±¡åˆ†é…æµç¨‹ ï¼ˆ1ï¼‰Thread ç”¨æˆ·é€»è¾‘å±‚æäº¤å†…å­˜ç”³è¯·å¤„ç†ï¼Œå¦‚æœæœ¬æ¬¡ç”³è¯·å†…å­˜è¶…è¿‡ 1MB åˆ™å±äºå¤§å¯¹è±¡ç”³è¯·ã€‚TCMalloc å°†ç›´æ¥å‘ PageHeap å‘èµ·ç”³è¯· Span ã€‚ ï¼ˆ2ï¼‰PageHeap æ¥æ”¶åˆ°ç”³è¯·åéœ€è¦åˆ¤æ–­æœ¬æ¬¡ç”³è¯·æ˜¯å¦å±äºå° Spanï¼ˆ128 ä¸ª Page ä»¥å†…ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™èµ°å° Span ä¸­å¯¹è±¡ç”³è¯·æµç¨‹ï¼ˆä¸Šä¸€èŠ‚å·²ä»‹ç»ï¼‰ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¿›å…¥å¤§å¯¹è±¡ç”³è¯·æµç¨‹ ï¼ˆ3ï¼‰PageHeapæ ¹æ®Spançš„å¤§å°æŒ‰ç…§Pageå•å…ƒè¿›è¡Œé™¤æ³•è¿ç®—ï¼Œå‘ä¸Šå–æ•´ï¼Œå¾—åˆ°æœ€æ¥è¿‘Spançš„ä¸”å¤§äºSpançš„Pageå€æ•°K,æ­¤æ—¶çš„Kåº”è¯¥æ˜¯å¤§äº128ã€‚å¦‚æœæ˜¯ä»ä¸­å¯¹è±¡æµç¨‹åˆ†è¿‡æ¥çš„ï¼ˆä¸­å¯¹è±¡ç”³è¯·æµç¨‹å¯èƒ½æ²¡æœ‰éç©ºé“¾è¡¨æä¾›Span),åˆ™Kå€¼åº”è¯¥å°äº128ã€‚ ï¼ˆ4ï¼‰æœç´¢ Large Span Set é›†åˆï¼Œæ‰¾åˆ°ä¸å°äº K ä¸ª Page çš„æœ€å° Spanï¼ˆN ä¸ª Pageï¼‰ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ Spanï¼Œåˆ™è¯´æ˜ PageHeap å·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œåˆ™å‘æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜çš„å †ç©ºé—´ç”³è¯·ä¸€å †å†…å­˜ï¼Œå°†ç”³è¯·åˆ°çš„å†…å­˜å®‰ç½®åœ¨ PageHeap çš„å†…å­˜ç»“æ„ä¸­ï¼Œé‡æ–°æ‰§è¡Œï¼ˆ3ï¼‰æ­¥éª¤ ï¼ˆ5ï¼‰å°†ä» Large Span Set é›†åˆå¾—åˆ°çš„ N ä¸ª Page ç»„æˆçš„ Span æ‹†åˆ†æˆä¸¤ä¸ª Spanï¼ŒK ä¸ª Page çš„ Span ç›´æ¥è¿”å›ç»™ Thread ç”¨æˆ·é€»è¾‘ï¼ŒN-K ä¸ª Span é€€è¿˜ç»™ PageHeapã€‚å…¶ä¸­å¦‚æœ N","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go å †å†…å­˜ç®¡ç† å±‚çº§æ¨¡å‹ ç»“æ„æ¨¡å‹ Golang å†…å­˜ç®¡ç†ä¸­ä¾ç„¶ä¿ç•™ TCMalloc ä¸­çš„ Pageã€Spanã€Size Class ç­‰æ¦‚å¿µ Page ä¸ TCMalloc çš„ Page ä¸€è‡´ã€‚Golang å†…å­˜ç®¡ç†æ¨¡å‹å»¶ç»­äº† TCMalloc çš„æ¦‚å¿µï¼Œä¸€ä¸ª Page çš„å¤§å°ä¾ç„¶æ˜¯ 8KBã€‚Page è¡¨ç¤º Golang å†…å­˜ç®¡ç†ä¸è™šæ‹Ÿå†…å­˜äº¤äº’å†…å­˜çš„æœ€å°å•å…ƒã€‚æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜å¯¹äº Golang æ¥è¯´ï¼Œä¾ç„¶æ˜¯åˆ’åˆ†æˆç­‰åˆ†çš„ N ä¸ª Page ç»„æˆçš„ä¸€å—å¤§å†…å­˜å…¬å…±æ±  mSpan TCMallocä¸­çš„Spanä¸€è‡´ã€‚mSpanæ¦‚å¿µä¾ç„¶å»¶ç»­TCMallocä¸­çš„Spanæ¦‚å¿µï¼Œåœ¨Golangä¸­å°†Spançš„åç§°æ”¹ä¸ºmSpanï¼Œä¾ç„¶è¡¨ç¤ºä¸€ç»„è¿ç»­çš„Pageã€‚ Size Classç›¸å…³ Object Size æŒ‡åç¨‹åº”ç”¨é€»è¾‘ä¸€æ¬¡å‘Golangå†…å­˜ç”³è¯·çš„å¯¹è±¡Objectå¤§å°ã€‚ Objectæ—¶Goå†…å­˜ç®¡ç†æ¨¡å—æ›´ç»†åŒ–çš„ç®¡ç†å•å…ƒã€‚ä¸€ä¸ªspanåœ¨åˆå§‹åŒ–æ—¶ä¼šè¢«åˆ†ä¸ºå¤šä¸ªObjectã€‚é€»è¾‘å±‚å‘Goå†…å­˜æ¨¡å‹å–å†…å­˜å®é™…æ˜¯è·å–Objectã€‚ æ³¨æ„ Pageæ˜¯Golangå†…å­˜ç®¡ç†ä¸æ“ä½œç³»ç»Ÿäº¤äº’è¡¡é‡å†…å­˜å®¹é‡çš„åŸºæœ¬å•å…ƒï¼ŒGolangå†…å­˜ç®¡ç†å†…éƒ¨æœ¬èº«ç”¨æ¥ç»™å¯¹è±¡å­˜å‚¨å†…å­˜çš„åŸºæœ¬å•å…ƒæ˜¯Objectã€‚ Size Clase Golangå†…å­˜ç®¡ç†ä¸­çš„Size Classä¸TCMallocæ‰€è¡¨ç¤ºçš„è®¾è®¡å«ä¹‰æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¡¨ç¤ºä¸€å—å†…å­˜çš„æ‰€å±è§„æ ¼æˆ–è€…åˆ»åº¦ã€‚Golangå†…å­˜ç®¡ç†ä¸­çš„Size Classæ˜¯é’ˆå¯¹Object Sizeæ¥åˆ’åˆ†å†…å­˜çš„ã€‚ä¹Ÿæ˜¯åˆ’åˆ†Objectå¤§å°çš„çº§åˆ«ã€‚æ¯”å¦‚Object Sizeåœ¨1Byte~8Byteä¹‹é—´çš„Objectå±äºSize Class 1çº§åˆ«ï¼ŒObject Size åœ¨8B~16Byteä¹‹é—´çš„å±äºSize Class 2çº§åˆ«ã€‚ Span Class è¿™ä¸ªæ˜¯ Golang å†…å­˜ç®¡ç†é¢å¤–å®šä¹‰çš„è§„æ ¼å±æ€§ï¼Œæ˜¯é’ˆå¯¹ Span æ¥è¿›è¡Œåˆ’åˆ†çš„ï¼Œæ˜¯ Span å¤§å°çš„çº§åˆ«ã€‚ä¸€ä¸ª Size Class ä¼šå¯¹åº”ä¸¤ä¸ª Span Classï¼Œå…¶ä¸­ä¸€ä¸ª Span ä¸ºå­˜æ”¾éœ€è¦ GC æ‰«æçš„å¯¹è±¡ï¼ˆåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ï¼Œå¦ä¸€ä¸ª Span ä¸ºå­˜æ”¾ä¸éœ€è¦ GC æ‰«æçš„å¯¹è±¡ï¼ˆä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ Size Classæ˜ç»† //usr/local/go/src/runtime/sizeclasses.go package runtime // æ ‡é¢˜Titleè§£é‡Šï¼š // [class]: Size Class // [bytes/obj]: Object Sizeï¼Œä¸€æ¬¡å¯¹å¤–æä¾›å†…å­˜Objectçš„å¤§å° // [bytes/span]: å½“å‰Objectæ‰€å¯¹åº”Spançš„å†…å­˜å¤§å° // [objects]: å½“å‰Spanä¸€å…±æœ‰å¤šå°‘ä¸ªObject // [tail wastre]: ä¸ºå½“å‰Spanå¹³å‡åˆ†å±‚Nä»½Objectï¼Œä¼šæœ‰å¤šå°‘å†…å­˜æµªè´¹ // [max waste]: å½“å‰Size Classæœ€å¤§å¯èƒ½æµªè´¹çš„ç©ºé—´æ‰€å ç™¾åˆ†æ¯” // class bytes/obj bytes/span objects tail waste max waste // 1 8 8192 1024 0 87.50% // 2 16 8192 512 0 43.75% // 3 32 8192 256 0 46.88% // 4 48 8192 170 32 31.52% // 5 64 8192 128 0 23.44% // 6 80 8192 102 32 19.07% // 7 96 8192 85 32 15.95% // 8 112 8192 73 16 13.56% ... MCache ç±»ä¼¼äºTCMallocçš„ThreadCacheï¼Œåç¨‹è®¿é—®ä¸éœ€è¦åŠ é”ã€‚ MCacheç»‘å®šåœ¨å¤„ç†å™¨Pä¸­ï¼Œå› ä¸ºå®é™…å¯è¿è¡Œçš„Mæ•°é‡å’ŒPç›¸åŒã€‚ MCache ä¸­æ¯ä¸ª Span Class éƒ½ä¼šå¯¹åº”ä¸€ä¸ª MSpanï¼Œä¸åŒ Span Class çš„ MSpan çš„æ€»ä½“é•¿åº¦ä¸åŒï¼Œå‚è€ƒ runtime/sizeclasses.go çš„æ ‡å‡†è§„å®šåˆ’åˆ†ã€‚æ¯”å¦‚å¯¹äº Span Class ä¸º 4 çš„ MSpan æ¥è¯´ï¼Œå­˜æ”¾å†…å­˜å¤§å°ä¸º 1Pageï¼Œå³ 8KBã€‚æ¯ä¸ªå¯¹å¤–æä¾›çš„ Object å¤§å°ä¸º 16Bï¼Œå…±å­˜æ”¾ 512 ä¸ª Objectã€‚å…¶ä»– Span Class çš„å­˜æ”¾æ–¹å¼ç±»ä¼¼ã€‚å½“å…¶ä¸­æŸä¸ª Span Class çš„ MSpan å·²ç»æ²¡æœ‰å¯æä¾›çš„ Object æ—¶ï¼ŒMCache åˆ™ä¼šå‘ MCentral ç”³è¯·ä¸€ä¸ªå¯¹åº”çš„ MSpanã€‚ æ³¨ï¼šç”³è¯·sizeæ—¶æ˜¯0åˆ™è¿”å›å›ºå®šåœ°å€ã€‚ MCentral å½“ MCache ä¸­æŸä¸ª Size Class å¯¹åº”çš„ Span è¢«ä¸€æ¬¡æ¬¡ Object è¢«ä¸Šå±‚å–èµ°åï¼Œå¦‚æœå‡ºç°å½“å‰ Size Class çš„ Span ç©ºç¼ºæƒ…å†µï¼ŒMCache åˆ™ä¼šå‘ MCentral ç”³è¯·å¯¹åº”çš„ Spanã€‚ å’ŒTCMallocç±»ä¼¼ï¼Œæœ¬å±‚çš„spanå–å®Œä¹‹åå‘ä¸Šä¸€å±‚è¯·æ±‚ã€‚ å…¶ä¸­åç¨‹é€»è¾‘å±‚ä¸MCacheçš„å†…å­˜äº¤æ¢å•ä½æ˜¯Objectï¼ŒMCacheä¸MCentralçš„å†…å­˜äº¤æ¢å•ä½æ˜¯Spanï¼Œè€ŒMCentralä¸MHeapçš„å†…å­˜äº¤æ¢å•ä½æ˜¯Pageã€‚ MCentral ä¸ TCMalloc ä¸­çš„ Central ä¸åŒçš„æ˜¯ MCentral é’ˆå¯¹æ¯ä¸ª Span Class çº§åˆ«æœ‰ä¸¤ä¸ª Span é“¾è¡¨ï¼Œè€Œ TCMalloc ä¸­çš„ Central åªæœ‰ä¸€ä¸ªã€‚ MCentralä¸MCacheä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº§åˆ«ä¿å­˜çš„ä¸æ˜¯ä¸€ä¸ªSpanï¼Œè€Œæ˜¯ä¸€ä¸ªSpan Listé“¾è¡¨ã€‚ä¸TCMallocä¸­çš„Centralä¸åŒçš„æ˜¯ï¼ŒMCentralæ¯ä¸ªçº§åˆ«éƒ½ä¿å­˜äº†ä¸¤ä¸ªSpan Listã€‚ æ³¨æ„ å›¾ 38 ä¸­ MCentral æ˜¯è¡¨ç¤ºä¸€å±‚æŠ½è±¡çš„æ¦‚å¿µï¼Œå®é™…ä¸Šæ¯ä¸ª Span Class å¯¹åº”çš„å†…å­˜æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª mcentralï¼Œå³åœ¨ MCentral è¿™å±‚æ•°æ®ç®¡ç†ä¸­ï¼Œå®é™…ä¸Šæœ‰ Span Class ä¸ª mcentral å°å†…å­˜ç®¡ç†å•å…ƒã€‚ 1ï¼‰NonEmpty Span Listï¼ˆéç©ºï¼Œé€€è¿˜çš„spanæ”¾é‡Œé¢ï¼‰ è¡¨ç¤ºè¿˜æœ‰å¯ç”¨ç©ºé—´çš„ Span é“¾è¡¨ã€‚é“¾è¡¨ä¸­çš„æ‰€æœ‰ Span éƒ½è‡³å°‘æœ‰ 1 ä¸ªç©ºé—²çš„ Object ç©ºé—´ã€‚å¦‚æœ MCentral ä¸Šæ¸¸ MCache é€€è¿˜ Spanï¼Œä¼šå°†é€€è¿˜çš„ Span åŠ å…¥åˆ° NonEmpty Span List é“¾è¡¨ä¸­ã€‚ 2ï¼‰Empty Span Listï¼ˆå¯èƒ½ä¸ºç©ºï¼Œåˆ†é…çš„spanæ”¾è¿™é‡Œï¼‰ è¡¨ç¤ºæ²¡æœ‰å¯ç”¨ç©ºé—´çš„ Span é“¾è¡¨ã€‚è¯¥é“¾è¡¨ä¸Šçš„ Span éƒ½ä¸ç¡®å®šå¦è¿˜æœ‰æœ‰ç©ºé—²çš„ Object ç©ºé—´ã€‚å¦‚æœ MCentral æä¾›ç»™ä¸€ä¸ª Span ç»™åˆ°ä¸Šæ¸¸ MCacheï¼Œé‚£ä¹ˆè¢«æä¾›çš„ Span å°±ä¼šåŠ å…¥åˆ° Empty List é“¾è¡¨ä¸­ã€‚ æ³¨æ„ åœ¨ Golang 1.16 ç‰ˆæœ¬ä¹‹åï¼ŒMCentral ä¸­çš„ NonEmpty Span List å’Œ Empty Span List å‡ç”±é“¾è¡¨ç®¡ç†æ”¹æˆé›†åˆç®¡ç†ï¼Œåˆ†åˆ«å¯¹åº” Partial Span Set å’Œ Full Span Setã€‚è™½ç„¶å­˜å‚¨çš„æ•°æ®ç»“æ„æœ‰å˜åŒ–ï¼Œä½†æ˜¯åŸºæœ¬çš„ä½œç”¨å’ŒèŒè´£æ²¡æœ‰åŒºåˆ«ã€‚ // Go V1.14 //usr/local/go/src/runtime/mcentral.go // Central list of free objects of a given size. // go:notinheap type mcentral struct { lock mutex //ç”³è¯·MCentralå†…å­˜åˆ†é…æ—¶éœ€è¦åŠ çš„é” spanclass spanClass //å½“å‰å“ªä¸ªSize Classçº§åˆ«çš„ // list of spans with a free object, ie a nonempty free list // è¿˜æœ‰å¯ç”¨ç©ºé—´çš„Span é“¾è¡¨ nonempty mSpanList // list of spans with no free objects (or cached in an mcache) // æ²¡æœ‰å¯ç”¨ç©ºé—´çš„Spané“¾è¡¨ï¼Œæˆ–è€…å½“å‰é“¾è¡¨é‡Œçš„Spanå·²ç»äº¤ç»™mcache empty mSpanList // nmalloc is the cumulative count of objects allocated from // this mcentral, assuming all spans in mcaches are // fully-allocated. Written atomically, read under STW. // nmallocæ˜¯ä»è¯¥mcentralåˆ†é…çš„å¯¹è±¡çš„ç´¯ç§¯è®¡æ•° // å‡è®¾mcachesä¸­çš„æ‰€æœ‰è·¨åº¦éƒ½å·²å®Œå…¨åˆ†é…ã€‚ // ä»¥åŸå­æ–¹å¼ä¹¦å†™ï¼Œåœ¨STWä¸‹é˜…è¯»ã€‚ nmalloc uint64 } //Go V1.16+ //usr/local/go/src/runtime/mcentral.go //â€¦ type mcentral struct { // mcentralå¯¹åº”çš„spanClass spanclass spanClass partial [2]spanSet // ç»´æŠ¤å…¨éƒ¨ç©ºé—²çš„Spané›†åˆ full [2]spanSet // ç»´æŠ¤å­˜åœ¨éç©ºé—²çš„Spané›†åˆ } //â€¦ æ³¨ï¼šåˆ†ä¸ºä¸¤ä¸ªé›†åˆå…ƒç´ çš„æ•°ç»„æ˜¯ä¸ºäº†GCï¼Œä¸€ä¸ªé›†åˆæ˜¯å·²æ‰«æï¼Œä¸€ä¸ªæ˜¯æœªæ‰«æ MHeap Golang å†…å­˜ç®¡ç†çš„ MHeap ä¾ç„¶æ˜¯ç»§æ‰¿ TCMalloc çš„ PageHeap è®¾è®¡ MHeap æ˜¯å¯¹å†…å­˜å—çš„ç®¡ç†å¯¹è±¡ï¼Œæ˜¯é€šè¿‡ Page ä¸ºå†…å­˜å•å…ƒè¿›è¡Œç®¡ç†,ä¸€ç³»åˆ—çš„Pageè¢«ç§°ä¸ºä¸€ä¸ªHeapArena ä¸€ä¸ªHeapArenaå ç”¨64MBï¼Œå…¶ä¸­æ˜¯å¤šä¸ªmspanï¼Œå¤šä¸ªè¿","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go æ ˆå†…å­˜ç®¡ç† æ ˆåŒºçš„å†…å­˜ä¸€èˆ¬ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾ï¼Œå…¶ä¸­å­˜å‚¨ç€å‡½æ•°çš„å…¥å‚ä»¥åŠå±€éƒ¨å˜é‡ï¼Œè¿™äº›å‚æ•°ä¼šéšç€å‡½æ•°çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œå‡½æ•°çš„è¿”å›è€Œæ¶ˆäº¡ï¼Œä¸€èˆ¬ä¸ä¼šåœ¨ç¨‹åºä¸­é•¿æœŸå­˜åœ¨ï¼Œè¿™ç§çº¿æ€§çš„å†…å­˜åˆ†é…ç­–ç•¥æœ‰ç€æé«˜åœ°æ•ˆç‡ã€‚ å¯„å­˜å™¨ å¯„å­˜å™¨ æ˜¯CPUä¸­æœ€å—çš„å­˜å‚¨å•å…ƒï¼Œæ ˆå¯„å­˜å™¨æ˜¯ CPU å¯„å­˜å™¨ä¸­çš„ä¸€ç§ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿè¸ªå‡½æ•°çš„è°ƒç”¨æ ˆã€‚åº”ç”¨ç¨‹åºåœ¨è·å–æ ˆç©ºé—´æ—¶åªéœ€è¦ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆï¼Œéå¸¸é«˜æ•ˆã€‚ é€ƒé€¸åˆ†æ æ‰‹åŠ¨åˆ†é…å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼š ä¸éœ€è¦åˆ†é…åœ¨å †ä¸­çš„å…ƒç´ åˆ†é…åˆ°å †ä¸­ï¼šæµªè´¹ç©ºé—´ï¼Œæ•ˆç‡ä½ åº”è¯¥åˆ†é…åœ¨å †ä¸Šçš„åˆ†é…åˆ°æ ˆä¸Šï¼šæ‚¬æŒ‚æŒ‡é’ˆï¼Œå½±å“å†…å­˜å®‰å…¨ goè¯­è¨€ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å†³å®šæŠŠä¸€ä¸ªå˜é‡æ”¾åœ¨æ ˆè¿˜æ˜¯æ”¾åœ¨å †ï¼Œç¼–è¯‘å™¨ä¼šåšé€ƒé€¸åˆ†æ(escape analysis)ï¼Œå½“å‘ç°å˜é‡çš„ä½œç”¨åŸŸæ²¡æœ‰è·‘å‡ºå‡½æ•°èŒƒå›´ï¼Œå°±å¯ä»¥åœ¨æ ˆä¸Šï¼Œåä¹‹åˆ™å¿…é¡»åˆ†é…åœ¨å †ã€‚ï¼ˆå †ä¸­çš„å˜é‡å¼•ç”¨äº†æ ˆä¸Šçš„å˜é‡ï¼‰ å¯ä»¥åœ¨å‡½æ•°å®šä¹‰æ—¶æ·»åŠ  //go:noinline ç¼–è¯‘æŒ‡ä»¤æ¥é˜»æ­¢ç¼–è¯‘å™¨å†…è”å‡½æ•° é€ƒé€¸è§„åˆ™ ä¸€èˆ¬è€Œè¨€ï¼Œç»™ä¸€ä¸ªå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨ç±»æˆå‘˜è¿›è¡Œèµ‹å€¼å¯èƒ½å‡ºç°é€ƒé€¸ç°è±¡ Goè¯­è¨€ä¸­çš„å¼•ç”¨ç±»å‹æœ‰funcï¼ˆå‡½æ•°ç±»å‹ï¼‰ï¼Œinterfaceï¼ˆæ¥å£ç±»å‹ï¼‰ï¼Œsliceï¼ˆåˆ‡ç‰‡ç±»å‹ï¼‰ï¼Œmapï¼ˆå­—å…¸ç±»å‹ï¼‰ï¼Œchannelï¼ˆç®¡é“ç±»å‹ï¼‰ï¼Œ*ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰ç­‰ã€‚ é€ƒé€¸æ¡ˆä¾‹ // 1. slice ä¸ºå¼•ç”¨ç±»å‹ï¼Œinterface{} ä¸ºå¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥ äºŒæ¬¡è®¿é—® é€ æˆåè€…é€ƒé€¸ data := []interface{}{1,2} data[0] = 2 // 2. map å¼•ç”¨ç±»å‹ï¼Œinterface{} å¼•ç”¨ç±»å‹ï¼Œé€ æˆåè€…é€ƒé€¸ data := make(map[string]interface{}) data[\"key\"] = 200 //3. map å¼•ç”¨ç±»å‹ï¼Œinterface{} å¼•ç”¨ç±»å‹, é€ æˆkvé€ƒé€¸ data := make(map[interface{}]interface{}) data[100] = 200 //4. map å¼•ç”¨, []string å¼•ç”¨ï¼Œé€ æˆåè€…é€ƒé€¸ data := make(map[string][]string) data[\"key\"] = []string{\"value\"} //5. [] å¼•ç”¨ï¼Œ*int å¼•ç”¨ï¼Œåè€…é€ƒé€¸ data := []*int{nil} data[0] = \u0026a // aé€ƒé€¸ //6. func å¼•ç”¨ï¼Œ*int å¼•ç”¨ï¼Œå¯¼è‡´åè€…é€ƒé€¸ data := 10 f := foo f(\u0026data) fmt.Println(data) // dataé€ƒé€¸ //7. func å¼•ç”¨ï¼Œ[]string å¼•ç”¨ï¼Œåè€…é€ƒé€¸ s := []string{\"aceld\"} foo(s) fmt.Println(s) // sé€ƒé€¸ //8. chan å¼•ç”¨ï¼Œ[]string å¼•ç”¨ï¼Œåè€…é€ƒé€¸ ch := make(chan []string) s := []string{\"aceld\"} go func() { ch \u003c- s }() Golang ä¸­ä¸€ä¸ªå‡½æ•°å†…å±€éƒ¨å˜é‡ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯åŠ¨æ€ new å‡ºæ¥çš„ï¼Œå®ƒä¼šè¢«åˆ†é…åœ¨å †è¿˜æ˜¯æ ˆï¼Œæ˜¯ç”±ç¼–è¯‘å™¨åšé€ƒé€¸åˆ†æä¹‹ååšå‡ºçš„å†³å®šã€‚ æ ˆå†…å­˜ç©ºé—´ Go è¯­è¨€ä½¿ç”¨ç”¨æˆ·æ€çº¿ç¨‹ Goroutine ä½œä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå®ƒçš„é¢å¤–å¼€é”€å’Œé»˜è®¤æ ˆå¤§å°éƒ½æ¯”çº¿ç¨‹å°å¾ˆå¤šï¼Œç„¶è€Œ Goroutine çš„æ ˆå†…å­˜ç©ºé—´å’Œæ ˆç»“æ„ä¹Ÿåœ¨æ—©æœŸå‡ ä¸ªç‰ˆæœ¬ä¸­å‘ç”Ÿè¿‡ä¸€äº›å˜åŒ–ï¼š v1.0 ~ v1.1 â€” æœ€å°æ ˆå†…å­˜ç©ºé—´ä¸º 4KBï¼› v1.2 â€” å°†æœ€å°æ ˆå†…å­˜æå‡åˆ°äº† 8KBï¼› v1.3 â€” ä½¿ç”¨è¿ç»­æ ˆ æ›¿æ¢ä¹‹å‰ç‰ˆæœ¬çš„åˆ†æ®µæ ˆï¼› v1.4 â€” å°†æœ€å°æ ˆå†…å­˜é™ä½åˆ°äº† 2KBï¼› ä» 4KB æå‡åˆ° 8KB æ˜¯ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†å‡è½»åˆ†æ®µæ ˆä¸­çš„æ ˆåˆ†è£‚å¯¹ç¨‹åºçš„æ€§èƒ½å½±å“ åˆ†æ®µæ ˆ æ‰€æœ‰Goç¨‹åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ†é…ä¸€å—å›ºå®šå†…å­˜ç©ºé—´ã€‚ å½“ Goroutine è°ƒç”¨çš„å‡½æ•°å±‚çº§æˆ–è€…å±€éƒ¨å˜é‡éœ€è¦çš„è¶Šæ¥è¶Šå¤šæ—¶ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ runtime.morestack:go1.2 å’Œ runtime.newstack:go1.2 åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆç©ºé—´ï¼Œè¿™äº›æ ˆç©ºé—´è™½ç„¶ä¸è¿ç»­ï¼Œä½†æ˜¯å½“å‰ Goroutine çš„å¤šä¸ªæ ˆç©ºé—´ä¼šä»¥é“¾è¡¨çš„å½¢å¼ä¸²è”èµ·æ¥ï¼Œè¿è¡Œæ—¶ä¼šé€šè¿‡æŒ‡é’ˆæ‰¾åˆ°è¿ç»­çš„æ ˆç‰‡æ®µï¼š ä¸€æ—¦ç”³è¯·çš„æ ˆç©ºé—´ä¸éœ€è¦ï¼Œè¿è¡Œæ—¶å°±ä¼šé‡Šæ”¾ã€‚ åˆ†æ®µæ ˆæœºåˆ¶è™½ç„¶èƒ½å¤ŸæŒ‰éœ€ä¸ºå½“å‰ Goroutine åˆ†é…å†…å­˜å¹¶ä¸”åŠæ—¶å‡å°‘å†…å­˜çš„å ç”¨ï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨ä¸¤ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼š å¦‚æœå½“å‰ Goroutine çš„æ ˆå‡ ä¹å……æ»¡ï¼Œé‚£ä¹ˆä»»æ„çš„å‡½æ•°è°ƒç”¨éƒ½ä¼šè§¦å‘æ ˆæ‰©å®¹ï¼Œå½“å‡½æ•°è¿”å›ååˆä¼šè§¦å‘æ ˆçš„æ”¶ç¼©ï¼Œå¦‚æœåœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨å‡½æ•°ï¼Œæ ˆçš„åˆ†é…å’Œé‡Šæ”¾å°±ä¼šé€ æˆå·¨å¤§çš„é¢å¤–å¼€é”€ï¼Œè¿™è¢«ç§°ä¸ºçƒ­åˆ†è£‚é—®é¢˜ï¼ˆHot splitï¼‰ï¼› ä¸€æ—¦ Goroutine ä½¿ç”¨çš„å†…å­˜è¶Šè¿‡äº†åˆ†æ®µæ ˆçš„æ‰©ç¼©å®¹é˜ˆå€¼ï¼Œè¿è¡Œæ—¶ä¼šè§¦å‘æ ˆçš„æ‰©å®¹å’Œç¼©å®¹ï¼Œå¸¦æ¥é¢å¤–çš„å·¥ä½œé‡ï¼› è¿ç»­æ ˆ å…¶æ ¸å¿ƒåŸç†æ˜¯æ¯å½“ç¨‹åºçš„æ ˆç©ºé—´ä¸è¶³æ—¶ï¼Œåˆå§‹åŒ–ä¸€ç‰‡æ›´å¤§çš„æ ˆç©ºé—´å¹¶å°†åŸæ ˆä¸­çš„æ‰€æœ‰å€¼éƒ½è¿ç§»åˆ°æ–°æ ˆä¸­ï¼Œæ–°çš„å±€éƒ¨å˜é‡æˆ–è€…å‡½æ•°è°ƒç”¨å°±æœ‰å……è¶³çš„å†…å­˜ç©ºé—´ã€‚ æ‰©å®¹æ“ä½œï¼š åœ¨å†…å­˜ç©ºé—´ä¸­åˆ†é…æ›´å¤§çš„æ ˆå†…å­˜ç©ºé—´ï¼› å°†æ—§æ ˆä¸­çš„æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°æ–°æ ˆä¸­ï¼› å°†æŒ‡å‘æ—§æ ˆå¯¹åº”å˜é‡çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°æ ˆï¼› æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜åœ¨äºå †ä¸­ï¼Œæ‰€ä»¥æŒ‡å‘æ ˆä¸­å˜é‡çš„æŒ‡é’ˆåªèƒ½åœ¨æ ˆä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒæ•´æ ˆä¸­çš„æ‰€æœ‰å˜é‡å°±å¯ä»¥ä¿è¯å†…å­˜çš„å®‰å…¨äº†ã€‚ é”€æ¯å¹¶å›æ”¶æ—§æ ˆçš„å†…å­˜ç©ºé—´ï¼› å› ä¸ºéœ€è¦æ‹·è´å˜é‡å’Œè°ƒæ•´æŒ‡é’ˆï¼Œè¿ç»­æ ˆå¢åŠ äº†æ ˆæ‰©å®¹æ—¶çš„é¢å¤–å¼€é”€ï¼Œä½†æ˜¯é€šè¿‡åˆç†æ ˆç¼©å®¹æœºåˆ¶å°±èƒ½é¿å…çƒ­åˆ†è£‚å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œåœ¨ GC æœŸé—´å¦‚æœ Goroutine ä½¿ç”¨äº†æ ˆå†…å­˜çš„å››åˆ†ä¹‹ä¸€ï¼Œé‚£å°±å°†å…¶å†…å­˜å‡å°‘ä¸€åŠï¼Œè¿™æ ·åœ¨æ ˆå†…å­˜å‡ ä¹å……æ»¡æ—¶ä¹Ÿåªä¼šæ‰©å®¹ä¸€æ¬¡ï¼Œä¸ä¼šå› ä¸ºå‡½æ•°è°ƒç”¨é¢‘ç¹æ‰©ç¼©å®¹ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go GC åˆ˜ä¸¹å†°yyds Dravenä¹Ÿæ˜¯ åƒåœ¾å›æ”¶(Garbage Collectionï¼Œç®€ç§°GC)æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­æä¾›çš„è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡ï¼Œè®©å‡ºå­˜å‚¨å™¨èµ„æºï¼Œæ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨æ‰§è¡Œã€‚ Golangä¸­çš„åƒåœ¾å›æ”¶ä¸»è¦åº”ç”¨ä¸‰è‰²æ ‡è®°æ³•ï¼ŒGCè¿‡ç¨‹å’Œå…¶ä»–ç”¨æˆ·goroutineå¯å¹¶å‘è¿è¡Œï¼Œä½†éœ€è¦ä¸€å®šæ—¶é—´çš„STW(stop the world)ï¼ŒSTWçš„è¿‡ç¨‹ä¸­ï¼ŒCPUä¸æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå…¨éƒ¨ç”¨äºåƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å½±å“å¾ˆå¤§ï¼ŒGolangè¿›è¡Œäº†å¤šæ¬¡çš„è¿­ä»£ä¼˜åŒ–æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ GCå›æ”¶çš„æ˜¯ä»€ä¹ˆï¼Ÿ åœ¨åº”ç”¨ç¨‹åºä¸­ä¼šä½¿ç”¨åˆ°ä¸¤ç§å†…å­˜ï¼Œåˆ†åˆ«ä¸ºå †ï¼ˆHeapï¼‰å’Œæ ˆï¼ˆStackï¼‰ï¼ŒGCè´Ÿè´£å›æ”¶å †å†…å­˜ï¼Œè€Œä¸è´Ÿè´£å›æ”¶æ ˆä¸­çš„å†…å­˜ã€‚ ä¸»è¦åŸå› æ˜¯æ ˆæ˜¯ä¸€å—ä¸“ç”¨å†…å­˜ï¼Œä¸“é—¨ä¸ºäº†å‡½æ•°æ‰§è¡Œè€Œå‡†å¤‡çš„ï¼Œå­˜å‚¨ç€å‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡ä»¥åŠè°ƒç”¨æ ˆã€‚é™¤æ­¤ä»¥å¤–ï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹â€”ç®€å•ã€‚æ¯”å¦‚å±€éƒ¨å˜é‡ä¸èƒ½è¢«å‡½æ•°å¤–è®¿é—®ï¼Œæ‰€ä»¥è¿™å—å†…å­˜ç”¨å®Œå°±å¯ä»¥ç›´æ¥é‡Šæ”¾ã€‚ GCç®—æ³•çš„ç§ç±» ä¸»æµçš„åƒåœ¾å›æ”¶ç®—æ³•æœ‰ä¸¤å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯è¿½è¸ªå¼åƒåœ¾å›æ”¶ç®—æ³•å’Œå¼•ç”¨è®¡æ•°æ³•ã€‚è€ŒGoè¯­è¨€ç°åœ¨ç”¨çš„ä¸‰è‰²æ ‡è®°æ³•å°±å±äºè¿½è¸ªå¼åƒåœ¾å›æ”¶ç®—æ³•çš„ä¸€ç§ã€‚ Goåƒåœ¾å›æ”¶ç®—æ³• Goçš„åƒåœ¾æ”¶é›†å™¨ä»ä¸€å¼€å§‹åˆ°ç°åœ¨ä¸€ç›´åœ¨æ¼”è¿›ï¼Œåœ¨v1.5ç‰ˆæœ¬å¼€å§‹ä¸‰è‰²æ ‡è®°æ³•ä½œä¸ºåƒåœ¾å›æ”¶ç®—æ³•å‰ä½¿ç”¨Mark-And-Sweepï¼ˆæ ‡è®°æ¸…é™¤ï¼‰ç®—æ³•ã€‚ä»v1.5ç‰ˆæœ¬Goå®ç°äº†åŸºäºä¸‰è‰²æ ‡è®°æ¸…é™¤çš„å¹¶å‘åƒåœ¾æ”¶é›†å™¨ï¼Œå¤§å¹…åº¦é™ä½åƒåœ¾æ”¶é›†çš„å»¶è¿Ÿä»å‡ ç™¾ ms é™ä½è‡³ 10ms ä»¥ä¸‹ã€‚åœ¨v1.8åˆä½¿ç”¨æ··åˆå†™å±éšœå°†åƒåœ¾æ”¶é›†çš„æ—¶é—´ç¼©çŸ­è‡³ 0.5ms ä»¥å†…ã€‚ GCè§¦å‘æ—¶æœº å†…å­˜è¾¾åˆ°ä¸Šé™æˆ–å†…å­˜æ‰©å¤§ä¸€å€ å®šæœŸåˆ é™¤ æ‰‹åŠ¨è§¦å‘ Go1.3 æ ‡è®°-æ¸…é™¤ æ ‡è®°ï¼šä»æ ¹å¯¹è±¡å‡ºå‘æŸ¥æ‰¾å¹¶æ ‡è®°å †ä¸­å­˜æ´»çš„å¯¹è±¡ã€‚ æš‚åœç¨‹åºï¼Œåˆ†ç±»å‡ºå¯è¾¾å’Œä¸å¯è¾¾çš„å¯¹è±¡ï¼Œç„¶ååšæ ‡è®° ç¨‹åºæ‰¾å‡ºå·¦å³å¯è¾¾çš„å¯¹è±¡å¹¶åšæ ‡è®°ã€‚ æ¸…é™¤ï¼šéå†å †ä¸­æ‰€æœ‰æœªæ ‡è®°çš„å¯¹è±¡ï¼Œå›æ”¶æœªè¢«æ ‡è®°çš„åƒåœ¾å¯¹è±¡çš„å†…å­˜ã€‚ ç¼ºç‚¹ å…¨ç¨‹STWï¼Œç¨‹åºå¡é¡¿ æ ‡è®°éœ€è¦æ‰«ææ•´ä¸ªå † æ¸…é™¤æ•°æ®ä¼šäº§ç”Ÿç¢ç‰‡ æµç¨‹ï¼š Go1.5 ä¸‰è‰²å¹¶å‘æ ‡è®°æ³• ä¸‰è‰²ï¼Ÿ ç™½è‰²ï¼šæ–°åˆ›å»ºçš„å¯¹è±¡é»˜è®¤ä¸ºç™½è‰²ï¼ˆæœªè¢«æ‰«æï¼‰ ç°è‰²ï¼šæ´»è·ƒå¯¹è±¡ï¼Œå¼•ç”¨çš„å…¶ä»–å¯¹è±¡ä¼šè¢«æ‰«æï¼ˆæ´»è·ƒå¯¹è±¡ï¼Œå­˜åœ¨å¤–éƒ¨å¼•ç”¨èŠ‚ç‚¹ï¼‰ é»‘è‰²ï¼šæ´»è·ƒå¯¹è±¡ï¼Œæœ¬è½®æ‰«æä¸­ä¸ä¼šè¢«æ¸…é™¤ï¼ˆæ´»è·ƒå¯¹è±¡ï¼‰ æ™®é€šä¸‰è‰²å¹¶å‘æ ‡è®°æµç¨‹ GCå¼€å§‹æ—¶ä¼šä»æ ¹èŠ‚ç‚¹éå†æ‰€æœ‰å¯¹è±¡ï¼Œæ ‡è®°ä¸ºç°è‰² æŒ‰é¡ºåºéå†ç°è‰²èŠ‚ç‚¹ï¼Œå°†å…¶å¼•ç”¨çš„ç™½è‰²èŠ‚ç‚¹æ ‡è®°ä¸ºç°è‰²ï¼Œæœ€åæ­¤ç°è‰²èŠ‚ç‚¹æ ‡è®°ä¸ºé»‘è‰² é‡å¤æ­¥éª¤2,ç›´åˆ°æ²¡æœ‰ç°è‰²èŠ‚ç‚¹ï¼Œæ¸…é™¤æ‰€æœ‰ç™½è‰²èŠ‚ç‚¹ å› ä¸ºæ­¤è¿‡ç¨‹å¯èƒ½ä¼šæ”¹å˜æŒ‡é’ˆçš„å¼•ç”¨ï¼Œå¯¼è‡´å†…å­˜å®‰å…¨æ€§é—®é¢˜æ‰€ä»¥éœ€è¦STWã€‚ ç°æ–­å¼€ç™½ä¸”é»‘æŒ‡å‘ç™½ï¼šå¯¼è‡´è¢«å¼•ç”¨å¯¹è±¡è¢«æ¸…é™¤ï¼ˆè¿™ä¸ªç™½è‰²å¦‚æœæœ‰ä¸‹æ¸¸ï¼Œä¹Ÿä¼šè¢«æ¸…é™¤ï¼‰ ä¸‰è‰²ä¸å˜æ€§ æƒ³è®©å¹¶å‘æˆ–è€…å¢é‡ç®—æ³•ä¸­ä¿è¯æ­£ç¡®æ€§ï¼Œéœ€è¦æ»¡è¶³ä¸¤ç§ä¸‰è‰²ä¸å˜æ€§ä¸­çš„ä¸€ç§ å¼ºä¸‰è‰²ä¸å˜æ€§ï¼šé»‘ä¸èƒ½æŒ‡å‘ç™½ å¼±ä¸‰è‰²ä¸å˜æ€§ é»‘æŒ‡å‘çš„ç™½å¿…é¡»è¢«ç°é—´æ¥æˆ–ç›´æ¥å¼•ç”¨ å†…å­˜å±éšœ å†…å­˜å±éšœï¼šè®©CPUæˆ–ç¼–è¯‘å™¨åœ¨æ‰§è¡Œå†…å­˜ç›¸å…³æ“ä½œæ—¶å¯ä»¥éµå¾ªç‰¹å®šçº¦æŸï¼Œä½¿å…¶æŒ‡ä»¤å¯ä»¥é¡ºåºåŒ–æ‰§è¡Œã€‚ åƒåœ¾å›æ”¶æœºåˆ¶ä¸­çš„å±éšœæŠ€æœ¯ç±»ä¼¼äºä¸€ä¸ªé’©å­å‡½æ•°ï¼Œåœ¨ç”¨æˆ·åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å¯¹è±¡æŒ‡é’ˆæ—¶æ‰§è¡Œçš„ä¸€æ®µä»£ç ï¼Œæ ¹æ®ç±»å‹ä¸åŒï¼Œåˆ†ä¸ºè¯»å±éšœå’Œå†™å±éšœã€‚ æ’å…¥å†™å±éšœï¼šæ»¡è¶³å¼ºä¸‰è‰²ä¸å˜æ€§(é»‘åˆ°ç™½è¿æ¥) åœ¨æ›´æ–°å’Œæ–°å¢èŠ‚ç‚¹æ—¶ï¼Œè¢«å¼•ç”¨çš„ç™½è‰²å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ã€‚ ä½†æ˜¯å› ä¸ºæ ˆç©ºé—´å®¹é‡å°ï¼Œé€Ÿåº¦å¿«ã€‚ä¸å¯ä»¥é¢‘ç¹è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥æ’å…¥å†™åªåœ¨å †ä¸­ä½¿ç”¨ã€‚ åˆ é™¤å†™å±éšœï¼šæ»¡è¶³å¼±ä¸‰è‰²ä¸å˜æ€§(ç°åˆ°ç™½æ–­å¼€) è¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç™½è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ã€‚ å¯ä»¥åœ¨æ ˆä¸­ä½¿ç”¨ã€‚ ä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´ä¸€ä¸ªèŠ‚ç‚¹å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿå¯ä»¥æ´»è¿‡è¿™ä¸€è½®GCã€‚ æ‰€ä»¥æ•´ä¸ªæµç¨‹å°±æ˜¯å…¨éƒ¨èŠ‚ç‚¹å¹¶å‘ä¸‰è‰²æ ‡è®°ä¸€éï¼Œå †ç©ºé—´å¢åŠ å†™å±éšœï¼Œç„¶åæ ˆç©ºé—´STWé‡æ–°æ ‡è®°ä¸€éï¼Œæœ€åæ¸…é™¤ç™½è‰²èŠ‚ç‚¹ã€‚ ç¼ºç‚¹ æ’å…¥å†™å±éšœå’Œåˆ é™¤å†™å±éšœçš„çŸ­æ¿ï¼š æ’å…¥å†™å±éšœï¼šç»“æŸæ—¶éœ€è¦STWæ¥é‡æ–°æ‰«ææ ˆï¼Œæ ‡è®°æ ˆä¸Šå¼•ç”¨çš„ç™½è‰²å¯¹è±¡çš„å­˜æ´»ï¼› åˆ é™¤å†™å±éšœï¼šå›æ”¶ç²¾åº¦ä½ï¼Œä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿä¾æ—§å¯ä»¥æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½®GCä¸­è¢«æ¸…ç†æ‰ã€‚ Go1.8 æ··åˆå†™å±éšœ Go V1.8ç‰ˆæœ¬å¼•å…¥äº†æ··åˆå†™å±éšœæœºåˆ¶ï¼Œé¿å…äº†å¯¹æ ˆre-scançš„è¿‡ç¨‹ï¼Œæå¤§çš„å‡å°‘äº†STWçš„æ—¶é—´ã€‚ç»“åˆäº†æ’å…¥å†™å’Œåˆ é™¤å†™çš„ä¼˜ç‚¹ã€‚ è§„åˆ™ 1ã€GCå¼€å§‹å°†æ ˆä¸Šçš„å¯è¾¾å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²(ä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€STW)ï¼Œ 2ã€GCæœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ã€‚ 3ã€åˆ é™¤å†™ï¼šè¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ 4ã€æ’å…¥å†™ï¼šè¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚ æµç¨‹ æ³¨æ„æ··åˆå†™å±éšœæ˜¯GCçš„ä¸€ç§å±éšœæœºåˆ¶ï¼Œæ‰€ä»¥åªæ˜¯å½“ç¨‹åºæ‰§è¡ŒGCçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è¿™ç§æœºåˆ¶ã€‚ å±éšœæŠ€æœ¯æ˜¯ä¸åœ¨æ ˆä¸Šåº”ç”¨çš„ï¼Œå› ä¸ºè¦ä¿è¯æ ˆçš„è¿è¡Œæ•ˆç‡ GCå¼€å§‹ï¼Œæ‰«ææ ˆï¼Œå°†æ‰€æœ‰å¯è¾¾å¯¹è±¡æ ‡è®°ä¸ºé»‘ã€‚ å¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºæ ˆå¯¹è±¡çš„ä¸‹æ¸¸ï¼ˆç°è‰²åˆ é™¤ï¼Œé»‘è‰²æ·»åŠ ï¼‰ è§¦å‘åˆ é™¤å†™ï¼Œæ ‡è®°ç™½è‰²å¯¹è±¡ä¸ºç° å¯¹è±¡è¢«ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªæ ˆå¯¹è±¡çš„ä¸‹æ¸¸ï¼ˆæ ˆç©ºé—´æ— å±éšœï¼‰ åæ­£ä¹Ÿæ˜¯é»‘è‰²èŠ‚ç‚¹ï¼Œæ— å½±å“ å¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸ï¼ˆç°è‰²åˆ é™¤ï¼Œé»‘è‰²æ·»åŠ ï¼‰ è§¦å‘å±éšœï¼Œæ ‡è®°ç™½è‰²å¯¹è±¡ä¸ºç° å¯¹è±¡ä»ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸ï¼ˆç°è‰²æ–­å¼€ï¼‰ è§¦å‘åˆ é™¤å†™å±éšœï¼Œç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç° æ€»ç»“ GoV1.3- æ™®é€šæ ‡è®°æ¸…é™¤æ³•ï¼Œæ•´ä½“è¿‡ç¨‹éœ€è¦å¯åŠ¨STWï¼Œæ•ˆç‡æä½ã€‚ GoV1.5- ä¸‰è‰²æ ‡è®°æ³•ï¼Œ å †ç©ºé—´å¯åŠ¨å†™å±éšœï¼Œæ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå…¨éƒ¨æ‰«æä¹‹åï¼Œéœ€è¦é‡æ–°æ‰«æä¸€æ¬¡æ ˆ(éœ€è¦STW)ï¼Œæ•ˆç‡æ™®é€š GoV1.8-ä¸‰è‰²æ ‡è®°æ³•ï¼Œæ··åˆå†™å±éšœæœºåˆ¶ï¼Œ æ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå †ç©ºé—´å¯åŠ¨ã€‚æ•´ä¸ªè¿‡ç¨‹å‡ ä¹ä¸éœ€è¦STWï¼Œæ•ˆç‡è¾ƒé«˜ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"è‡ªåŠ¨å†…å­˜ç®¡ç† åŠ¨æ€å†…å­˜ï¼šç¨‹åºåœ¨è¿è¡Œæ—¶æ ¹æ®éœ€æ±‚åŠ¨æ€åˆ†é…å†…å­˜ åƒåœ¾å›æ”¶ï¼šç”±ç¨‹åºè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿå›æ”¶åŠ¨æ€å†…å­˜ é¿å…æ‰‹åŠ¨å†…å­˜ç®¡ç† ä¿è¯å†…å­˜ä½¿ç”¨çš„å®‰å…¨æ€§å’Œæ­£ç¡®æ€§ ä¸‰ä¸ªä»»åŠ¡ï¼š ä¸ºæ–°å¯¹è±¡åˆ†é…ç©ºé—´ å›æ”¶æ²¡æœ‰è¢«ä½¿ç”¨çš„å¯¹è±¡ ç›¸å…³æ¦‚å¿µ è¿½è¸ªåƒåœ¾å›æ”¶ åˆ†ä»£GC å¼•ç”¨è®¡æ•° ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:5","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Goå†…å­˜ç®¡ç†å’Œä¼˜åŒ– åˆ†å— ç¼“å­˜ ä¼˜åŒ– å°å¯¹è±¡åˆ†é…è¿‡å¤šï¼Œåˆ†é…è·¯å¾„è¿‡é•¿ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:7:6","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"å…ƒç¼–ç¨‹ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:8:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ’ä»¶ç³»ç»Ÿ è®¾è®¡åŸç† Go è¯­è¨€çš„æ’ä»¶ç³»ç»ŸåŸºäº C è¯­è¨€åŠ¨æ€åº“å®ç°çš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»§æ‰¿äº† C è¯­è¨€åŠ¨æ€åº“çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚ é™æ€åº“æˆ–è€…é™æ€é“¾æ¥åº“æ˜¯ç”±ç¼–è¯‘æœŸå†³å®šçš„ç¨‹åºã€å¤–éƒ¨å‡½æ•°å’Œå˜é‡æ„æˆçš„ï¼Œç¼–è¯‘å™¨æˆ–è€…é“¾æ¥å™¨ä¼šå°†ç¨‹åºå’Œå˜é‡ç­‰å†…å®¹æ‹·è´åˆ°ç›®æ ‡çš„åº”ç”¨å¹¶ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„å¯æ‰§è¡Œå¯¹è±¡æ–‡ä»¶ï¼› å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä½†æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶è¾ƒå¤§ åŠ¨æ€åº“æˆ–è€…å…±äº«å¯¹è±¡å¯ä»¥åœ¨å¤šä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¹‹é—´å…±äº«ï¼Œç¨‹åºä½¿ç”¨çš„æ¨¡å—ä¼šåœ¨è¿è¡Œæ—¶ä»å…±äº«å¯¹è±¡ä¸­åŠ è½½ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘ç¨‹åºæ—¶æ‰“åŒ…æˆç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼› å¯ä»¥åœ¨å¤šä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¹‹é—´å…±äº«ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œä¸€èˆ¬åœ¨è¿è¡ŒæœŸé—´è£…è½½ã€‚ æ’ä»¶ç³»ç»Ÿ é€šè¿‡åœ¨ä¸»ç¨‹åºå’Œå…±äº«åº“ç›´æ¥å®šä¹‰ä¸€ç³»åˆ—çš„çº¦å®šæˆ–è€…æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„ä»£ç åŠ¨æ€åŠ è½½å…¶ä»–äººç¼–è¯‘çš„ Go è¯­è¨€å…±äº«å¯¹è±¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸»ç¨‹åºå’Œå…±äº«åº“çš„å¼€å‘è€…ä¸éœ€è¦å…±äº«ä»£ç ï¼Œåªè¦åŒæ–¹çš„çº¦å®šä¸å˜ï¼Œä¿®æ”¹å…±äº«åº“åä¹Ÿä¸éœ€è¦é‡æ–°ç¼–è¯‘ä¸»ç¨‹åºã€‚ type Driver interface { Name() string } func main() { p, err := plugin.Open(\"driver.so\") if err != nil { panic(err) } newDriverSymbol, err := p.Lookup(\"NewDriver\") if err != nil { panic(err) } // å¯»æ‰¾ä»»ä½•å¯ä»¥å¯¼å‡ºçš„å˜é‡æˆ–å‡½æ•° newDriverFunc := newDriverSymbol.(func() Driver) newDriver := newDriverFunc() fmt.Println(newDriver.Name()) } å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œå¹¶ä¸”åŠ¨æ€åº“å®ç°äº†å®ƒï¼Œå½“æˆ‘ä»¬é€šè¿‡ plugin.Open è¯»å–åŒ…å« Go è¯­è¨€æ’ä»¶çš„å…±äº«åº“åï¼Œè·å–æ–‡ä»¶ä¸­çš„ NewDriver ç¬¦å·å¹¶è½¬æ¢æˆæ­£ç¡®çš„å‡½æ•°ç±»å‹ï¼Œå¯ä»¥é€šè¿‡è¯¥å‡½æ•°åˆå§‹åŒ–æ–°çš„ Driver å¹¶è·å–å®ƒçš„åå­—äº†ã€‚ æ“ç»„ç³»ç»Ÿ Linux ä¸­çš„å…±äº«å¯¹è±¡ä¼šä½¿ç”¨ ELF æ ¼å¼ 3 å¹¶æä¾›äº†ä¸€ç»„æ“ä½œåŠ¨æ€é“¾æ¥å™¨çš„æ¥å£ void *dlopen(const char *filename, int flag); char *dlerror(void); void *dlsym(void *handle, const char *symbol); int dlclose(void *handle); dlopen ä¼šæ ¹æ®ä¼ å…¥çš„æ–‡ä»¶ååŠ è½½å¯¹åº”çš„åŠ¨æ€åº“å¹¶è¿”å›ä¸€ä¸ªå¥æŸ„ï¼ˆHandleï¼‰ï¼›æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ dlsym å‡½æ•°åœ¨è¯¥å¥æŸ„ä¸­æœç´¢ç‰¹å®šçš„ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æˆ–è€…å˜é‡ï¼Œå®ƒä¼šè¿”å›è¯¥ç¬¦å·è¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„åœ°å€ã€‚å› ä¸ºå¾…æŸ¥æ‰¾çš„ç¬¦å·å¯èƒ½ä¸å­˜åœ¨äºç›®æ ‡åŠ¨æ€åº“ä¸­ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡æŸ¥æ‰¾åæˆ‘ä»¬éƒ½åº”è¯¥è°ƒç”¨ dlerror æŸ¥çœ‹å½“å‰æŸ¥æ‰¾çš„ç»“æœã€‚ Go è¯­è¨€æ’ä»¶ç³»ç»Ÿçš„å…¨éƒ¨å®ç°éƒ½åŒ…å«åœ¨ plugin ä¸­ï¼Œè¿™ä¸ªåŒ…å®ç°äº†ç¬¦å·ç³»ç»Ÿçš„åŠ è½½å’Œå†³è®®ã€‚æ’ä»¶æ˜¯ä¸€ä¸ªå¸¦æœ‰å…¬å¼€å‡½æ•°å’Œå˜é‡çš„åŒ…ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘æ’ä»¶ï¼š go build -buildmode=plugin ... è¯¥å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªå…±äº«å¯¹è±¡ .so æ–‡ä»¶ï¼Œå½“è¯¥æ–‡ä»¶è¢«åŠ è½½åˆ° Go è¯­è¨€ç¨‹åºæ—¶ä¼šä½¿ç”¨ä¸‹é¢çš„ç»“æ„ä½“ plugin.Plugin è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«æ–‡ä»¶çš„è·¯å¾„ä»¥åŠåŒ…å«çš„ç¬¦å·ç­‰ä¿¡æ¯ï¼š type Plugin struct { pluginpath string // æ’ä»¶è·¯å¾„ syms map[string]interface{} // ç¬¦å·ä¿¡æ¯ ... } ä¸æ’ä»¶ç³»ç»Ÿç›¸å…³çš„ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•åˆ†åˆ«æ˜¯ç”¨äºåŠ è½½å…±äº«æ–‡ä»¶çš„ plugin.Open å’Œåœ¨æ’ä»¶ä¸­æŸ¥æ‰¾ç¬¦å·çš„ plugin.Plugin.Lookup CGO åŒ…ä¸­ä½¿ç”¨çš„ä¸¤ä¸ª C è¯­è¨€å‡½æ•° plugin.pluginOpen å’Œ plugin.pluginLookupï¼› plugin.pluginOpen åªæ˜¯ç®€å•åŒ…è£…äº†ä¸€ä¸‹æ ‡å‡†åº“ä¸­çš„ dlopen å’Œ dlerror å‡½æ•°å¹¶åœ¨åŠ è½½æˆåŠŸåè¿”å›æŒ‡å‘åŠ¨æ€åº“çš„å¥æŸ„ï¼š static uintptr_t pluginOpen(const char* path, char** err) { void* h = dlopen(path, RTLD_NOW|RTLD_GLOBAL); if (h == NULL) { *err = (char*)dlerror(); } return (uintptr_t)h; } plugin.pluginLookup ä½¿ç”¨äº†æ ‡å‡†åº“ä¸­çš„ dlsym å’Œ dlerror è·å–åŠ¨æ€åº“å¥æŸ„ä¸­çš„ç‰¹å®šç¬¦å·ï¼š static void* pluginLookup(uintptr_t h, const char* name, char** err) { void* r = dlsym((void*)h, name); if (r == NULL) { *err = (char*)dlerror(); } return r; } åŠ è½½è¿‡ç¨‹ ç”¨äºåŠ è½½å…±äº«å¯¹è±¡çš„å‡½æ•° plugin.Open ä¼šå°†å…±äº«å¯¹è±¡æ–‡ä»¶çš„è·¯å¾„ä½œä¸ºå‚æ•°å¹¶è¿”å› plugin.Plugin ç»“æ„ func Open(path string) (*Plugin, error) { return open(path) } ä¸Šè¿°å‡½æ•°ä¼šè°ƒç”¨ç§æœ‰çš„å‡½æ•° plugin.open åŠ è½½æ’ä»¶ï¼Œå®ƒæ˜¯æ’ä»¶åŠ è½½è¿‡ç¨‹çš„æ ¸å¿ƒå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥å‡½æ•°æ‹†åˆ†æˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š å‡†å¤‡ C è¯­è¨€å‡½æ•° plugin.pluginOpen çš„å‚æ•°ï¼› é€šè¿‡ cgo è°ƒç”¨ plugin.pluginOpen å¹¶åˆå§‹åŒ–åŠ è½½çš„æ¨¡å—ï¼› æŸ¥æ‰¾åŠ è½½æ¨¡å—ä¸­çš„ init å‡½æ•°å¹¶è°ƒç”¨è¯¥å‡½æ•°ï¼› é€šè¿‡æ’ä»¶çš„æ–‡ä»¶åå’Œç¬¦å·åˆ—è¡¨æ„å»º plugin.Plugin ç»“æ„ï¼› æ¨èé˜…è¯» ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:8:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"ä»£ç ç”Ÿæˆ å…ƒç¼–ç¨‹ï¼šä½¿ç”¨ä»£ç ç”Ÿæˆä»£ç  Go è¯­è¨€çš„ä»£ç ç”Ÿæˆæœºåˆ¶ä¼šè¯»å–åŒ…å«é¢„ç¼–è¯‘æŒ‡ä»¤çš„æ³¨é‡Šï¼Œç„¶åæ‰§è¡Œæ³¨é‡Šä¸­çš„å‘½ä»¤è¯»å–åŒ…ä¸­çš„æ–‡ä»¶ï¼Œç„¶åç”Ÿæˆæ–°çš„goä»£ç æ–‡ä»¶ï¼Œæœ€åä¸€èµ·ç¼–è¯‘è¿è¡Œ //go:generate command argument... go generate ä¸ä¼šè¢« go build ç­‰å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œï¼Œè¯¥å‘½ä»¤éœ€è¦æ˜¾å¼çš„è§¦å‘ï¼Œæ‰‹åŠ¨æ‰§è¡Œè¯¥å‘½ä»¤æ—¶ä¼šåœ¨æ–‡ä»¶ä¸­æ‰«æä¸Šè¿°å½¢å¼çš„æ³¨é‡Šå¹¶æ‰§è¡Œåé¢çš„æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ go:generate å’Œå‰é¢çš„ // ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ï¼Œè¿™ç§ä¸åŒ…å«ç©ºæ ¼çš„æ³¨é‡Šä¸€èˆ¬æ˜¯ Go è¯­è¨€çš„ç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œè€Œæˆ‘ä»¬åœ¨ä»£ç ä¸­çš„æ­£å¸¸æ³¨é‡Šéƒ½åº”è¯¥ä¿ç•™è¿™ä¸ªç©ºæ ¼ã€‚ ä»£ç ç”Ÿæˆæœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯å®˜æ–¹æä¾›çš„ stringerï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥æ‰«æå¦‚ä¸‹æ‰€ç¤ºçš„å¸¸é‡å®šä¹‰ï¼Œç„¶åä¸ºå½“å‰å¸¸é‡ç±»å‹ Piller ç”Ÿæˆå¯¹åº”çš„ String() æ–¹æ³•ï¼š package painkiller //go:generate stringer -type=Pill type Pill int const ( Placebo Pill = iota Aspirin Ibuprofen Paracetamol Acetaminophen = Paracetamol ) // å…ƒç¼–ç¨‹: ä¸ºä»¥ä¸Šç±»å‹ç”ŸæˆString() ç„¶åæ‰§è¡Œgo generateä¼šè‡ªåŠ¨ç”Ÿæˆpill_string.goæ–‡ä»¶ ä»£ç ç”Ÿæˆçš„è¿‡ç¨‹å¯ä»¥åˆ†æˆä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š æ‰«æ Go è¯­è¨€æºæ–‡ä»¶ï¼ŒæŸ¥æ‰¾å¾…æ‰§è¡Œçš„ //go:generate é¢„ç¼–è¯‘æŒ‡ä»¤ï¼› æ‰§è¡Œé¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå†æ¬¡æ‰«ææºæ–‡ä»¶å¹¶æ ¹æ®æºæ–‡ä»¶ä¸­çš„ä»£ç ç”Ÿæˆä»£ç ï¼› ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:8:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"åŒ…ç®¡ç† ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go Modules Go modules æ˜¯ Go è¯­è¨€çš„ä¾èµ–è§£å†³æ–¹æ¡ˆï¼Œå‘å¸ƒäº Go1.11ï¼Œæˆé•¿äº Go1.12ï¼Œä¸°å¯Œäº Go1.13ï¼Œæ­£å¼äº Go1.14 æ¨èåœ¨ç”Ÿäº§ä¸Šä½¿ç”¨ã€‚ Go moudles ç›®å‰é›†æˆåœ¨ Go çš„å·¥å…·é“¾ä¸­ï¼Œåªè¦å®‰è£…äº† Goï¼Œè‡ªç„¶è€Œç„¶ä¹Ÿå°±å¯ä»¥ä½¿ç”¨ Go moudles äº†ï¼Œè€Œ Go modules çš„å‡ºç°ä¹Ÿè§£å†³äº†åœ¨ Go1.11 å‰çš„å‡ ä¸ªå¸¸è§äº‰è®®é—®é¢˜ï¼š Go è¯­è¨€é•¿ä¹…ä»¥æ¥çš„ä¾èµ–ç®¡ç†é—®é¢˜ã€‚ â€œæ·˜æ±°â€ç°æœ‰çš„ GOPATH çš„ä½¿ç”¨æ¨¡å¼ã€‚ ç»Ÿä¸€ç¤¾åŒºä¸­çš„å…¶å®ƒçš„ä¾èµ–ç®¡ç†å·¥å…·ï¼ˆæä¾›è¿ç§»åŠŸèƒ½ï¼‰ã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"GOPATH æ¨¡å¼ // GOPATHä¸‹ go â”œâ”€â”€ bin // å­˜å‚¨æ‰€ç¼–è¯‘ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ â”œâ”€â”€ pkg // å­˜å‚¨é¢„ç¼–è¯‘çš„ç›®æ ‡æ–‡ä»¶ï¼Œä»¥åŠ å¿«ç¨‹åºçš„åç»­ç¼–è¯‘é€Ÿåº¦ã€‚ â””â”€â”€ src // å­˜å‚¨æ‰€æœ‰.goæ–‡ä»¶æˆ–æºä»£ç  â”œâ”€â”€ github.com â”œâ”€â”€ golang.org â”œâ”€â”€ google.golang.org â”œâ”€â”€ gopkg.in .... A. æ— ç‰ˆæœ¬æ§åˆ¶æ¦‚å¿µ. åœ¨æ‰§è¡Œgo getçš„æ—¶å€™ï¼Œä½ æ— æ³•ä¼ è¾¾ä»»ä½•çš„ç‰ˆæœ¬ä¿¡æ¯çš„æœŸæœ›ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ä¹Ÿæ— æ³•çŸ¥é“è‡ªå·±å½“å‰æ›´æ–°çš„æ˜¯å“ªä¸€ä¸ªç‰ˆæœ¬ï¼Œä¹Ÿæ— æ³•é€šè¿‡æŒ‡å®šæ¥æ‹‰å–è‡ªå·±æ‰€æœŸæœ›çš„å…·ä½“ç‰ˆæœ¬ã€‚ B.æ— æ³•åŒæ­¥ä¸€è‡´ç¬¬ä¸‰æ–¹ç‰ˆæœ¬å·. åœ¨è¿è¡Œ Go åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä½ æ— æ³•ä¿è¯å…¶å®ƒäººä¸ä½ æ‰€æœŸæœ›ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“æ˜¯ç›¸åŒçš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨é¡¹ç›®ä¾èµ–åº“çš„ç®¡ç†ä¸Šï¼Œä½ æ— æ³•ä¿è¯æ‰€æœ‰äººçš„ä¾èµ–ç‰ˆæœ¬éƒ½ä¸€è‡´ã€‚ **C.æ— æ³•æŒ‡å®šå½“å‰é¡¹ç›®å¼•ç”¨çš„ç¬¬ä¸‰æ–¹ç‰ˆæœ¬å·. ** ä½ æ²¡åŠæ³•å¤„ç† v1ã€v2ã€v3 ç­‰ç­‰ä¸åŒç‰ˆæœ¬çš„å¼•ç”¨é—®é¢˜ï¼Œå› ä¸º GOPATH æ¨¡å¼ä¸‹çš„å¯¼å…¥è·¯å¾„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯github.com/foo/barã€‚ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go Modules æ¨¡å¼ go modå‘½ä»¤ å‘½ä»¤ ä½œç”¨ go mod init ç”Ÿæˆ go.mod æ–‡ä»¶ go mod download ä¸‹è½½ go.mod æ–‡ä»¶ä¸­æŒ‡æ˜çš„æ‰€æœ‰ä¾èµ– go mod tidy æ•´ç†ç°æœ‰çš„ä¾èµ– go mod graph æŸ¥çœ‹ç°æœ‰çš„ä¾èµ–ç»“æ„ go mod edit ç¼–è¾‘ go.mod æ–‡ä»¶ go mod vendor å¯¼å‡ºé¡¹ç›®æ‰€æœ‰çš„ä¾èµ–åˆ°vendorç›®å½• go mod verify æ ¡éªŒä¸€ä¸ªæ¨¡å—æ˜¯å¦è¢«ç¯¡æ”¹è¿‡ go mod why æŸ¥çœ‹ä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–æŸæ¨¡å— go modç¯å¢ƒå˜é‡ $ go env GO111MODULE=\"auto\" GOPROXY=\"https://proxy.golang.org,direct\" GONOPROXY=\"\" GOSUMDB=\"sum.golang.org\" GONOSUMDB=\"\" GOPRIVATE=\"\" GO111MODULE Goè¯­è¨€æä¾›äº† GO111MODULE è¿™ä¸ªç¯å¢ƒå˜é‡æ¥ä½œä¸º Go modules çš„å¼€å…³ï¼Œå…¶å…è®¸è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼š autoï¼šåªè¦é¡¹ç›®åŒ…å«äº† go.mod æ–‡ä»¶çš„è¯å¯ç”¨ Go modulesï¼Œç›®å‰åœ¨ Go1.11 è‡³ Go1.14 ä¸­ä»ç„¶æ˜¯é»˜è®¤å€¼ã€‚ onï¼šå¯ç”¨ Go modulesï¼Œæ¨èè®¾ç½®ï¼Œå°†ä¼šæ˜¯æœªæ¥ç‰ˆæœ¬ä¸­çš„é»˜è®¤å€¼ã€‚ offï¼šç¦ç”¨ Go modulesï¼Œä¸æ¨èè®¾ç½®ã€‚ è®¾ç½®ï¼šgo env -w GO111MODULE=on GOPROXY è¿™ä¸ªç¯å¢ƒå˜é‡ä¸»è¦æ˜¯ç”¨äºè®¾ç½® Go æ¨¡å—ä»£ç†ï¼ˆGo module proxyï¼‰,å…¶ä½œç”¨æ˜¯ç”¨äºä½¿ Go åœ¨åç»­æ‹‰å–æ¨¡å—ç‰ˆæœ¬æ—¶ç›´æ¥é€šè¿‡é•œåƒç«™ç‚¹æ¥å¿«é€Ÿæ‹‰å–ã€‚ GOPROXY çš„é»˜è®¤å€¼æ˜¯ï¼šhttps://proxy.golang.org,direct proxy.golang.orgå›½å†…è®¿é—®ä¸äº†,éœ€è¦è®¾ç½®å›½å†…çš„ä»£ç†. é˜¿é‡Œäº‘ https://mirrors.aliyun.com/goproxy/ ä¸ƒç‰›äº‘ https://goproxy.cn,direct å¦‚: $ go env -w GOPROXY=https://goproxy.cn,direct GOPROXY çš„å€¼æ˜¯ä¸€ä¸ªä»¥è‹±æ–‡é€—å· , åˆ†å‰²çš„ Go æ¨¡å—ä»£ç†åˆ—è¡¨ï¼Œå…è®¸è®¾ç½®å¤šä¸ªæ¨¡å—ä»£ç†ï¼Œå‡è®¾ä½ ä¸æƒ³ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å°†å…¶è®¾ç½®ä¸º â€œoffâ€ ï¼Œè¿™å°†ä¼šç¦æ­¢ Go åœ¨åç»­æ“ä½œä¸­ä½¿ç”¨ä»»ä½• Go æ¨¡å—ä»£ç†ã€‚ è€Œåœ¨åˆšåˆšè®¾ç½®çš„å€¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å€¼åˆ—è¡¨ä¸­æœ‰ â€œdirectâ€ æ ‡è¯†ï¼Œå®ƒåˆæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ å®é™…ä¸Š â€œdirectâ€ æ˜¯ä¸€ä¸ªç‰¹æ®ŠæŒ‡ç¤ºç¬¦ï¼Œç”¨äºæŒ‡ç¤º Go å›æºåˆ°æ¨¡å—ç‰ˆæœ¬çš„æºåœ°å€å»æŠ“å–ï¼ˆæ¯”å¦‚ GitHub ç­‰ï¼‰ï¼Œåœºæ™¯å¦‚ä¸‹ï¼šå½“å€¼åˆ—è¡¨ä¸­ä¸Šä¸€ä¸ª Go æ¨¡å—ä»£ç†è¿”å› 404 æˆ– 410 é”™è¯¯æ—¶ï¼ŒGo è‡ªåŠ¨å°è¯•åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªï¼Œé‡è§ â€œdirectâ€ æ—¶å›æºï¼Œä¹Ÿå°±æ˜¯å›åˆ°æºåœ°å€å»æŠ“å–ï¼Œè€Œé‡è§ EOF æ—¶ç»ˆæ­¢å¹¶æŠ›å‡ºç±»ä¼¼ â€œinvalid version: unknown revisionâ€¦â€ çš„é”™è¯¯ã€‚ GOSUMDB å®ƒçš„å€¼æ˜¯ä¸€ä¸ª Go checksum databaseï¼Œç”¨äºåœ¨æ‹‰å–æ¨¡å—ç‰ˆæœ¬æ—¶ï¼ˆæ— è®ºæ˜¯ä»æºç«™æ‹‰å–è¿˜æ˜¯é€šè¿‡ Go module proxy æ‹‰å–ï¼‰ä¿è¯æ‹‰å–åˆ°çš„æ¨¡å—ç‰ˆæœ¬æ•°æ®æœªç»è¿‡ç¯¡æ”¹ï¼Œè‹¥å‘ç°ä¸ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½å­˜åœ¨ç¯¡æ”¹ï¼Œå°†ä¼šç«‹å³ä¸­æ­¢ã€‚ GOSUMDB çš„é»˜è®¤å€¼ä¸ºï¼šsum.golang.orgï¼Œåœ¨å›½å†…ä¹Ÿæ˜¯æ— æ³•è®¿é—®çš„ï¼Œä½†æ˜¯ GOSUMDB å¯ä»¥è¢« Go æ¨¡å—ä»£ç†æ‰€ä»£ç†ï¼ˆè¯¦è§ï¼šProxying a Checksum Databaseï¼‰ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® GOPROXY æ¥è§£å†³ï¼Œè€Œå…ˆå‰æˆ‘ä»¬æ‰€è®¾ç½®çš„æ¨¡å—ä»£ç† goproxy.cn å°±èƒ½æ”¯æŒä»£ç† sum.golang.orgï¼Œæ‰€ä»¥è¿™ä¸€ä¸ªé—®é¢˜åœ¨è®¾ç½® GOPROXY åï¼Œä½ å¯ä»¥ä¸éœ€è¦è¿‡åº¦å…³å¿ƒã€‚ å¦å¤–è‹¥å¯¹ GOSUMDB çš„å€¼æœ‰è‡ªå®šä¹‰éœ€æ±‚ï¼Œå…¶æ”¯æŒå¦‚ä¸‹æ ¼å¼ï¼š æ ¼å¼ 1ï¼š\u003cSUMDB_NAME\u003e+\u003cPUBLIC_KEY\u003eã€‚ æ ¼å¼ 2ï¼š\u003cSUMDB_NAME\u003e+\u003cPUBLIC_KEY\u003e \u003cSUMDB_URL\u003eã€‚ ä¹Ÿå¯ä»¥å°†å…¶è®¾ç½®ä¸ºâ€œoffâ€ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢ Go åœ¨åç»­æ“ä½œä¸­æ ¡éªŒæ¨¡å—ç‰ˆæœ¬ã€‚ GONOPROXY/GONOSUMDB/GOPRIVATE è¿™ä¸‰ä¸ªç¯å¢ƒå˜é‡éƒ½æ˜¯ç”¨åœ¨å½“å‰é¡¹ç›®ä¾èµ–äº†ç§æœ‰æ¨¡å—ï¼Œä¾‹å¦‚åƒæ˜¯ä½ å…¬å¸çš„ç§æœ‰ git ä»“åº“ï¼Œåˆæˆ–æ˜¯ github ä¸­çš„ç§æœ‰åº“ï¼Œéƒ½æ˜¯å±äºç§æœ‰æ¨¡å—ï¼Œéƒ½æ˜¯è¦è¿›è¡Œè®¾ç½®çš„ï¼Œå¦åˆ™ä¼šæ‹‰å–å¤±è´¥ã€‚ æ›´ç»†è‡´æ¥è®²ï¼Œå°±æ˜¯ä¾èµ–äº†ç”± GOPROXY æŒ‡å®šçš„ Go æ¨¡å—ä»£ç†æˆ–ç”± GOSUMDB æŒ‡å®š Go checksum database éƒ½æ— æ³•è®¿é—®åˆ°çš„æ¨¡å—æ—¶çš„åœºæ™¯ã€‚ è€Œä¸€èˆ¬å»ºè®®ç›´æ¥è®¾ç½® GOPRIVATEï¼Œå®ƒçš„å€¼å°†ä½œä¸º GONOPROXY å’Œ GONOSUMDB çš„é»˜è®¤å€¼ï¼Œæ‰€ä»¥å»ºè®®çš„æœ€ä½³å§¿åŠ¿æ˜¯ç›´æ¥ä½¿ç”¨ GOPRIVATEã€‚ å¹¶ä¸”å®ƒä»¬çš„å€¼éƒ½æ˜¯ä¸€ä¸ªä»¥è‹±æ–‡é€—å· â€œ,â€ åˆ†å‰²çš„æ¨¡å—è·¯å¾„å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è®¾ç½®å¤šä¸ªï¼Œä¾‹å¦‚ï¼š $ go env -w GOPRIVATE=\"git.example.com,github.com/eddycjy/mquote\"è®¾ç½®åï¼Œå‰ç¼€ä¸º git.xxx.com å’Œ github.com/eddycjy/mquote çš„æ¨¡å—éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯ç§æœ‰æ¨¡å—ã€‚ å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½é‡æ–°è®¾ç½®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨é€šé…ç¬¦ï¼Œä¾‹å¦‚ï¼š $ go env -w GOPRIVATE=\"*.example.com\" è¿™æ ·å­è®¾ç½®çš„è¯ï¼Œæ‰€æœ‰æ¨¡å—è·¯å¾„ä¸º example.com çš„å­åŸŸåï¼ˆä¾‹å¦‚ï¼šgit.example.comï¼‰éƒ½å°†ä¸ç»è¿‡ Go module proxy å’Œ Go checksum databaseï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒ…æ‹¬ example.com æœ¬èº«ã€‚ åˆå§‹åŒ–é¡¹ç›® å¼€å¯go mod $ go env -w GO111MODULE=on åˆæˆ–æ˜¯å¯ä»¥é€šè¿‡ç›´æ¥è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆå†™å…¥å¯¹åº”çš„~/.bash_profile æ–‡ä»¶äº¦å¯ï¼‰æ¥å®ç°è¿™ä¸ªç›®çš„ï¼š $ export GO111MODULE=on åˆå§‹åŒ–é¡¹ç›® go mod init é¡¹ç›®ä»“åº“åœ°å€ ä¹‹ååˆ›å»ºmain.go package main import ( \"fmt\" \"github.com/aceld/zinx/znet\" \"github.com/aceld/zinx/ziface\" ) func main(){ ... } ç„¶ågo get github.com/aceld/zinx/znetæ‹‰å–ä¾èµ– é¡¹ç›®ç›®å½•ä¸‹go.modè¢«ä¿®æ”¹ï¼Œå‡ºç°go.sum go.mod module github.com/aceld/modules_test // é¡¹ç›®åŸºæœ¬è·¯å¾„ å¦‚æœä½ çš„ç‰ˆæœ¬å·²ç»å¤§äºç­‰äº2.0.0ï¼ŒæŒ‰ç…§Goçš„è§„èŒƒï¼Œä½ åº”è¯¥åŠ ä¸Šmajorçš„åç¼€(ä¾‹ï¼šmodule github.com/panicthis/modfile/v2) go 1.14 // æ ‡è¯†æœ€ä½æ”¯æŒgoç‰ˆæœ¬ require github.com/aceld/zinx v0.0.0-20200221135252-8a8954e75100 // indirect é—´æ¥ä¾èµ– // è¯­ä¹‰åŒ–ç‰ˆæœ¬ // {MAJOR}.{MINOR}.{PATCH} // {ä¸å…¼å®¹æ›´æ–°}.{æ–°å¢åŠŸèƒ½}.{bugä¿®å¤} // indirect é—´æ¥ä¾èµ– // å½“å‰é¡¹ç›®ä¾èµ–A,ä½†æ˜¯Açš„go.modé—æ¼äº†B, é‚£ä¹ˆå°±ä¼šåœ¨å½“å‰é¡¹ç›®çš„go.modä¸­è¡¥å……B, åŠ indirectæ³¨é‡Š // å½“å‰é¡¹ç›®ä¾èµ–A,ä½†æ˜¯Aæ²¡æœ‰go.mod,åŒæ ·å°±ä¼šåœ¨å½“å‰é¡¹ç›®çš„go.modä¸­è¡¥å……B, åŠ indirectæ³¨é‡Š // å½“å‰é¡¹ç›®ä¾èµ–A,Aåˆä¾èµ–B,å½“å¯¹Aé™çº§çš„æ—¶å€™ï¼Œé™çº§çš„Aä¸å†ä¾èµ–B,è¿™ä¸ªæ—¶å€™Bå°±æ ‡è®°indirectæ³¨é‡Š // +incompatible å…¼å®¹ä¸€äº›æ²¡ç”¨modç®¡ç†çš„åŒ…æˆ–è€…ç‰ˆæœ¬\u003e=2.0.0å´æ²¡æœ‰åŠ åç¼€çš„åŒ… go.sum å…¶è¯¦ç»†ç½—åˆ—äº†å½“å‰é¡¹ç›®ç›´æ¥æˆ–é—´æ¥ä¾èµ–çš„æ‰€æœ‰æ¨¡å—ç‰ˆæœ¬ï¼Œå¹¶å†™æ˜äº†é‚£äº›æ¨¡å—ç‰ˆæœ¬çš„ SHA-256 å“ˆå¸Œå€¼ä»¥å¤‡ Go åœ¨ä»Šåçš„æ“ä½œä¸­ä¿è¯é¡¹ç›®æ‰€ä¾èµ–çš„é‚£äº›æ¨¡å—ç‰ˆæœ¬ä¸ä¼šè¢«ç¯¡æ”¹ã€‚ æœ€å°ç‰ˆæœ¬æ§åˆ¶MVS åŸæ–‡ MVS åœ¨æ¨¡å—çš„æœ‰å‘å›¾ä¸Šè¿è¡Œï¼Œç”± go.mod æ–‡ä»¶ æŒ‡å®šã€‚ å›¾ä¸­çš„æ¯ä¸ªé¡¶ç‚¹ä»£è¡¨ä¸€ä¸ªæ¨¡å—ç‰ˆæœ¬ã€‚ æ¯æ¡è¾¹ä»£è¡¨ä¾èµ–é¡¹çš„æœ€ä½è¦æ±‚ç‰ˆæœ¬ï¼Œä½¿ç”¨ require æŒ‡ä»¤æŒ‡å®šã€‚ åœ¨ä¸»æ¨¡å—çš„ go.mod æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ replace å’Œ exclude æŒ‡ä»¤ä¿®æ”¹å›¾å½¢ã€‚ MVS ä»ä¸»æ¨¡å—å¼€å§‹ï¼ˆå›¾ä¸­æ²¡æœ‰ç‰ˆæœ¬çš„ç‰¹æ®Šé¡¶ç‚¹ï¼‰ï¼Œå¹¶éå†å›¾ï¼Œè·Ÿè¸ªæ¯ä¸ªæ¨¡å—æ‰€éœ€çš„æœ€é«˜ç‰ˆæœ¬ã€‚åœ¨éå†ç»“æŸæ—¶ï¼Œæ‰€éœ€çš„æœ€é«˜ç‰ˆæœ¬æ„æˆæ„å»ºåˆ—è¡¨ï¼šå®ƒä»¬æ˜¯æ»¡è¶³æ‰€æœ‰è¦æ±‚çš„æœ€ä½ç‰ˆæœ¬ã€‚ è€ƒè™‘ä¸‹å›¾ä¸­çš„ç¤ºä¾‹ã€‚ä¸»æ¨¡å—éœ€è¦æ¨¡å— A å’Œ æ¨¡å— B æœ€ä½ 1.2 ç‰ˆæœ¬ï¼ŒA 1.2 å’Œ B 1.2 åˆ†åˆ«ä¾èµ– C 1.3 å’Œ C 1.4ï¼Œ C 1.3 å’Œ C 1.4 éƒ½ä¾èµ– D 1.2ã€‚ MVS è®¿é—®å¹¶åŠ è½½æ‰€æœ‰æ ‡è“ç‰ˆæœ¬æ¨¡å—çš„ go.mod æ–‡ä»¶ã€‚åœ¨å›¾ä¸Šéå†ç»“æŸæ—¶ï¼ŒMVS è¿”å›ä¸€ä¸ªåŒ…å«ç²—ä½“ç‰ˆæœ¬çš„æ„å»ºåˆ—è¡¨ï¼šA 1.2ã€B 1.2ã€C 1.4 å’Œ D 1.2ã€‚è¯·æ³¨æ„ï¼Œå¯ä»¥ä½¿ç”¨æ›´é«˜ç‰ˆæœ¬çš„ B å’Œ Dï¼Œä½† MVS ä¸ä¼šé€‰æ‹©å®ƒä»¬ï¼Œå› ä¸ºä¸éœ€è¦å®ƒä»¬ã€‚ æ›¿æ¢ ä¸»æ¨¡å—çš„ go.mod æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ replace æŒ‡ä»¤ æ¥æ›¿æ¢æ¨¡å—å†…å®¹ï¼ˆåŒ…æ‹¬å…¶ go.mod æ–‡ä»¶ï¼‰ã€‚ replace æŒ‡ä»¤å¯èƒ½é€‚ç”¨äºæ¨¡å—çš„æŒ‡å®šç‰ˆæœ¬æˆ–æ‰€æœ‰ç‰ˆæœ¬ã€‚ è€ƒè™‘ä¸‹é¢çš„ç¤ºä¾‹ï¼Œå…¶ä¸­ C 1.4 å·²è¢« R æ›¿æ¢ã€‚R å–å†³äº D 1.3 è€Œä¸æ˜¯ D 1.2ï¼Œå› æ­¤ MVS è¿”å›åŒ…å« A 1.2ã€B 1.2ã€C 1.4ï¼ˆæ›¿æ¢ä¸º Rï¼‰å’Œ D 1.3 çš„æ„å»ºåˆ—è¡¨ Exclusion åœ¨ä¸»æ¨¡å—çš„ go.mod æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ exclude æŒ‡ä»¤ åœ¨ç‰¹å®šç‰ˆæœ¬ä¸­æ’é™¤ä¸€ä¸ªæ¨¡å—ã€‚ è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚C 1.3 å·²","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:3","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"go get go get [-d] [-f] [-t] [-u] [-fix] [-insecure] [build flags] [packages] å‚æ•° æè¿° -d è®©å‘½ä»¤ç¨‹åºåªæ‰§è¡Œä¸‹è½½åŠ¨ä½œï¼Œè€Œä¸æ‰§è¡Œå®‰è£…åŠ¨ä½œã€‚ -f ä»…åœ¨ä½¿ç”¨ - u æ ‡è®°æ—¶æ‰æœ‰æ•ˆã€‚è¯¥æ ‡è®°ä¼šè®©å‘½ä»¤ç¨‹åºå¿½ç•¥æ‰å¯¹å·²ä¸‹è½½ä»£ç åŒ…çš„å¯¼å…¥è·¯å¾„çš„æ£€æŸ¥ã€‚å¦‚æœä¸‹è½½å¹¶å®‰è£…çš„ä»£ç åŒ…æ‰€å±çš„é¡¹ç›®æ˜¯ä½ ä»åˆ«äººé‚£é‡Œ Fork è¿‡æ¥çš„ï¼Œé‚£ä¹ˆè¿™æ ·åšå°±å°¤ä¸ºé‡è¦äº†ã€‚ -fix è®©å‘½ä»¤ç¨‹åºåœ¨ä¸‹è½½ä»£ç åŒ…åå…ˆæ‰§è¡Œä¿®æ­£åŠ¨ä½œï¼Œè€Œåå†è¿›è¡Œç¼–è¯‘å’Œå®‰è£…ã€‚ -insecure å…è®¸å‘½ä»¤ç¨‹åºä½¿ç”¨éå®‰å…¨çš„ schemeï¼ˆå¦‚ HTTPï¼‰å»ä¸‹è½½æŒ‡å®šçš„ä»£ç åŒ…ã€‚å¦‚æœä½ ç”¨çš„ä»£ç ä»“åº“ï¼ˆå¦‚å…¬å¸å†…éƒ¨çš„ Gitlabï¼‰æ²¡æœ‰ HTTPS æ”¯æŒï¼Œå¯ä»¥æ·»åŠ æ­¤æ ‡è®°ã€‚è¯·åœ¨ç¡®å®šå®‰å…¨çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒã€‚ -t è®©å‘½ä»¤ç¨‹åºåŒæ—¶ä¸‹è½½å¹¶å®‰è£…æŒ‡å®šçš„ä»£ç åŒ…ä¸­çš„æµ‹è¯•æºç æ–‡ä»¶ä¸­ä¾èµ–çš„ä»£ç åŒ…ã€‚ -u è®©å‘½ä»¤åˆ©ç”¨ç½‘ç»œæ¥æ›´æ–°å·²æœ‰ä»£ç åŒ…åŠå…¶ä¾èµ–åŒ…ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‘½ä»¤åªä¼šä»ç½‘ç»œä¸Šä¸‹è½½æœ¬åœ°ä¸å­˜åœ¨çš„ä»£ç åŒ…ï¼Œè€Œä¸ä¼šæ›´æ–°å·²æœ‰çš„ä»£ç åŒ…ã€‚ -v æ‰“å°å‡ºè¢«æ„å»ºçš„ä»£ç åŒ…çš„åå­— -x æ‰“å°å‡ºç”¨åˆ°çš„å‘½ä»¤ ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:4","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"go install go build å‘½ä»¤æ¯”è¾ƒç›¸ä¼¼ï¼Œgo build å‘½ä»¤ä¼šç¼–è¯‘åŒ…åŠå…¶ä¾èµ–ï¼Œç”Ÿæˆçš„æ–‡ä»¶å­˜æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ã€‚è€Œä¸” go build åªå¯¹ main åŒ…æœ‰æ•ˆï¼Œå…¶ä»–åŒ…ä¸èµ·ä½œç”¨ã€‚è€Œ go install å¯¹äºé main åŒ…ä¼šç”Ÿæˆé™æ€æ–‡ä»¶æ”¾åœ¨ $GOPATH/pkg ç›®å½•ä¸‹ï¼Œæ–‡ä»¶æ‰©å±•åä¸º aã€‚ å¦‚æœä¸º main åŒ…ï¼Œåˆ™ä¼šåœ¨ $GOPATH/bin ä¸‹ç”Ÿæˆä¸€ä¸ªå’Œç»™å®šåŒ…åç›¸åŒçš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚å…·ä½“è¯­æ³•å¦‚ä¸‹: go install [-i] [build flags] [packages] ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:9:5","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"æ‹“å±• ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:10:0","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"Go åˆå§‹åŒ–é¡ºåº init åˆå§‹åŒ–ï¼Œå˜é‡åˆå§‹åŒ– go åˆå§‹åŒ–é¡ºåº åŒ…ä½œç”¨åŸŸå˜é‡-\u003einit()-\u003emain() runtime éœ€è¦è§£æåŒ…ä¾èµ–å…³ç³»ï¼Œæ²¡æœ‰ä¾èµ–çš„åŒ…æœ€å…ˆåˆå§‹åŒ–ï¼Œæ²¡æœ‰ä¾èµ–çš„å˜é‡å…ˆåˆå§‹åŒ– ä¸€ä¸ªåŒ…å†…çš„init()æ ¹æ®æ–‡ä»¶åå­—å…¸åºåˆå§‹åŒ– ä¸åŒåŒ…æ ¹æ®ä¾èµ–å…³ç³»æ¥åŠ è½½åŒ…ï¼Œå…ˆåˆå§‹åŒ–åŒ…å˜é‡ï¼Œå†åˆå§‹åŒ–åŒ…å†…init() // a.go of pack package pack import ( \"fmt\" ) var _ = func() int { fmt.Println(\"init var in a.go of pack\") return 0 }() func init() { fmt.Println(\"init in a.go of pack\") } // pack.go of pack package pack import ( \"fmt\" \"test\" ) var Pack string = \"pack.Val\" var _ = func() int { fmt.Println(\"init var in pack.go of pack\") return 1 }() func init() { fmt.Println(\"init in pack.go of pack:\", test.Util) } // test.go of test import ( \"fmt\" ) var Util string = \"test.Val\" var _ = func() int { fmt.Println(\"init var in test.go of test\") return 1 }() func init() { fmt.Println(\"init test.go of test\") } // main.go package main import ( \"fmt\" \"pack\" \"test\" ) // main -\u003e pack -\u003e test // ç”±äº pack åŒ…çš„åˆå§‹åŒ–ä¾èµ– testï¼Œå› æ­¤è¿è¡Œæ—¶å…ˆåˆå§‹åŒ– test å†åˆå§‹åŒ– pack åŒ…ï¼› func main() { fmt.Println(pack.Pack) fmt.Println(test.Util) } ç»“æœï¼š init var in test.go of test # test var init test.go of test # test init() init var in a.go of pack # pack var1 init var in pack.go of pack # pack var2 init in a.go of pack # pack init() init in pack.go of pack: test.Val # pack init() pack.Val # main test.Val ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:10:1","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["go"],"content":"fmt å ä½ç¬¦ func main() { var n = 100 fmt.Printf(\"%T\\n\", n) // ç±»å‹ fmt.Printf(\"%v\\n\", n) // ç›¸åº”å€¼çš„é»˜è®¤æ ¼å¼ fmt.Printf(\"%b\\n\", n) // äºŒè¿›åˆ¶è¡¨ç¤º fmt.Printf(\"%d\\n\", n) // åè¿›åˆ¶è¡¨ç¤º fmt.Printf(\"%o\\n\", n) // å…«è¿›åˆ¶è¡¨ç¤º fmt.Printf(\"%x\\n\", n) // åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œå­—æ¯å½¢å¼ä¸ºå°å†™ a-f var s = \"Hello,ä½ å¥½ï¼\" fmt.Printf(\"%s\\n\", s) // è¾“å‡ºå­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆstringç±»å‹æˆ–[]byte) fmt.Printf(\"%v\\n\", s) // ç›¸åº”å€¼çš„é»˜è®¤æ ¼å¼ã€‚ fmt.Printf(\"%#v\\n\", s) // %#v è¾“å‡ºå­—ç¬¦ä¸²å…·ä½“æè¿°ï¼Œç›¸åº”å€¼çš„Goè¯­æ³•è¡¨ç¤º fmt.Printf(\"%#v\\n\", n) /* ä½†æ˜¯ï¼Œç´§è·Ÿåœ¨verbä¹‹å‰çš„[n]ç¬¦å·è¡¨ç¤ºåº”æ ¼å¼åŒ–ç¬¬nä¸ªå‚æ•°ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰ã€‚åŒæ ·çš„åœ¨'*'ä¹‹å‰çš„[n]ç¬¦å·è¡¨ç¤ºé‡‡ç”¨ç¬¬nä¸ªå‚æ•°çš„å€¼ä½œä¸ºå®½åº¦æˆ–ç²¾åº¦ã€‚åœ¨å¤„ç†å®Œæ–¹æ‹¬å·è¡¨è¾¾å¼[n]åï¼Œé™¤éå¦æœ‰æŒ‡ç¤ºï¼Œä¼šæ¥ç€å¤„ç†å‚æ•°n+1ï¼Œn+2â€¦â€¦ï¼ˆå°±æ˜¯è¯´ç§»åŠ¨äº†å½“å‰å¤„ç†ä½ç½®ï¼‰ */ fmt.Printf(\"%[2]d %[1]d\", 11, 2) fmt.Printf(\"%[3]*.[2]*[1]d\", 12, 2, 6) fmt.Printf(\"%6.2d\", 12) } ","date":"2022-11-20","objectID":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/:10:2","tags":["go"],"title":"Goæ·±å…¥å­¦ä¹ ","uri":"/posts/go%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0/"},{"categories":["æ–‡ç« "],"content":"æ–‡ç«  è¿™æ˜¯ç¬¬ä¸€ç«  ","date":"2022-11-20","objectID":"/posts/second_post/:0:0","tags":["post"],"title":"Second_post","uri":"/posts/second_post/"},{"categories":["æ–‡ç« "],"content":"æµ‹è¯• è¿™æ˜¯ç¬¬äºŒå¼  package main import \"fmt\" func main(){ fmt.Println(\"hello world\") } ","date":"2022-11-20","objectID":"/posts/second_post/:1:0","tags":["post"],"title":"Second_post","uri":"/posts/second_post/"},{"categories":null,"content":"this is first post ","date":"2022-11-19","objectID":"/posts/first_post/:0:0","tags":null,"title":"First_post","uri":"/posts/first_post/"}]